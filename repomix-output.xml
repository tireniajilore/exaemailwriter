This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
public/
  favicon.ico
  placeholder.svg
  robots.txt
src/
  components/
    prolific/
      ProlificLayout.tsx
    ui/
      accordion.tsx
      alert-dialog.tsx
      alert.tsx
      aspect-ratio.tsx
      avatar.tsx
      badge.tsx
      breadcrumb.tsx
      button.tsx
      calendar.tsx
      card.tsx
      carousel.tsx
      chart.tsx
      checkbox.tsx
      collapsible.tsx
      command.tsx
      context-menu.tsx
      dialog.tsx
      drawer.tsx
      dropdown-menu.tsx
      form.tsx
      hover-card.tsx
      input-otp.tsx
      input.tsx
      label.tsx
      menubar.tsx
      navigation-menu.tsx
      pagination.tsx
      popover.tsx
      progress.tsx
      radio-group.tsx
      resizable.tsx
      scroll-area.tsx
      select.tsx
      separator.tsx
      sheet.tsx
      sidebar.tsx
      skeleton.tsx
      slider.tsx
      sonner.tsx
      switch.tsx
      table.tsx
      tabs.tsx
      textarea.tsx
      toast.tsx
      toaster.tsx
      toggle-group.tsx
      toggle.tsx
      tooltip.tsx
      use-toast.ts
    EmailResult.tsx
    GenerationProgress.tsx
    HookPicker.tsx
    NavLink.tsx
    ResearchEmailForm.tsx
    StageIndicator.tsx
    TipsCarousel.tsx
  contexts/
    ProlificContext.tsx
  hooks/
    use-mobile.tsx
    use-toast.ts
    useEmailGenerationProgress.ts
  integrations/
    supabase/
      client.ts
      types.ts
  lib/
    prompt.ts
    utils.ts
  pages/
    prolific/
      ProlificApp.tsx
      ProlificComplete.tsx
      ProlificRead.tsx
      ProlificSetup.tsx
      ProlificSurvey.tsx
      ProlificWelcome.tsx
    Index.tsx
    NotFound.tsx
    TestHarness.tsx
  App.tsx
  index.css
  main.tsx
  testCases.ts
  vite-env.d.ts
supabase/
  functions/
    create-prolific-session/
      index.ts
    generate-email/
      index.ts
    log-email-generation/
      index.ts
    research/
      index.ts
    research-run/
      index.ts
    research-status/
      index.ts
    shared/
      exa-search.ts
    submit-prolific-survey/
      index.ts
  migrations/
    20251226181716_remix_migration_from_pg_dump.sql
    20251226183021_93830f70-1bfe-4da2-9005-67fab8ab0f2b.sql
    20251228_add_email_generations_columns.sql
    20251229_add_credibility_story.sql
    20251229_create_research_jobs.sql
  config.toml
.gitignore
components.json
eslint.config.js
index.html
package.json
postcss.config.js
README.md
tailwind.config.ts
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="public/placeholder.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1200" fill="none"><rect width="1200" height="1200" fill="#EAEAEA" rx="3"/><g opacity=".5"><g opacity=".5"><path fill="#FAFAFA" d="M600.709 736.5c-75.454 0-136.621-61.167-136.621-136.62 0-75.454 61.167-136.621 136.621-136.621 75.453 0 136.62 61.167 136.62 136.621 0 75.453-61.167 136.62-136.62 136.62Z"/><path stroke="#C9C9C9" stroke-width="2.418" d="M600.709 736.5c-75.454 0-136.621-61.167-136.621-136.62 0-75.454 61.167-136.621 136.621-136.621 75.453 0 136.62 61.167 136.62 136.621 0 75.453-61.167 136.62-136.62 136.62Z"/></g><path stroke="url(#a)" stroke-width="2.418" d="M0-1.209h553.581" transform="scale(1 -1) rotate(45 1163.11 91.165)"/><path stroke="url(#b)" stroke-width="2.418" d="M404.846 598.671h391.726"/><path stroke="url(#c)" stroke-width="2.418" d="M599.5 795.742V404.017"/><path stroke="url(#d)" stroke-width="2.418" d="m795.717 796.597-391.441-391.44"/><path fill="#fff" d="M600.709 656.704c-31.384 0-56.825-25.441-56.825-56.824 0-31.384 25.441-56.825 56.825-56.825 31.383 0 56.824 25.441 56.824 56.825 0 31.383-25.441 56.824-56.824 56.824Z"/><g clip-path="url(#e)"><path fill="#666" fill-rule="evenodd" d="M616.426 586.58h-31.434v16.176l3.553-3.554.531-.531h9.068l.074-.074 8.463-8.463h2.565l7.18 7.181V586.58Zm-15.715 14.654 3.698 3.699 1.283 1.282-2.565 2.565-1.282-1.283-5.2-5.199h-6.066l-5.514 5.514-.073.073v2.876a2.418 2.418 0 0 0 2.418 2.418h26.598a2.418 2.418 0 0 0 2.418-2.418v-8.317l-8.463-8.463-7.181 7.181-.071.072Zm-19.347 5.442v4.085a6.045 6.045 0 0 0 6.046 6.045h26.598a6.044 6.044 0 0 0 6.045-6.045v-7.108l1.356-1.355-1.282-1.283-.074-.073v-17.989h-38.689v23.43l-.146.146.146.147Z" clip-rule="evenodd"/></g><path stroke="#C9C9C9" stroke-width="2.418" d="M600.709 656.704c-31.384 0-56.825-25.441-56.825-56.824 0-31.384 25.441-56.825 56.825-56.825 31.383 0 56.824 25.441 56.824 56.825 0 31.383-25.441 56.824-56.824 56.824Z"/></g><defs><linearGradient id="a" x1="554.061" x2="-.48" y1=".083" y2=".087" gradientUnits="userSpaceOnUse"><stop stop-color="#C9C9C9" stop-opacity="0"/><stop offset=".208" stop-color="#C9C9C9"/><stop offset=".792" stop-color="#C9C9C9"/><stop offset="1" stop-color="#C9C9C9" stop-opacity="0"/></linearGradient><linearGradient id="b" x1="796.912" x2="404.507" y1="599.963" y2="599.965" gradientUnits="userSpaceOnUse"><stop stop-color="#C9C9C9" stop-opacity="0"/><stop offset=".208" stop-color="#C9C9C9"/><stop offset=".792" stop-color="#C9C9C9"/><stop offset="1" stop-color="#C9C9C9" stop-opacity="0"/></linearGradient><linearGradient id="c" x1="600.792" x2="600.794" y1="403.677" y2="796.082" gradientUnits="userSpaceOnUse"><stop stop-color="#C9C9C9" stop-opacity="0"/><stop offset=".208" stop-color="#C9C9C9"/><stop offset=".792" stop-color="#C9C9C9"/><stop offset="1" stop-color="#C9C9C9" stop-opacity="0"/></linearGradient><linearGradient id="d" x1="404.85" x2="796.972" y1="403.903" y2="796.02" gradientUnits="userSpaceOnUse"><stop stop-color="#C9C9C9" stop-opacity="0"/><stop offset=".208" stop-color="#C9C9C9"/><stop offset=".792" stop-color="#C9C9C9"/><stop offset="1" stop-color="#C9C9C9" stop-opacity="0"/></linearGradient><clipPath id="e"><path fill="#fff" d="M581.364 580.535h38.689v38.689h-38.689z"/></clipPath></defs></svg>
</file>

<file path="public/robots.txt">
User-agent: Googlebot
Allow: /

User-agent: Bingbot
Allow: /

User-agent: Twitterbot
Allow: /

User-agent: facebookexternalhit
Allow: /

User-agent: *
Allow: /
</file>

<file path="src/components/prolific/ProlificLayout.tsx">
import { ReactNode } from 'react';
import { PROLIFIC_STEPS, useProlific } from '@/contexts/ProlificContext';
import { Check } from 'lucide-react';

interface ProlificLayoutProps {
  children: ReactNode;
}

export function ProlificLayout({ children }: ProlificLayoutProps) {
  const { currentStep } = useProlific();

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="border-b border-border bg-card">
        <div className="max-w-3xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Research Study</span>
            <span className="text-sm text-muted-foreground">
              Step {currentStep + 1} of {PROLIFIC_STEPS.length}
            </span>
          </div>
        </div>
      </header>

      {/* Progress Bar */}
      <div className="border-b border-border bg-card">
        <div className="max-w-3xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            {PROLIFIC_STEPS.map((step, index) => (
              <div key={step.path} className="flex items-center">
                <div className="flex flex-col items-center">
                  <div
                    className={`
                      w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium
                      transition-colors duration-200
                      ${index < currentStep
                        ? 'bg-primary text-primary-foreground'
                        : index === currentStep
                          ? 'bg-primary text-primary-foreground ring-2 ring-primary ring-offset-2 ring-offset-background'
                          : 'bg-muted text-muted-foreground'
                      }
                    `}
                  >
                    {index < currentStep ? (
                      <Check className="w-4 h-4" />
                    ) : (
                      index + 1
                    )}
                  </div>
                  <span
                    className={`
                      mt-1.5 text-xs hidden sm:block
                      ${index <= currentStep ? 'text-foreground' : 'text-muted-foreground'}
                    `}
                  >
                    {step.label}
                  </span>
                </div>
                {index < PROLIFIC_STEPS.length - 1 && (
                  <div
                    className={`
                      w-8 sm:w-12 lg:w-16 h-0.5 mx-1 sm:mx-2
                      ${index < currentStep ? 'bg-primary' : 'bg-muted'}
                    `}
                  />
                )}
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Content */}
      <main className="max-w-3xl mx-auto px-6 py-10">
        {children}
      </main>

      {/* Footer */}
      <footer className="border-t border-border mt-auto">
        <div className="max-w-3xl mx-auto px-6 py-4">
          <p className="text-xs text-muted-foreground text-center">
            Your responses are confidential and will only be used for research purposes.
          </p>
        </div>
      </footer>
    </div>
  );
}
</file>

<file path="src/components/ui/accordion.tsx">
import * as React from "react";
import * as AccordionPrimitive from "@radix-ui/react-accordion";
import { ChevronDown } from "lucide-react";

import { cn } from "@/lib/utils";

const Accordion = AccordionPrimitive.Root;

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item ref={ref} className={cn("border-b", className)} {...props} />
));
AccordionItem.displayName = "AccordionItem";

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
));
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName;

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
));

AccordionContent.displayName = AccordionPrimitive.Content.displayName;

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent };
</file>

<file path="src/components/ui/alert-dialog.tsx">
import * as React from "react";
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog";

import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";

const AlertDialog = AlertDialogPrimitive.Root;

const AlertDialogTrigger = AlertDialogPrimitive.Trigger;

const AlertDialogPortal = AlertDialogPrimitive.Portal;

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className,
    )}
    {...props}
    ref={ref}
  />
));
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName;

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className,
      )}
      {...props}
    />
  </AlertDialogPortal>
));
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName;

const AlertDialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col space-y-2 text-center sm:text-left", className)} {...props} />
);
AlertDialogHeader.displayName = "AlertDialogHeader";

const AlertDialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)} {...props} />
);
AlertDialogFooter.displayName = "AlertDialogFooter";

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title ref={ref} className={cn("text-lg font-semibold", className)} {...props} />
));
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName;

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
));
AlertDialogDescription.displayName = AlertDialogPrimitive.Description.displayName;

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action ref={ref} className={cn(buttonVariants(), className)} {...props} />
));
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName;

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(buttonVariants({ variant: "outline" }), "mt-2 sm:mt-0", className)}
    {...props}
  />
));
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName;

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
};
</file>

<file path="src/components/ui/alert.tsx">
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive: "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div ref={ref} role="alert" className={cn(alertVariants({ variant }), className)} {...props} />
));
Alert.displayName = "Alert";

const AlertTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
  ({ className, ...props }, ref) => (
    <h5 ref={ref} className={cn("mb-1 font-medium leading-none tracking-tight", className)} {...props} />
  ),
);
AlertTitle.displayName = "AlertTitle";

const AlertDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("text-sm [&_p]:leading-relaxed", className)} {...props} />
  ),
);
AlertDescription.displayName = "AlertDescription";

export { Alert, AlertTitle, AlertDescription };
</file>

<file path="src/components/ui/aspect-ratio.tsx">
import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio";

const AspectRatio = AspectRatioPrimitive.Root;

export { AspectRatio };
</file>

<file path="src/components/ui/avatar.tsx">
import * as React from "react";
import * as AvatarPrimitive from "@radix-ui/react-avatar";

import { cn } from "@/lib/utils";

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full", className)}
    {...props}
  />
));
Avatar.displayName = AvatarPrimitive.Root.displayName;

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image ref={ref} className={cn("aspect-square h-full w-full", className)} {...props} />
));
AvatarImage.displayName = AvatarPrimitive.Image.displayName;

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn("flex h-full w-full items-center justify-center rounded-full bg-muted", className)}
    {...props}
  />
));
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName;

export { Avatar, AvatarImage, AvatarFallback };
</file>

<file path="src/components/ui/badge.tsx">
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default: "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary: "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive: "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

export interface BadgeProps extends React.HTMLAttributes<HTMLDivElement>, VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return <div className={cn(badgeVariants({ variant }), className)} {...props} />;
}

export { Badge, badgeVariants };
</file>

<file path="src/components/ui/breadcrumb.tsx">
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { ChevronRight, MoreHorizontal } from "lucide-react";

import { cn } from "@/lib/utils";

const Breadcrumb = React.forwardRef<
  HTMLElement,
  React.ComponentPropsWithoutRef<"nav"> & {
    separator?: React.ReactNode;
  }
>(({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />);
Breadcrumb.displayName = "Breadcrumb";

const BreadcrumbList = React.forwardRef<HTMLOListElement, React.ComponentPropsWithoutRef<"ol">>(
  ({ className, ...props }, ref) => (
    <ol
      ref={ref}
      className={cn(
        "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
        className,
      )}
      {...props}
    />
  ),
);
BreadcrumbList.displayName = "BreadcrumbList";

const BreadcrumbItem = React.forwardRef<HTMLLIElement, React.ComponentPropsWithoutRef<"li">>(
  ({ className, ...props }, ref) => (
    <li ref={ref} className={cn("inline-flex items-center gap-1.5", className)} {...props} />
  ),
);
BreadcrumbItem.displayName = "BreadcrumbItem";

const BreadcrumbLink = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentPropsWithoutRef<"a"> & {
    asChild?: boolean;
  }
>(({ asChild, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a";

  return <Comp ref={ref} className={cn("transition-colors hover:text-foreground", className)} {...props} />;
});
BreadcrumbLink.displayName = "BreadcrumbLink";

const BreadcrumbPage = React.forwardRef<HTMLSpanElement, React.ComponentPropsWithoutRef<"span">>(
  ({ className, ...props }, ref) => (
    <span
      ref={ref}
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn("font-normal text-foreground", className)}
      {...props}
    />
  ),
);
BreadcrumbPage.displayName = "BreadcrumbPage";

const BreadcrumbSeparator = ({ children, className, ...props }: React.ComponentProps<"li">) => (
  <li role="presentation" aria-hidden="true" className={cn("[&>svg]:size-3.5", className)} {...props}>
    {children ?? <ChevronRight />}
  </li>
);
BreadcrumbSeparator.displayName = "BreadcrumbSeparator";

const BreadcrumbEllipsis = ({ className, ...props }: React.ComponentProps<"span">) => (
  <span
    role="presentation"
    aria-hidden="true"
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More</span>
  </span>
);
BreadcrumbEllipsis.displayName = "BreadcrumbElipssis";

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
};
</file>

<file path="src/components/ui/button.tsx">
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button";
    return <Comp className={cn(buttonVariants({ variant, size, className }))} ref={ref} {...props} />;
  },
);
Button.displayName = "Button";

export { Button, buttonVariants };
</file>

<file path="src/components/ui/calendar.tsx">
import * as React from "react";
import { ChevronLeft, ChevronRight } from "lucide-react";
import { DayPicker } from "react-day-picker";

import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";

export type CalendarProps = React.ComponentProps<typeof DayPicker>;

function Calendar({ className, classNames, showOutsideDays = true, ...props }: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100",
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell: "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(buttonVariants({ variant: "ghost" }), "h-9 w-9 p-0 font-normal aria-selected:opacity-100"),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle: "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ ..._props }) => <ChevronLeft className="h-4 w-4" />,
        IconRight: ({ ..._props }) => <ChevronRight className="h-4 w-4" />,
      }}
      {...props}
    />
  );
}
Calendar.displayName = "Calendar";

export { Calendar };
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react";

import { cn } from "@/lib/utils";

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("rounded-lg border bg-card text-card-foreground shadow-sm", className)} {...props} />
));
Card.displayName = "Card";

const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
  ),
);
CardHeader.displayName = "CardHeader";

const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
  ({ className, ...props }, ref) => (
    <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
  ),
);
CardTitle.displayName = "CardTitle";

const CardDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(
  ({ className, ...props }, ref) => (
    <p ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
  ),
);
CardDescription.displayName = "CardDescription";

const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />,
);
CardContent.displayName = "CardContent";

const CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex items-center p-6 pt-0", className)} {...props} />
  ),
);
CardFooter.displayName = "CardFooter";

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };
</file>

<file path="src/components/ui/carousel.tsx">
import * as React from "react";
import useEmblaCarousel, { type UseEmblaCarouselType } from "embla-carousel-react";
import { ArrowLeft, ArrowRight } from "lucide-react";

import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";

type CarouselApi = UseEmblaCarouselType[1];
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>;
type CarouselOptions = UseCarouselParameters[0];
type CarouselPlugin = UseCarouselParameters[1];

type CarouselProps = {
  opts?: CarouselOptions;
  plugins?: CarouselPlugin;
  orientation?: "horizontal" | "vertical";
  setApi?: (api: CarouselApi) => void;
};

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0];
  api: ReturnType<typeof useEmblaCarousel>[1];
  scrollPrev: () => void;
  scrollNext: () => void;
  canScrollPrev: boolean;
  canScrollNext: boolean;
} & CarouselProps;

const CarouselContext = React.createContext<CarouselContextProps | null>(null);

function useCarousel() {
  const context = React.useContext(CarouselContext);

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />");
  }

  return context;
}

const Carousel = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement> & CarouselProps>(
  ({ orientation = "horizontal", opts, setApi, plugins, className, children, ...props }, ref) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins,
    );
    const [canScrollPrev, setCanScrollPrev] = React.useState(false);
    const [canScrollNext, setCanScrollNext] = React.useState(false);

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return;
      }

      setCanScrollPrev(api.canScrollPrev());
      setCanScrollNext(api.canScrollNext());
    }, []);

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev();
    }, [api]);

    const scrollNext = React.useCallback(() => {
      api?.scrollNext();
    }, [api]);

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault();
          scrollPrev();
        } else if (event.key === "ArrowRight") {
          event.preventDefault();
          scrollNext();
        }
      },
      [scrollPrev, scrollNext],
    );

    React.useEffect(() => {
      if (!api || !setApi) {
        return;
      }

      setApi(api);
    }, [api, setApi]);

    React.useEffect(() => {
      if (!api) {
        return;
      }

      onSelect(api);
      api.on("reInit", onSelect);
      api.on("select", onSelect);

      return () => {
        api?.off("select", onSelect);
      };
    }, [api, onSelect]);

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation: orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    );
  },
);
Carousel.displayName = "Carousel";

const CarouselContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => {
    const { carouselRef, orientation } = useCarousel();

    return (
      <div ref={carouselRef} className="overflow-hidden">
        <div
          ref={ref}
          className={cn("flex", orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col", className)}
          {...props}
        />
      </div>
    );
  },
);
CarouselContent.displayName = "CarouselContent";

const CarouselItem = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => {
    const { orientation } = useCarousel();

    return (
      <div
        ref={ref}
        role="group"
        aria-roledescription="slide"
        className={cn("min-w-0 shrink-0 grow-0 basis-full", orientation === "horizontal" ? "pl-4" : "pt-4", className)}
        {...props}
      />
    );
  },
);
CarouselItem.displayName = "CarouselItem";

const CarouselPrevious = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(
  ({ className, variant = "outline", size = "icon", ...props }, ref) => {
    const { orientation, scrollPrev, canScrollPrev } = useCarousel();

    return (
      <Button
        ref={ref}
        variant={variant}
        size={size}
        className={cn(
          "absolute h-8 w-8 rounded-full",
          orientation === "horizontal"
            ? "-left-12 top-1/2 -translate-y-1/2"
            : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
          className,
        )}
        disabled={!canScrollPrev}
        onClick={scrollPrev}
        {...props}
      >
        <ArrowLeft className="h-4 w-4" />
        <span className="sr-only">Previous slide</span>
      </Button>
    );
  },
);
CarouselPrevious.displayName = "CarouselPrevious";

const CarouselNext = React.forwardRef<HTMLButtonElement, React.ComponentProps<typeof Button>>(
  ({ className, variant = "outline", size = "icon", ...props }, ref) => {
    const { orientation, scrollNext, canScrollNext } = useCarousel();

    return (
      <Button
        ref={ref}
        variant={variant}
        size={size}
        className={cn(
          "absolute h-8 w-8 rounded-full",
          orientation === "horizontal"
            ? "-right-12 top-1/2 -translate-y-1/2"
            : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
          className,
        )}
        disabled={!canScrollNext}
        onClick={scrollNext}
        {...props}
      >
        <ArrowRight className="h-4 w-4" />
        <span className="sr-only">Next slide</span>
      </Button>
    );
  },
);
CarouselNext.displayName = "CarouselNext";

export { type CarouselApi, Carousel, CarouselContent, CarouselItem, CarouselPrevious, CarouselNext };
</file>

<file path="src/components/ui/chart.tsx">
import * as React from "react";
import * as RechartsPrimitive from "recharts";

import { cn } from "@/lib/utils";

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const;

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode;
    icon?: React.ComponentType;
  } & ({ color?: string; theme?: never } | { color?: never; theme: Record<keyof typeof THEMES, string> });
};

type ChartContextProps = {
  config: ChartConfig;
};

const ChartContext = React.createContext<ChartContextProps | null>(null);

function useChart() {
  const context = React.useContext(ChartContext);

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />");
  }

  return context;
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig;
    children: React.ComponentProps<typeof RechartsPrimitive.ResponsiveContainer>["children"];
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId();
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`;

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className,
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>{children}</RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  );
});
ChartContainer.displayName = "Chart";

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(([_, config]) => config.theme || config.color);

  if (!colorConfig.length) {
    return null;
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color = itemConfig.theme?.[theme as keyof typeof itemConfig.theme] || itemConfig.color;
    return color ? `  --color-${key}: ${color};` : null;
  })
  .join("\n")}
}
`,
          )
          .join("\n"),
      }}
    />
  );
};

const ChartTooltip = RechartsPrimitive.Tooltip;

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean;
      hideIndicator?: boolean;
      indicator?: "line" | "dot" | "dashed";
      nameKey?: string;
      labelKey?: string;
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref,
  ) => {
    const { config } = useChart();

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null;
      }

      const [item] = payload;
      const key = `${labelKey || item.dataKey || item.name || "value"}`;
      const itemConfig = getPayloadConfigFromPayload(config, item, key);
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label;

      if (labelFormatter) {
        return <div className={cn("font-medium", labelClassName)}>{labelFormatter(value, payload)}</div>;
      }

      if (!value) {
        return null;
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>;
    }, [label, labelFormatter, payload, hideLabel, labelClassName, config, labelKey]);

    if (!active || !payload?.length) {
      return null;
    }

    const nestLabel = payload.length === 1 && indicator !== "dot";

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className,
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`;
            const itemConfig = getPayloadConfigFromPayload(config, item, key);
            const indicatorColor = color || item.payload.fill || item.color;

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center",
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn("shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]", {
                            "h-2.5 w-2.5": indicator === "dot",
                            "w-1": indicator === "line",
                            "w-0 border-[1.5px] border-dashed bg-transparent": indicator === "dashed",
                            "my-0.5": nestLabel && indicator === "dashed",
                          })}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center",
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">{itemConfig?.label || item.name}</span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            );
          })}
        </div>
      </div>
    );
  },
);
ChartTooltipContent.displayName = "ChartTooltip";

const ChartLegend = RechartsPrimitive.Legend;

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean;
      nameKey?: string;
    }
>(({ className, hideIcon = false, payload, verticalAlign = "bottom", nameKey }, ref) => {
  const { config } = useChart();

  if (!payload?.length) {
    return null;
  }

  return (
    <div
      ref={ref}
      className={cn("flex items-center justify-center gap-4", verticalAlign === "top" ? "pb-3" : "pt-3", className)}
    >
      {payload.map((item) => {
        const key = `${nameKey || item.dataKey || "value"}`;
        const itemConfig = getPayloadConfigFromPayload(config, item, key);

        return (
          <div
            key={item.value}
            className={cn("flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground")}
          >
            {itemConfig?.icon && !hideIcon ? (
              <itemConfig.icon />
            ) : (
              <div
                className="h-2 w-2 shrink-0 rounded-[2px]"
                style={{
                  backgroundColor: item.color,
                }}
              />
            )}
            {itemConfig?.label}
          </div>
        );
      })}
    </div>
  );
});
ChartLegendContent.displayName = "ChartLegend";

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(config: ChartConfig, payload: unknown, key: string) {
  if (typeof payload !== "object" || payload === null) {
    return undefined;
  }

  const payloadPayload =
    "payload" in payload && typeof payload.payload === "object" && payload.payload !== null
      ? payload.payload
      : undefined;

  let configLabelKey: string = key;

  if (key in payload && typeof payload[key as keyof typeof payload] === "string") {
    configLabelKey = payload[key as keyof typeof payload] as string;
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[key as keyof typeof payloadPayload] as string;
  }

  return configLabelKey in config ? config[configLabelKey] : config[key as keyof typeof config];
}

export { ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent, ChartStyle };
</file>

<file path="src/components/ui/checkbox.tsx">
import * as React from "react";
import * as CheckboxPrimitive from "@radix-ui/react-checkbox";
import { Check } from "lucide-react";

import { cn } from "@/lib/utils";

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
      className,
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator className={cn("flex items-center justify-center text-current")}>
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
));
Checkbox.displayName = CheckboxPrimitive.Root.displayName;

export { Checkbox };
</file>

<file path="src/components/ui/collapsible.tsx">
import * as CollapsiblePrimitive from "@radix-ui/react-collapsible";

const Collapsible = CollapsiblePrimitive.Root;

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger;

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent;

export { Collapsible, CollapsibleTrigger, CollapsibleContent };
</file>

<file path="src/components/ui/command.tsx">
import * as React from "react";
import { type DialogProps } from "@radix-ui/react-dialog";
import { Command as CommandPrimitive } from "cmdk";
import { Search } from "lucide-react";

import { cn } from "@/lib/utils";
import { Dialog, DialogContent } from "@/components/ui/dialog";

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className,
    )}
    {...props}
  />
));
Command.displayName = CommandPrimitive.displayName;

interface CommandDialogProps extends DialogProps {}

const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  );
};

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    />
  </div>
));

CommandInput.displayName = CommandPrimitive.Input.displayName;

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
));

CommandList.displayName = CommandPrimitive.List.displayName;

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => <CommandPrimitive.Empty ref={ref} className="py-6 text-center text-sm" {...props} />);

CommandEmpty.displayName = CommandPrimitive.Empty.displayName;

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className,
    )}
    {...props}
  />
));

CommandGroup.displayName = CommandPrimitive.Group.displayName;

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator ref={ref} className={cn("-mx-1 h-px bg-border", className)} {...props} />
));
CommandSeparator.displayName = CommandPrimitive.Separator.displayName;

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",
      className,
    )}
    {...props}
  />
));

CommandItem.displayName = CommandPrimitive.Item.displayName;

const CommandShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)} {...props} />;
};
CommandShortcut.displayName = "CommandShortcut";

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
};
</file>

<file path="src/components/ui/context-menu.tsx">
import * as React from "react";
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const ContextMenu = ContextMenuPrimitive.Root;

const ContextMenuTrigger = ContextMenuPrimitive.Trigger;

const ContextMenuGroup = ContextMenuPrimitive.Group;

const ContextMenuPortal = ContextMenuPrimitive.Portal;

const ContextMenuSub = ContextMenuPrimitive.Sub;

const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup;

const ContextMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <ContextMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent data-[state=open]:text-accent-foreground focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </ContextMenuPrimitive.SubTrigger>
));
ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName;

const ContextMenuSubContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName;

const ContextMenuContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Portal>
    <ContextMenuPrimitive.Content
      ref={ref}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className,
      )}
      {...props}
    />
  </ContextMenuPrimitive.Portal>
));
ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName;

const ContextMenuItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName;

const ContextMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <ContextMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.CheckboxItem>
));
ContextMenuCheckboxItem.displayName = ContextMenuPrimitive.CheckboxItem.displayName;

const ContextMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <ContextMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.RadioItem>
));
ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName;

const ContextMenuLabel = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold text-foreground", inset && "pl-8", className)}
    {...props}
  />
));
ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName;

const ContextMenuSeparator = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Separator ref={ref} className={cn("-mx-1 my-1 h-px bg-border", className)} {...props} />
));
ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName;

const ContextMenuShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)} {...props} />;
};
ContextMenuShortcut.displayName = "ContextMenuShortcut";

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
};
</file>

<file path="src/components/ui/dialog.tsx">
import * as React from "react";
import * as DialogPrimitive from "@radix-ui/react-dialog";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";

const Dialog = DialogPrimitive.Root;

const DialogTrigger = DialogPrimitive.Trigger;

const DialogPortal = DialogPrimitive.Portal;

const DialogClose = DialogPrimitive.Close;

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className,
    )}
    {...props}
  />
));
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName;

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className,
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-accent data-[state=open]:text-muted-foreground hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
));
DialogContent.displayName = DialogPrimitive.Content.displayName;

const DialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col space-y-1.5 text-center sm:text-left", className)} {...props} />
);
DialogHeader.displayName = "DialogHeader";

const DialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)} {...props} />
);
DialogFooter.displayName = "DialogFooter";

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold leading-none tracking-tight", className)}
    {...props}
  />
));
DialogTitle.displayName = DialogPrimitive.Title.displayName;

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
));
DialogDescription.displayName = DialogPrimitive.Description.displayName;

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
};
</file>

<file path="src/components/ui/drawer.tsx">
import * as React from "react";
import { Drawer as DrawerPrimitive } from "vaul";

import { cn } from "@/lib/utils";

const Drawer = ({ shouldScaleBackground = true, ...props }: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
  <DrawerPrimitive.Root shouldScaleBackground={shouldScaleBackground} {...props} />
);
Drawer.displayName = "Drawer";

const DrawerTrigger = DrawerPrimitive.Trigger;

const DrawerPortal = DrawerPrimitive.Portal;

const DrawerClose = DrawerPrimitive.Close;

const DrawerOverlay = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Overlay ref={ref} className={cn("fixed inset-0 z-50 bg-black/80", className)} {...props} />
));
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName;

const DrawerContent = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DrawerPortal>
    <DrawerOverlay />
    <DrawerPrimitive.Content
      ref={ref}
      className={cn(
        "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
        className,
      )}
      {...props}
    >
      <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
      {children}
    </DrawerPrimitive.Content>
  </DrawerPortal>
));
DrawerContent.displayName = "DrawerContent";

const DrawerHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)} {...props} />
);
DrawerHeader.displayName = "DrawerHeader";

const DrawerFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("mt-auto flex flex-col gap-2 p-4", className)} {...props} />
);
DrawerFooter.displayName = "DrawerFooter";

const DrawerTitle = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold leading-none tracking-tight", className)}
    {...props}
  />
));
DrawerTitle.displayName = DrawerPrimitive.Title.displayName;

const DrawerDescription = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Description ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
));
DrawerDescription.displayName = DrawerPrimitive.Description.displayName;

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
};
</file>

<file path="src/components/ui/dropdown-menu.tsx">
import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const DropdownMenu = DropdownMenuPrimitive.Root;

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;

const DropdownMenuGroup = DropdownMenuPrimitive.Group;

const DropdownMenuPortal = DropdownMenuPrimitive.Portal;

const DropdownMenuSub = DropdownMenuPrimitive.Sub;

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent focus:bg-accent",
      inset && "pl-8",
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName = DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
DropdownMenuSubContent.displayName = DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className,
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName = DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", inset && "pl-8", className)}
    {...props}
  />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator ref={ref} className={cn("-mx-1 my-1 h-px bg-muted", className)} {...props} />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest opacity-60", className)} {...props} />;
};
DropdownMenuShortcut.displayName = "DropdownMenuShortcut";

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
};
</file>

<file path="src/components/ui/form.tsx">
import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { Slot } from "@radix-ui/react-slot";
import { Controller, ControllerProps, FieldPath, FieldValues, FormProvider, useFormContext } from "react-hook-form";

import { cn } from "@/lib/utils";
import { Label } from "@/components/ui/label";

const Form = FormProvider;

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName;
};

const FormFieldContext = React.createContext<FormFieldContextValue>({} as FormFieldContextValue);

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  );
};

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext);
  const itemContext = React.useContext(FormItemContext);
  const { getFieldState, formState } = useFormContext();

  const fieldState = getFieldState(fieldContext.name, formState);

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>");
  }

  const { id } = itemContext;

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  };
};

type FormItemContextValue = {
  id: string;
};

const FormItemContext = React.createContext<FormItemContextValue>({} as FormItemContextValue);

const FormItem = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => {
    const id = React.useId();

    return (
      <FormItemContext.Provider value={{ id }}>
        <div ref={ref} className={cn("space-y-2", className)} {...props} />
      </FormItemContext.Provider>
    );
  },
);
FormItem.displayName = "FormItem";

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField();

  return <Label ref={ref} className={cn(error && "text-destructive", className)} htmlFor={formItemId} {...props} />;
});
FormLabel.displayName = "FormLabel";

const FormControl = React.forwardRef<React.ElementRef<typeof Slot>, React.ComponentPropsWithoutRef<typeof Slot>>(
  ({ ...props }, ref) => {
    const { error, formItemId, formDescriptionId, formMessageId } = useFormField();

    return (
      <Slot
        ref={ref}
        id={formItemId}
        aria-describedby={!error ? `${formDescriptionId}` : `${formDescriptionId} ${formMessageId}`}
        aria-invalid={!!error}
        {...props}
      />
    );
  },
);
FormControl.displayName = "FormControl";

const FormDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(
  ({ className, ...props }, ref) => {
    const { formDescriptionId } = useFormField();

    return <p ref={ref} id={formDescriptionId} className={cn("text-sm text-muted-foreground", className)} {...props} />;
  },
);
FormDescription.displayName = "FormDescription";

const FormMessage = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(
  ({ className, children, ...props }, ref) => {
    const { error, formMessageId } = useFormField();
    const body = error ? String(error?.message) : children;

    if (!body) {
      return null;
    }

    return (
      <p ref={ref} id={formMessageId} className={cn("text-sm font-medium text-destructive", className)} {...props}>
        {body}
      </p>
    );
  },
);
FormMessage.displayName = "FormMessage";

export { useFormField, Form, FormItem, FormLabel, FormControl, FormDescription, FormMessage, FormField };
</file>

<file path="src/components/ui/hover-card.tsx">
import * as React from "react";
import * as HoverCardPrimitive from "@radix-ui/react-hover-card";

import { cn } from "@/lib/utils";

const HoverCard = HoverCardPrimitive.Root;

const HoverCardTrigger = HoverCardPrimitive.Trigger;

const HoverCardContent = React.forwardRef<
  React.ElementRef<typeof HoverCardPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <HoverCardPrimitive.Content
    ref={ref}
    align={align}
    sideOffset={sideOffset}
    className={cn(
      "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
HoverCardContent.displayName = HoverCardPrimitive.Content.displayName;

export { HoverCard, HoverCardTrigger, HoverCardContent };
</file>

<file path="src/components/ui/input-otp.tsx">
import * as React from "react";
import { OTPInput, OTPInputContext } from "input-otp";
import { Dot } from "lucide-react";

import { cn } from "@/lib/utils";

const InputOTP = React.forwardRef<React.ElementRef<typeof OTPInput>, React.ComponentPropsWithoutRef<typeof OTPInput>>(
  ({ className, containerClassName, ...props }, ref) => (
    <OTPInput
      ref={ref}
      containerClassName={cn("flex items-center gap-2 has-[:disabled]:opacity-50", containerClassName)}
      className={cn("disabled:cursor-not-allowed", className)}
      {...props}
    />
  ),
);
InputOTP.displayName = "InputOTP";

const InputOTPGroup = React.forwardRef<React.ElementRef<"div">, React.ComponentPropsWithoutRef<"div">>(
  ({ className, ...props }, ref) => <div ref={ref} className={cn("flex items-center", className)} {...props} />,
);
InputOTPGroup.displayName = "InputOTPGroup";

const InputOTPSlot = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div"> & { index: number }
>(({ index, className, ...props }, ref) => {
  const inputOTPContext = React.useContext(OTPInputContext);
  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index];

  return (
    <div
      ref={ref}
      className={cn(
        "relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
        isActive && "z-10 ring-2 ring-ring ring-offset-background",
        className,
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="animate-caret-blink h-4 w-px bg-foreground duration-1000" />
        </div>
      )}
    </div>
  );
});
InputOTPSlot.displayName = "InputOTPSlot";

const InputOTPSeparator = React.forwardRef<React.ElementRef<"div">, React.ComponentPropsWithoutRef<"div">>(
  ({ ...props }, ref) => (
    <div ref={ref} role="separator" {...props}>
      <Dot />
    </div>
  ),
);
InputOTPSeparator.displayName = "InputOTPSeparator";

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator };
</file>

<file path="src/components/ui/input.tsx">
import * as React from "react";

import { cn } from "@/lib/utils";

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className,
        )}
        ref={ref}
        {...props}
      />
    );
  },
);
Input.displayName = "Input";

export { Input };
</file>

<file path="src/components/ui/label.tsx">
import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const labelVariants = cva("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70");

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> & VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root ref={ref} className={cn(labelVariants(), className)} {...props} />
));
Label.displayName = LabelPrimitive.Root.displayName;

export { Label };
</file>

<file path="src/components/ui/menubar.tsx">
import * as React from "react";
import * as MenubarPrimitive from "@radix-ui/react-menubar";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const MenubarMenu = MenubarPrimitive.Menu;

const MenubarGroup = MenubarPrimitive.Group;

const MenubarPortal = MenubarPrimitive.Portal;

const MenubarSub = MenubarPrimitive.Sub;

const MenubarRadioGroup = MenubarPrimitive.RadioGroup;

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn("flex h-10 items-center space-x-1 rounded-md border bg-background p-1", className)}
    {...props}
  />
));
Menubar.displayName = MenubarPrimitive.Root.displayName;

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none data-[state=open]:bg-accent data-[state=open]:text-accent-foreground focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  />
));
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName;

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent data-[state=open]:text-accent-foreground focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
));
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName;

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName;

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(({ className, align = "start", alignOffset = -4, sideOffset = 8, ...props }, ref) => (
  <MenubarPrimitive.Portal>
    <MenubarPrimitive.Content
      ref={ref}
      align={align}
      alignOffset={alignOffset}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className,
      )}
      {...props}
    />
  </MenubarPrimitive.Portal>
));
MenubarContent.displayName = MenubarPrimitive.Content.displayName;

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
MenubarItem.displayName = MenubarPrimitive.Item.displayName;

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
));
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName;

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
));
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName;

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", inset && "pl-8", className)}
    {...props}
  />
));
MenubarLabel.displayName = MenubarPrimitive.Label.displayName;

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator ref={ref} className={cn("-mx-1 my-1 h-px bg-muted", className)} {...props} />
));
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName;

const MenubarShortcut = ({ className, ...props }: React.HTMLAttributes<HTMLSpanElement>) => {
  return <span className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)} {...props} />;
};
MenubarShortcut.displayname = "MenubarShortcut";

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
};
</file>

<file path="src/components/ui/navigation-menu.tsx">
import * as React from "react";
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu";
import { cva } from "class-variance-authority";
import { ChevronDown } from "lucide-react";

import { cn } from "@/lib/utils";

const NavigationMenu = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn("relative z-10 flex max-w-max flex-1 items-center justify-center", className)}
    {...props}
  >
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
));
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName;

const NavigationMenuList = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn("group flex flex-1 list-none items-center justify-center space-x-1", className)}
    {...props}
  />
));
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName;

const NavigationMenuItem = NavigationMenuPrimitive.Item;

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50",
);

const NavigationMenuTrigger = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}
  >
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
      aria-hidden="true"
    />
  </NavigationMenuPrimitive.Trigger>
));
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName;

const NavigationMenuContent = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto",
      className,
    )}
    {...props}
  />
));
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName;

const NavigationMenuLink = NavigationMenuPrimitive.Link;

const NavigationMenuViewport = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
>(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
        className,
      )}
      ref={ref}
      {...props}
    />
  </div>
));
NavigationMenuViewport.displayName = NavigationMenuPrimitive.Viewport.displayName;

const NavigationMenuIndicator = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className,
    )}
    {...props}
  >
    <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
));
NavigationMenuIndicator.displayName = NavigationMenuPrimitive.Indicator.displayName;

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
};
</file>

<file path="src/components/ui/pagination.tsx">
import * as React from "react";
import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react";

import { cn } from "@/lib/utils";
import { ButtonProps, buttonVariants } from "@/components/ui/button";

const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
  <nav
    role="navigation"
    aria-label="pagination"
    className={cn("mx-auto flex w-full justify-center", className)}
    {...props}
  />
);
Pagination.displayName = "Pagination";

const PaginationContent = React.forwardRef<HTMLUListElement, React.ComponentProps<"ul">>(
  ({ className, ...props }, ref) => (
    <ul ref={ref} className={cn("flex flex-row items-center gap-1", className)} {...props} />
  ),
);
PaginationContent.displayName = "PaginationContent";

const PaginationItem = React.forwardRef<HTMLLIElement, React.ComponentProps<"li">>(({ className, ...props }, ref) => (
  <li ref={ref} className={cn("", className)} {...props} />
));
PaginationItem.displayName = "PaginationItem";

type PaginationLinkProps = {
  isActive?: boolean;
} & Pick<ButtonProps, "size"> &
  React.ComponentProps<"a">;

const PaginationLink = ({ className, isActive, size = "icon", ...props }: PaginationLinkProps) => (
  <a
    aria-current={isActive ? "page" : undefined}
    className={cn(
      buttonVariants({
        variant: isActive ? "outline" : "ghost",
        size,
      }),
      className,
    )}
    {...props}
  />
);
PaginationLink.displayName = "PaginationLink";

const PaginationPrevious = ({ className, ...props }: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink aria-label="Go to previous page" size="default" className={cn("gap-1 pl-2.5", className)} {...props}>
    <ChevronLeft className="h-4 w-4" />
    <span>Previous</span>
  </PaginationLink>
);
PaginationPrevious.displayName = "PaginationPrevious";

const PaginationNext = ({ className, ...props }: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink aria-label="Go to next page" size="default" className={cn("gap-1 pr-2.5", className)} {...props}>
    <span>Next</span>
    <ChevronRight className="h-4 w-4" />
  </PaginationLink>
);
PaginationNext.displayName = "PaginationNext";

const PaginationEllipsis = ({ className, ...props }: React.ComponentProps<"span">) => (
  <span aria-hidden className={cn("flex h-9 w-9 items-center justify-center", className)} {...props}>
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More pages</span>
  </span>
);
PaginationEllipsis.displayName = "PaginationEllipsis";

export {
  Pagination,
  PaginationContent,
  PaginationEllipsis,
  PaginationItem,
  PaginationLink,
  PaginationNext,
  PaginationPrevious,
};
</file>

<file path="src/components/ui/popover.tsx">
import * as React from "react";
import * as PopoverPrimitive from "@radix-ui/react-popover";

import { cn } from "@/lib/utils";

const Popover = PopoverPrimitive.Root;

const PopoverTrigger = PopoverPrimitive.Trigger;

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className,
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
));
PopoverContent.displayName = PopoverPrimitive.Content.displayName;

export { Popover, PopoverTrigger, PopoverContent };
</file>

<file path="src/components/ui/progress.tsx">
import * as React from "react";
import * as ProgressPrimitive from "@radix-ui/react-progress";

import { cn } from "@/lib/utils";

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn("relative h-4 w-full overflow-hidden rounded-full bg-secondary", className)}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
));
Progress.displayName = ProgressPrimitive.Root.displayName;

export { Progress };
</file>

<file path="src/components/ui/radio-group.tsx">
import * as React from "react";
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group";
import { Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return <RadioGroupPrimitive.Root className={cn("grid gap-2", className)} {...props} ref={ref} />;
});
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName;

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  );
});
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName;

export { RadioGroup, RadioGroupItem };
</file>

<file path="src/components/ui/resizable.tsx">
import { GripVertical } from "lucide-react";
import * as ResizablePrimitive from "react-resizable-panels";

import { cn } from "@/lib/utils";

const ResizablePanelGroup = ({ className, ...props }: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
  <ResizablePrimitive.PanelGroup
    className={cn("flex h-full w-full data-[panel-group-direction=vertical]:flex-col", className)}
    {...props}
  />
);

const ResizablePanel = ResizablePrimitive.Panel;

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean;
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className,
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
);

export { ResizablePanelGroup, ResizablePanel, ResizableHandle };
</file>

<file path="src/components/ui/scroll-area.tsx">
import * as React from "react";
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area";

import { cn } from "@/lib/utils";

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root ref={ref} className={cn("relative overflow-hidden", className)} {...props}>
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">{children}</ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
));
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName;

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" && "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" && "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className,
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
));
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName;

export { ScrollArea, ScrollBar };
</file>

<file path="src/components/ui/select.tsx">
import * as React from "react";
import * as SelectPrimitive from "@radix-ui/react-select";
import { Check, ChevronDown, ChevronUp } from "lucide-react";

import { cn } from "@/lib/utils";

const Select = SelectPrimitive.Root;

const SelectGroup = SelectPrimitive.Group;

const SelectValue = SelectPrimitive.Value;

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className,
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
));
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName;

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn("flex cursor-default items-center justify-center py-1", className)}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
));
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName;

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn("flex cursor-default items-center justify-center py-1", className)}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
));
SelectScrollDownButton.displayName = SelectPrimitive.ScrollDownButton.displayName;

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className,
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]",
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
));
SelectContent.displayName = SelectPrimitive.Content.displayName;

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label ref={ref} className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)} {...props} />
));
SelectLabel.displayName = SelectPrimitive.Label.displayName;

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
));
SelectItem.displayName = SelectPrimitive.Item.displayName;

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator ref={ref} className={cn("-mx-1 my-1 h-px bg-muted", className)} {...props} />
));
SelectSeparator.displayName = SelectPrimitive.Separator.displayName;

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
};
</file>

<file path="src/components/ui/separator.tsx">
import * as React from "react";
import * as SeparatorPrimitive from "@radix-ui/react-separator";

import { cn } from "@/lib/utils";

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(({ className, orientation = "horizontal", decorative = true, ...props }, ref) => (
  <SeparatorPrimitive.Root
    ref={ref}
    decorative={decorative}
    orientation={orientation}
    className={cn("shrink-0 bg-border", orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]", className)}
    {...props}
  />
));
Separator.displayName = SeparatorPrimitive.Root.displayName;

export { Separator };
</file>

<file path="src/components/ui/sheet.tsx">
import * as SheetPrimitive from "@radix-ui/react-dialog";
import { cva, type VariantProps } from "class-variance-authority";
import { X } from "lucide-react";
import * as React from "react";

import { cn } from "@/lib/utils";

const Sheet = SheetPrimitive.Root;

const SheetTrigger = SheetPrimitive.Trigger;

const SheetClose = SheetPrimitive.Close;

const SheetPortal = SheetPrimitive.Portal;

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className,
    )}
    {...props}
    ref={ref}
  />
));
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName;

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  },
);

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<React.ElementRef<typeof SheetPrimitive.Content>, SheetContentProps>(
  ({ side = "right", className, children, ...props }, ref) => (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content ref={ref} className={cn(sheetVariants({ side }), className)} {...props}>
        {children}
        <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-secondary hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none">
          <X className="h-4 w-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  ),
);
SheetContent.displayName = SheetPrimitive.Content.displayName;

const SheetHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col space-y-2 text-center sm:text-left", className)} {...props} />
);
SheetHeader.displayName = "SheetHeader";

const SheetFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)} {...props} />
);
SheetFooter.displayName = "SheetFooter";

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title ref={ref} className={cn("text-lg font-semibold text-foreground", className)} {...props} />
));
SheetTitle.displayName = SheetPrimitive.Title.displayName;

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description ref={ref} className={cn("text-sm text-muted-foreground", className)} {...props} />
));
SheetDescription.displayName = SheetPrimitive.Description.displayName;

export {
  Sheet,
  SheetClose,
  SheetContent,
  SheetDescription,
  SheetFooter,
  SheetHeader,
  SheetOverlay,
  SheetPortal,
  SheetTitle,
  SheetTrigger,
};
</file>

<file path="src/components/ui/sidebar.tsx">
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { VariantProps, cva } from "class-variance-authority";
import { PanelLeft } from "lucide-react";

import { useIsMobile } from "@/hooks/use-mobile";
import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Separator } from "@/components/ui/separator";
import { Sheet, SheetContent } from "@/components/ui/sheet";
import { Skeleton } from "@/components/ui/skeleton";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";

const SIDEBAR_COOKIE_NAME = "sidebar:state";
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7;
const SIDEBAR_WIDTH = "16rem";
const SIDEBAR_WIDTH_MOBILE = "18rem";
const SIDEBAR_WIDTH_ICON = "3rem";
const SIDEBAR_KEYBOARD_SHORTCUT = "b";

type SidebarContext = {
  state: "expanded" | "collapsed";
  open: boolean;
  setOpen: (open: boolean) => void;
  openMobile: boolean;
  setOpenMobile: (open: boolean) => void;
  isMobile: boolean;
  toggleSidebar: () => void;
};

const SidebarContext = React.createContext<SidebarContext | null>(null);

function useSidebar() {
  const context = React.useContext(SidebarContext);
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.");
  }

  return context;
}

const SidebarProvider = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    defaultOpen?: boolean;
    open?: boolean;
    onOpenChange?: (open: boolean) => void;
  }
>(({ defaultOpen = true, open: openProp, onOpenChange: setOpenProp, className, style, children, ...props }, ref) => {
  const isMobile = useIsMobile();
  const [openMobile, setOpenMobile] = React.useState(false);

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen);
  const open = openProp ?? _open;
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === "function" ? value(open) : value;
      if (setOpenProp) {
        setOpenProp(openState);
      } else {
        _setOpen(openState);
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`;
    },
    [setOpenProp, open],
  );

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open);
  }, [isMobile, setOpen, setOpenMobile]);

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === SIDEBAR_KEYBOARD_SHORTCUT && (event.metaKey || event.ctrlKey)) {
        event.preventDefault();
        toggleSidebar();
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [toggleSidebar]);

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? "expanded" : "collapsed";

  const contextValue = React.useMemo<SidebarContext>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar],
  );

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH,
              "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar", className)}
          ref={ref}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  );
});
SidebarProvider.displayName = "SidebarProvider";

const Sidebar = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    side?: "left" | "right";
    variant?: "sidebar" | "floating" | "inset";
    collapsible?: "offcanvas" | "icon" | "none";
  }
>(({ side = "left", variant = "sidebar", collapsible = "offcanvas", className, children, ...props }, ref) => {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar();

  if (collapsible === "none") {
    return (
      <div
        className={cn("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground", className)}
        ref={ref}
        {...props}
      >
        {children}
      </div>
    );
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-mobile="true"
          className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    );
  }

  return (
    <div
      ref={ref}
      className="group peer hidden text-sidebar-foreground md:block"
      data-state={state}
      data-collapsible={state === "collapsed" ? collapsible : ""}
      data-variant={variant}
      data-side={side}
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        className={cn(
          "relative h-svh w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear",
          "group-data-[collapsible=offcanvas]:w-0",
          "group-data-[side=right]:rotate-180",
          variant === "floating" || variant === "inset"
            ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
            : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]",
        )}
      />
      <div
        className={cn(
          "fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",
          side === "left"
            ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
            : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
          // Adjust the padding for floating and inset variants.
          variant === "floating" || variant === "inset"
            ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
            : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
          className,
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
        >
          {children}
        </div>
      </div>
    </div>
  );
});
Sidebar.displayName = "Sidebar";

const SidebarTrigger = React.forwardRef<React.ElementRef<typeof Button>, React.ComponentProps<typeof Button>>(
  ({ className, onClick, ...props }, ref) => {
    const { toggleSidebar } = useSidebar();

    return (
      <Button
        ref={ref}
        data-sidebar="trigger"
        variant="ghost"
        size="icon"
        className={cn("h-7 w-7", className)}
        onClick={(event) => {
          onClick?.(event);
          toggleSidebar();
        }}
        {...props}
      >
        <PanelLeft />
        <span className="sr-only">Toggle Sidebar</span>
      </Button>
    );
  },
);
SidebarTrigger.displayName = "SidebarTrigger";

const SidebarRail = React.forwardRef<HTMLButtonElement, React.ComponentProps<"button">>(
  ({ className, ...props }, ref) => {
    const { toggleSidebar } = useSidebar();

    return (
      <button
        ref={ref}
        data-sidebar="rail"
        aria-label="Toggle Sidebar"
        tabIndex={-1}
        onClick={toggleSidebar}
        title="Toggle Sidebar"
        className={cn(
          "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] group-data-[side=left]:-right-4 group-data-[side=right]:left-0 hover:after:bg-sidebar-border sm:flex",
          "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
          "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
          "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
          "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
          "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
          className,
        )}
        {...props}
      />
    );
  },
);
SidebarRail.displayName = "SidebarRail";

const SidebarInset = React.forwardRef<HTMLDivElement, React.ComponentProps<"main">>(({ className, ...props }, ref) => {
  return (
    <main
      ref={ref}
      className={cn(
        "relative flex min-h-svh flex-1 flex-col bg-background",
        "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className,
      )}
      {...props}
    />
  );
});
SidebarInset.displayName = "SidebarInset";

const SidebarInput = React.forwardRef<React.ElementRef<typeof Input>, React.ComponentProps<typeof Input>>(
  ({ className, ...props }, ref) => {
    return (
      <Input
        ref={ref}
        data-sidebar="input"
        className={cn(
          "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
          className,
        )}
        {...props}
      />
    );
  },
);
SidebarInput.displayName = "SidebarInput";

const SidebarHeader = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(({ className, ...props }, ref) => {
  return <div ref={ref} data-sidebar="header" className={cn("flex flex-col gap-2 p-2", className)} {...props} />;
});
SidebarHeader.displayName = "SidebarHeader";

const SidebarFooter = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(({ className, ...props }, ref) => {
  return <div ref={ref} data-sidebar="footer" className={cn("flex flex-col gap-2 p-2", className)} {...props} />;
});
SidebarFooter.displayName = "SidebarFooter";

const SidebarSeparator = React.forwardRef<React.ElementRef<typeof Separator>, React.ComponentProps<typeof Separator>>(
  ({ className, ...props }, ref) => {
    return (
      <Separator
        ref={ref}
        data-sidebar="separator"
        className={cn("mx-2 w-auto bg-sidebar-border", className)}
        {...props}
      />
    );
  },
);
SidebarSeparator.displayName = "SidebarSeparator";

const SidebarContent = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className,
      )}
      {...props}
    />
  );
});
SidebarContent.displayName = "SidebarContent";

const SidebarGroup = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  );
});
SidebarGroup.displayName = "SidebarGroup";

const SidebarGroupLabel = React.forwardRef<HTMLDivElement, React.ComponentProps<"div"> & { asChild?: boolean }>(
  ({ className, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "div";

    return (
      <Comp
        ref={ref}
        data-sidebar="group-label"
        className={cn(
          "flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
          "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
          className,
        )}
        {...props}
      />
    );
  },
);
SidebarGroupLabel.displayName = "SidebarGroupLabel";

const SidebarGroupAction = React.forwardRef<HTMLButtonElement, React.ComponentProps<"button"> & { asChild?: boolean }>(
  ({ className, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button";

    return (
      <Comp
        ref={ref}
        data-sidebar="group-action"
        className={cn(
          "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
          // Increases the hit area of the button on mobile.
          "after:absolute after:-inset-2 after:md:hidden",
          "group-data-[collapsible=icon]:hidden",
          className,
        )}
        {...props}
      />
    );
  },
);
SidebarGroupAction.displayName = "SidebarGroupAction";

const SidebarGroupContent = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(
  ({ className, ...props }, ref) => (
    <div ref={ref} data-sidebar="group-content" className={cn("w-full text-sm", className)} {...props} />
  ),
);
SidebarGroupContent.displayName = "SidebarGroupContent";

const SidebarMenu = React.forwardRef<HTMLUListElement, React.ComponentProps<"ul">>(({ className, ...props }, ref) => (
  <ul ref={ref} data-sidebar="menu" className={cn("flex w-full min-w-0 flex-col gap-1", className)} {...props} />
));
SidebarMenu.displayName = "SidebarMenu";

const SidebarMenuItem = React.forwardRef<HTMLLIElement, React.ComponentProps<"li">>(({ className, ...props }, ref) => (
  <li ref={ref} data-sidebar="menu-item" className={cn("group/menu-item relative", className)} {...props} />
));
SidebarMenuItem.displayName = "SidebarMenuItem";

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

const SidebarMenuButton = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean;
    isActive?: boolean;
    tooltip?: string | React.ComponentProps<typeof TooltipContent>;
  } & VariantProps<typeof sidebarMenuButtonVariants>
>(({ asChild = false, isActive = false, variant = "default", size = "default", tooltip, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "button";
  const { isMobile, state } = useSidebar();

  const button = (
    <Comp
      ref={ref}
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  );

  if (!tooltip) {
    return button;
  }

  if (typeof tooltip === "string") {
    tooltip = {
      children: tooltip,
    };
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent side="right" align="center" hidden={state !== "collapsed" || isMobile} {...tooltip} />
    </Tooltip>
  );
});
SidebarMenuButton.displayName = "SidebarMenuButton";

const SidebarMenuAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean;
    showOnHover?: boolean;
  }
>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform peer-hover/menu-button:text-sidebar-accent-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className,
      )}
      {...props}
    />
  );
});
SidebarMenuAction.displayName = "SidebarMenuAction";

const SidebarMenuBadge = React.forwardRef<HTMLDivElement, React.ComponentProps<"div">>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      data-sidebar="menu-badge"
      className={cn(
        "pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground",
        "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  ),
);
SidebarMenuBadge.displayName = "SidebarMenuBadge";

const SidebarMenuSkeleton = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    showIcon?: boolean;
  }
>(({ className, showIcon = false, ...props }, ref) => {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`;
  }, []);

  return (
    <div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}
    >
      {showIcon && <Skeleton className="size-4 rounded-md" data-sidebar="menu-skeleton-icon" />}
      <Skeleton
        className="h-4 max-w-[--skeleton-width] flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  );
});
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton";

const SidebarMenuSub = React.forwardRef<HTMLUListElement, React.ComponentProps<"ul">>(
  ({ className, ...props }, ref) => (
    <ul
      ref={ref}
      data-sidebar="menu-sub"
      className={cn(
        "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  ),
);
SidebarMenuSub.displayName = "SidebarMenuSub";

const SidebarMenuSubItem = React.forwardRef<HTMLLIElement, React.ComponentProps<"li">>(({ ...props }, ref) => (
  <li ref={ref} {...props} />
));
SidebarMenuSubItem.displayName = "SidebarMenuSubItem";

const SidebarMenuSubButton = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentProps<"a"> & {
    asChild?: boolean;
    size?: "sm" | "md";
    isActive?: boolean;
  }
>(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a";

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring aria-disabled:pointer-events-none aria-disabled:opacity-50 hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
});
SidebarMenuSubButton.displayName = "SidebarMenuSubButton";

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
};
</file>

<file path="src/components/ui/skeleton.tsx">
import { cn } from "@/lib/utils";

function Skeleton({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) {
  return <div className={cn("animate-pulse rounded-md bg-muted", className)} {...props} />;
}

export { Skeleton };
</file>

<file path="src/components/ui/slider.tsx">
import * as React from "react";
import * as SliderPrimitive from "@radix-ui/react-slider";

import { cn } from "@/lib/utils";

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn("relative flex w-full touch-none select-none items-center", className)}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
));
Slider.displayName = SliderPrimitive.Root.displayName;

export { Slider };
</file>

<file path="src/components/ui/sonner.tsx">
import { useTheme } from "next-themes";
import { Toaster as Sonner, toast } from "sonner";

type ToasterProps = React.ComponentProps<typeof Sonner>;

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme();

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton: "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton: "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props}
    />
  );
};

export { Toaster, toast };
</file>

<file path="src/components/ui/switch.tsx">
import * as React from "react";
import * as SwitchPrimitives from "@radix-ui/react-switch";

import { cn } from "@/lib/utils";

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50",
      className,
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0",
      )}
    />
  </SwitchPrimitives.Root>
));
Switch.displayName = SwitchPrimitives.Root.displayName;

export { Switch };
</file>

<file path="src/components/ui/table.tsx">
import * as React from "react";

import { cn } from "@/lib/utils";

const Table = React.forwardRef<HTMLTableElement, React.HTMLAttributes<HTMLTableElement>>(
  ({ className, ...props }, ref) => (
    <div className="relative w-full overflow-auto">
      <table ref={ref} className={cn("w-full caption-bottom text-sm", className)} {...props} />
    </div>
  ),
);
Table.displayName = "Table";

const TableHeader = React.forwardRef<HTMLTableSectionElement, React.HTMLAttributes<HTMLTableSectionElement>>(
  ({ className, ...props }, ref) => <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />,
);
TableHeader.displayName = "TableHeader";

const TableBody = React.forwardRef<HTMLTableSectionElement, React.HTMLAttributes<HTMLTableSectionElement>>(
  ({ className, ...props }, ref) => (
    <tbody ref={ref} className={cn("[&_tr:last-child]:border-0", className)} {...props} />
  ),
);
TableBody.displayName = "TableBody";

const TableFooter = React.forwardRef<HTMLTableSectionElement, React.HTMLAttributes<HTMLTableSectionElement>>(
  ({ className, ...props }, ref) => (
    <tfoot ref={ref} className={cn("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0", className)} {...props} />
  ),
);
TableFooter.displayName = "TableFooter";

const TableRow = React.forwardRef<HTMLTableRowElement, React.HTMLAttributes<HTMLTableRowElement>>(
  ({ className, ...props }, ref) => (
    <tr
      ref={ref}
      className={cn("border-b transition-colors data-[state=selected]:bg-muted hover:bg-muted/50", className)}
      {...props}
    />
  ),
);
TableRow.displayName = "TableRow";

const TableHead = React.forwardRef<HTMLTableCellElement, React.ThHTMLAttributes<HTMLTableCellElement>>(
  ({ className, ...props }, ref) => (
    <th
      ref={ref}
      className={cn(
        "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
        className,
      )}
      {...props}
    />
  ),
);
TableHead.displayName = "TableHead";

const TableCell = React.forwardRef<HTMLTableCellElement, React.TdHTMLAttributes<HTMLTableCellElement>>(
  ({ className, ...props }, ref) => (
    <td ref={ref} className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)} {...props} />
  ),
);
TableCell.displayName = "TableCell";

const TableCaption = React.forwardRef<HTMLTableCaptionElement, React.HTMLAttributes<HTMLTableCaptionElement>>(
  ({ className, ...props }, ref) => (
    <caption ref={ref} className={cn("mt-4 text-sm text-muted-foreground", className)} {...props} />
  ),
);
TableCaption.displayName = "TableCaption";

export { Table, TableHeader, TableBody, TableFooter, TableHead, TableRow, TableCell, TableCaption };
</file>

<file path="src/components/ui/tabs.tsx">
import * as React from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs";

import { cn } from "@/lib/utils";

const Tabs = TabsPrimitive.Root;

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className,
    )}
    {...props}
  />
));
TabsList.displayName = TabsPrimitive.List.displayName;

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
      className,
    )}
    {...props}
  />
));
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName;

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className,
    )}
    {...props}
  />
));
TabsContent.displayName = TabsPrimitive.Content.displayName;

export { Tabs, TabsList, TabsTrigger, TabsContent };
</file>

<file path="src/components/ui/textarea.tsx">
import * as React from "react";

import { cn } from "@/lib/utils";

export interface TextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      ref={ref}
      {...props}
    />
  );
});
Textarea.displayName = "Textarea";

export { Textarea };
</file>

<file path="src/components/ui/toast.tsx">
import * as React from "react";
import * as ToastPrimitives from "@radix-ui/react-toast";
import { cva, type VariantProps } from "class-variance-authority";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";

const ToastProvider = ToastPrimitives.Provider;

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className,
    )}
    {...props}
  />
));
ToastViewport.displayName = ToastPrimitives.Viewport.displayName;

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive: "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> & VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return <ToastPrimitives.Root ref={ref} className={cn(toastVariants({ variant }), className)} {...props} />;
});
Toast.displayName = ToastPrimitives.Root.displayName;

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors group-[.destructive]:border-muted/40 hover:bg-secondary group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 group-[.destructive]:focus:ring-destructive disabled:pointer-events-none disabled:opacity-50",
      className,
    )}
    {...props}
  />
));
ToastAction.displayName = ToastPrimitives.Action.displayName;

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity group-hover:opacity-100 group-[.destructive]:text-red-300 hover:text-foreground group-[.destructive]:hover:text-red-50 focus:opacity-100 focus:outline-none focus:ring-2 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className,
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
));
ToastClose.displayName = ToastPrimitives.Close.displayName;

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title ref={ref} className={cn("text-sm font-semibold", className)} {...props} />
));
ToastTitle.displayName = ToastPrimitives.Title.displayName;

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description ref={ref} className={cn("text-sm opacity-90", className)} {...props} />
));
ToastDescription.displayName = ToastPrimitives.Description.displayName;

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>;

type ToastActionElement = React.ReactElement<typeof ToastAction>;

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
};
</file>

<file path="src/components/ui/toaster.tsx">
import { useToast } from "@/hooks/use-toast";
import { Toast, ToastClose, ToastDescription, ToastProvider, ToastTitle, ToastViewport } from "@/components/ui/toast";

export function Toaster() {
  const { toasts } = useToast();

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && <ToastDescription>{description}</ToastDescription>}
            </div>
            {action}
            <ToastClose />
          </Toast>
        );
      })}
      <ToastViewport />
    </ToastProvider>
  );
}
</file>

<file path="src/components/ui/toggle-group.tsx">
import * as React from "react";
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group";
import { type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";
import { toggleVariants } from "@/components/ui/toggle";

const ToggleGroupContext = React.createContext<VariantProps<typeof toggleVariants>>({
  size: "default",
  variant: "default",
});

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> & VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root ref={ref} className={cn("flex items-center justify-center gap-1", className)} {...props}>
    <ToggleGroupContext.Provider value={{ variant, size }}>{children}</ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
));

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName;

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> & VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext);

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className,
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  );
});

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName;

export { ToggleGroup, ToggleGroupItem };
</file>

<file path="src/components/ui/toggle.tsx">
import * as React from "react";
import * as TogglePrimitive from "@radix-ui/react-toggle";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const toggleVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline: "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-10 px-3",
        sm: "h-9 px-2.5",
        lg: "h-11 px-5",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> & VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root ref={ref} className={cn(toggleVariants({ variant, size, className }))} {...props} />
));

Toggle.displayName = TogglePrimitive.Root.displayName;

export { Toggle, toggleVariants };
</file>

<file path="src/components/ui/tooltip.tsx">
import * as React from "react";
import * as TooltipPrimitive from "@radix-ui/react-tooltip";

import { cn } from "@/lib/utils";

const TooltipProvider = TooltipPrimitive.Provider;

const Tooltip = TooltipPrimitive.Root;

const TooltipTrigger = TooltipPrimitive.Trigger;

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className,
    )}
    {...props}
  />
));
TooltipContent.displayName = TooltipPrimitive.Content.displayName;

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };
</file>

<file path="src/components/ui/use-toast.ts">
import { useToast, toast } from "@/hooks/use-toast";

export { useToast, toast };
</file>

<file path="src/components/EmailResult.tsx">
import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Check, Copy } from 'lucide-react';
import type { EmailResponse } from '@/lib/prompt';

interface EmailResultProps {
  result: EmailResponse;
}

export function EmailResult({ result }: EmailResultProps) {
  const [copiedSubject, setCopiedSubject] = useState(false);
  const [copiedBody, setCopiedBody] = useState(false);

  const copyToClipboard = async (text: string, type: 'subject' | 'body') => {
    await navigator.clipboard.writeText(text);
    if (type === 'subject') {
      setCopiedSubject(true);
      setTimeout(() => setCopiedSubject(false), 2000);
    } else {
      setCopiedBody(true);
      setTimeout(() => setCopiedBody(false), 2000);
    }
  };

  return (
    <div className="space-y-8 animate-fade-in">
      <h2 className="font-serif text-2xl font-medium">Your Generated Email</h2>

      <div className="space-y-6">
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <label className="text-sm font-medium uppercase tracking-wide text-muted-foreground">
              Subject Line
            </label>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => copyToClipboard(result.subject, 'subject')}
              className="h-8 px-2 text-xs rounded-none"
            >
              {copiedSubject ? (
                <>
                  <Check className="mr-1 h-3 w-3" />
                  Copied
                </>
              ) : (
                <>
                  <Copy className="mr-1 h-3 w-3" />
                  Copy
                </>
              )}
            </Button>
          </div>
          <div className="border-l-2 border-foreground pl-4 py-2 font-serif text-lg">
            {result.subject}
          </div>
        </div>

        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <label className="text-sm font-medium uppercase tracking-wide text-muted-foreground">
              Email Body
            </label>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => copyToClipboard(result.body, 'body')}
              className="h-8 px-2 text-xs rounded-none"
            >
              {copiedBody ? (
                <>
                  <Check className="mr-1 h-3 w-3" />
                  Copied
                </>
              ) : (
                <>
                  <Copy className="mr-1 h-3 w-3" />
                  Copy
                </>
              )}
            </Button>
          </div>
          <div className="bg-secondary/50 border border-border p-6 whitespace-pre-wrap text-base leading-relaxed font-body">
            {result.body}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/GenerationProgress.tsx">
import { AlertCircle, Loader2 } from 'lucide-react';
import { Progress } from '@/components/ui/progress';
import { useEmailGenerationProgress } from '@/hooks/useEmailGenerationProgress';
import { StageIndicator, type StageStatus } from '@/components/StageIndicator';
import { TipsCarousel } from '@/components/TipsCarousel';

interface GenerationProgressProps {
  recipientName: string;
  recipientCompany: string;
}

function interpolateDescription(
  description: string,
  values: { recipientName: string; recipientCompany: string }
): string {
  return description
    .replace('{recipientName}', values.recipientName)
    .replace('{recipientCompany}', values.recipientCompany);
}

function getStageStatus(stageIndex: number, currentStageIndex: number): StageStatus {
  if (stageIndex < currentStageIndex) return 'completed';
  if (stageIndex === currentStageIndex) return 'current';
  return 'pending';
}

export function GenerationProgress({
  recipientName,
  recipientCompany
}: GenerationProgressProps) {
  const {
    currentStage,
    currentStageIndex,
    totalProgress,
    elapsedTime,
    currentTip,
    currentTipIndex,
    allStages
  } = useEmailGenerationProgress();

  const showTimeoutWarning = elapsedTime > 90000;

  return (
    <div className="space-y-6 py-8">
      {/* Overall Progress Bar */}
      <div className="space-y-2">
        <div className="flex justify-between text-sm font-body">
          <span className="font-medium">Generation Progress</span>
          <span className="text-muted-foreground">{Math.round(totalProgress)}%</span>
        </div>
        <Progress value={totalProgress} className="h-2" />
      </div>

      {/* Current Stage */}
      <div className="border-l-2 border-foreground pl-6 py-4 space-y-3">
        <div className="flex items-center gap-3">
          <Loader2 className="h-5 w-5 animate-spin text-foreground" />
          <h3 className="font-serif text-xl font-medium">
            {currentStage.label}
          </h3>
        </div>
        <p className="text-muted-foreground font-body">
          {interpolateDescription(currentStage.description, {
            recipientName,
            recipientCompany
          })}
        </p>
      </div>

      {/* Educational Tips (when available for current stage) */}
      {currentStage.tips && currentStage.tips.length > 0 && (
        <TipsCarousel tips={currentStage.tips} currentTipIndex={currentTipIndex} />
      )}

      {/* Timeout Warning */}
      {showTimeoutWarning && (
        <div className="bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-900 p-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="h-5 w-5 text-amber-600 dark:text-amber-400 shrink-0 mt-0.5" />
            <div className="space-y-2">
              <p className="font-medium text-amber-900 dark:text-amber-400 text-sm">
                Taking longer than expected
              </p>
              <p className="text-sm text-amber-700 dark:text-amber-500 font-body">
                Deep research in progress. We're finding the best possible hooks for your email.
              </p>
              <p className="text-sm text-amber-700 dark:text-amber-500 font-body">
                You can wait a bit longer, or we'll use what we've found so far.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Stage Timeline */}
      <div className="space-y-2 pt-2">
        <p className="text-xs uppercase tracking-wide text-muted-foreground font-body mb-3">
          All Stages
        </p>
        {allStages.map((stage, index) => (
          <StageIndicator
            key={stage.id}
            stage={stage}
            status={getStageStatus(index, currentStageIndex)}
          />
        ))}
      </div>

      {/* Time Elapsed Indicator */}
      {elapsedTime > 60000 && !showTimeoutWarning && (
        <div className="text-xs text-muted-foreground text-center font-body pt-2">
          <p>Deep research in progress...</p>
          <p>This typically takes 60-90 seconds for best results</p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/HookPicker.tsx">
import { Badge } from '@/components/ui/badge';
import { Card } from '@/components/ui/card';
import { Check, ExternalLink } from 'lucide-react';
import { cn } from '@/lib/utils';

interface Hook {
  id: string;
  title: string;
  hook: string;
  whyItWorks: string;
  confidence: number;
  sources: Array<{ label: string; url: string }>;
}

interface HookPickerProps {
  hooks: Hook[];
  selectedHook: Hook | null;
  onSelectHook: (hook: Hook) => void;
  partial?: boolean;
}

export function HookPicker({ hooks, selectedHook, onSelectHook, partial }: HookPickerProps) {
  if (!hooks || hooks.length === 0) {
    return (
      <div className="space-y-4 py-8">
        <h3 className="font-serif text-xl font-medium">No Hooks Found</h3>
        <p className="text-muted-foreground font-body">
          We couldn't find strong personalization hooks for this recipient. The email will be generated with general information.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-6 py-8">
      <div>
        <div className="flex items-center gap-3 mb-2">
          <h3 className="font-serif text-xl font-medium">Research Complete</h3>
          {partial && (
            <Badge variant="outline" className="text-amber-600 border-amber-600">
              Partial Research
            </Badge>
          )}
        </div>
        <p className="text-sm text-muted-foreground font-body">
          We found {hooks.length} personalization {hooks.length === 1 ? 'hook' : 'hooks'}. Click one to generate your email.
        </p>
      </div>

      <div className="space-y-3">
        {hooks.map((hook) => {
          const isSelected = selectedHook?.id === hook.id;
          const confidencePercent = Math.round(hook.confidence * 100);

          return (
            <Card
              key={hook.id}
              onClick={() => onSelectHook(hook)}
              className={cn(
                'p-4 cursor-pointer transition-all hover:border-foreground hover:shadow-md',
                isSelected && 'border-foreground bg-muted/30'
              )}
            >
              <div className="flex items-start gap-3">
                {/* Selection indicator */}
                <div
                  className={cn(
                    'h-5 w-5 rounded-full border-2 flex items-center justify-center shrink-0 mt-0.5',
                    isSelected
                      ? 'bg-foreground border-foreground'
                      : 'border-border'
                  )}
                >
                  {isSelected && <Check className="h-3 w-3 text-background" />}
                </div>

                {/* Hook content */}
                <div className="flex-1 space-y-3">
                  <div className="flex items-start justify-between gap-3">
                    <h4 className="font-medium">{hook.title}</h4>
                    <Badge
                      variant="outline"
                      className={cn(
                        'shrink-0',
                        confidencePercent >= 65
                          ? 'text-green-600 border-green-600'
                          : confidencePercent >= 50
                          ? 'text-amber-600 border-amber-600'
                          : 'text-muted-foreground border-border'
                      )}
                    >
                      {confidencePercent}% confidence
                    </Badge>
                  </div>

                  <p className="text-sm text-foreground font-body leading-relaxed">
                    {hook.hook}
                  </p>

                  <p className="text-sm text-muted-foreground font-body italic">
                    Why it works: {hook.whyItWorks}
                  </p>

                  {/* Sources */}
                  {hook.sources && hook.sources.length > 0 && (
                    <div className="pt-2 border-t border-border">
                      <p className="text-xs text-muted-foreground mb-2 font-medium">
                        Sources:
                      </p>
                      <div className="space-y-1">
                        {hook.sources.map((source, idx) => (
                          <a
                            key={idx}
                            href={source.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="flex items-center gap-2 text-xs text-blue-600 hover:underline"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <ExternalLink className="h-3 w-3" />
                            {source.label}
                          </a>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </Card>
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="src/components/NavLink.tsx">
import { NavLink as RouterNavLink, NavLinkProps } from "react-router-dom";
import { forwardRef } from "react";
import { cn } from "@/lib/utils";

interface NavLinkCompatProps extends Omit<NavLinkProps, "className"> {
  className?: string;
  activeClassName?: string;
  pendingClassName?: string;
}

const NavLink = forwardRef<HTMLAnchorElement, NavLinkCompatProps>(
  ({ className, activeClassName, pendingClassName, to, ...props }, ref) => {
    return (
      <RouterNavLink
        ref={ref}
        to={to}
        className={({ isActive, isPending }) =>
          cn(className, isActive && activeClassName, isPending && pendingClassName)
        }
        {...props}
      />
    );
  },
);

NavLink.displayName = "NavLink";

export { NavLink };
</file>

<file path="src/components/ResearchEmailForm.tsx">
import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Checkbox } from '@/components/ui/checkbox';
import { Loader2, Sparkles } from 'lucide-react';
import type { AskType, EmailRequest, SharedAffiliationType } from '@/lib/prompt';

interface ResearchEmailFormProps {
  onSubmit: (request: EmailRequest) => void;
  isLoading: boolean;
}

const ASK_TYPES: { value: AskType; label: string }[] = [
  { value: 'chat', label: 'Short introductory chat' },
  { value: 'feedback', label: 'Feedback on something' },
  { value: 'referral', label: 'Referral / introduction' },
  { value: 'job', label: 'Job- or recruiting-related' },
  { value: 'other', label: 'Other' },
];

const AFFILIATION_TYPES: { value: SharedAffiliationType; label: string }[] = [
  { value: 'none', label: 'No shared background' },
  { value: 'school', label: 'Same school / university' },
  { value: 'business_school', label: 'Same business school / MBA program' },
  { value: 'company', label: 'Same previous company' },
  { value: 'accelerator', label: 'Same accelerator / fellowship / program' },
  { value: 'personal_characteristics', label: 'Shared personal characteristics (race, ethnicity, nationality)' },
  { value: 'other', label: 'Other' },
];

export function ResearchEmailForm({ onSubmit, isLoading }: ResearchEmailFormProps) {
  const [recipientName, setRecipientName] = useState('');
  const [recipientCompany, setRecipientCompany] = useState('');
  const [recipientRole, setRecipientRole] = useState('');
  const [askType, setAskType] = useState<AskType>('chat');
  const [reachingOutBecause, setReachingOutBecause] = useState('');
  const [credibilityStory, setCredibilityStory] = useState('');
  
  // Shared affiliation state
  const [selectedAffiliationTypes, setSelectedAffiliationTypes] = useState<SharedAffiliationType[]>([]);
  const [affiliationName, setAffiliationName] = useState('');
  const [affiliationDetail, setAffiliationDetail] = useState('');

  // Debug mode state
  const [debugMode, setDebugMode] = useState(false);

  // Has a real affiliation selected (not "none")
  const hasRealAffiliationSelected = selectedAffiliationTypes.some(t => t !== 'none');

  const handleAffiliationTypeToggle = (type: SharedAffiliationType) => {
    if (type === 'none') {
      // "None" clears all other selections
      setSelectedAffiliationTypes(prev => prev.includes('none') ? [] : ['none']);
      setAffiliationName('');
      setAffiliationDetail('');
      return;
    }
    // Selecting any other option removes "none"
    setSelectedAffiliationTypes(prev => {
      const withoutNone = prev.filter(t => t !== 'none');
      return withoutNone.includes(type) 
        ? withoutNone.filter(t => t !== type)
        : [...withoutNone, type];
    });
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    const request: EmailRequest & { includeDebug?: boolean } = {
      recipientName,
      recipientCompany,
      recipientRole,
      askType,
      reachingOutBecause,
      credibilityStory,
    };

    // Only include shared affiliation if types are selected and name is provided
    if (hasRealAffiliationSelected && affiliationName.trim()) {
      request.sharedAffiliation = {
        types: selectedAffiliationTypes,
        name: affiliationName.trim(),
        detail: affiliationDetail.trim() || undefined,
      };
    }

    // Include debug flag if enabled
    if (debugMode) {
      request.includeDebug = true;
    }

    onSubmit(request);
  };

  const isFormValid =
    recipientName.trim() &&
    recipientCompany.trim() &&
    recipientRole.trim() &&
    reachingOutBecause.trim() &&
    credibilityStory.trim() &&
    // If affiliation types selected, name is required
    (!hasRealAffiliationSelected || affiliationName.trim());

  return (
    <form onSubmit={handleSubmit} className="space-y-10">
      {/* Recipient Context Section */}
      <section className="space-y-5">
        <h3 className="font-serif text-lg font-medium border-b border-border pb-2">
          Who are you emailing?
        </h3>
        
        <div className="space-y-2">
          <Label htmlFor="recipientName" className="text-sm font-medium">
            Recipient's full name <span className="text-destructive">*</span>
          </Label>
          <Input
            id="recipientName"
            placeholder="Jane Smith"
            value={recipientName}
            onChange={(e) => setRecipientName(e.target.value)}
            className="bg-background border-border"
            required
            maxLength={100}
          />
        </div>

        <div className="grid gap-5 sm:grid-cols-2">
          <div className="space-y-2">
            <Label htmlFor="recipientCompany" className="text-sm font-medium">
              Company <span className="text-destructive">*</span>
            </Label>
            <Input
              id="recipientCompany"
              placeholder="Stripe"
              value={recipientCompany}
              onChange={(e) => setRecipientCompany(e.target.value)}
              className="bg-background border-border"
              required
              maxLength={100}
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="recipientRole" className="text-sm font-medium">
              Role / Title <span className="text-destructive">*</span>
            </Label>
            <Input
              id="recipientRole"
              placeholder="VP of Product"
              value={recipientRole}
              onChange={(e) => setRecipientRole(e.target.value)}
              className="bg-background border-border"
              required
              maxLength={100}
            />
          </div>
        </div>
      </section>

      {/* Purpose Section */}
      <section className="space-y-5">
        <h3 className="font-serif text-lg font-medium border-b border-border pb-2">
          Why are you reaching out?
        </h3>

        <div className="space-y-3">
          <Label className="text-sm font-medium">
            What are you asking for? <span className="text-destructive">*</span>
          </Label>
          <RadioGroup
            value={askType}
            onValueChange={(v) => setAskType(v as AskType)}
            className="space-y-2"
          >
            {ASK_TYPES.map((type) => (
              <div key={type.value} className="flex items-center space-x-3">
                <RadioGroupItem value={type.value} id={`ask-${type.value}`} />
                <Label
                  htmlFor={`ask-${type.value}`}
                  className="font-normal cursor-pointer"
                >
                  {type.label}
                </Label>
              </div>
            ))}
          </RadioGroup>
        </div>

        <div className="space-y-2">
          <Label htmlFor="reachingOutBecause" className="text-sm font-medium">
            Complete this sentence: "I'm reaching out because ___" <span className="text-destructive">*</span>
          </Label>
          <Textarea
            id="reachingOutBecause"
            placeholder="I want to learn how they built the payments team at Stripe from scratch..."
            value={reachingOutBecause}
            onChange={(e) => setReachingOutBecause(e.target.value)}
            className="bg-background border-border min-h-[80px] resize-none"
            required
            maxLength={500}
          />
        </div>
      </section>

      {/* Credibility Section */}
      <section className="space-y-5">
        <h3 className="font-serif text-lg font-medium border-b border-border pb-2">
          What makes you credible?
        </h3>
        <p className="text-sm text-muted-foreground">
          This could be a project, result, or experience that makes your outreach more compelling.
        </p>

        <div className="space-y-2">
          <Label htmlFor="credibilityStory" className="text-sm font-medium">
            One short story or accomplishment that could impress the recipient <span className="text-destructive">*</span>
          </Label>
          <Textarea
            id="credibilityStory"
            placeholder="I spent 3 years building payment infrastructure in Southeast Asia, where I helped 10,000 small merchants accept digital payments for the first time..."
            value={credibilityStory}
            onChange={(e) => setCredibilityStory(e.target.value)}
            className="bg-background border-border min-h-[100px] resize-none"
            required
            maxLength={1000}
          />
          <p className="text-xs text-muted-foreground">
            23 sentences work best
          </p>
        </div>
      </section>

      {/* Shared Background Section (Optional) */}
      <section className="space-y-5">
        <h3 className="font-serif text-lg font-medium border-b border-border pb-2">
          Any shared background?
        </h3>
        <p className="text-sm text-muted-foreground">
          If you and the recipient share a school, company, or program, this can be a powerful, natural opener.
        </p>

        <div className="space-y-3">
          <Label className="text-sm font-medium">
            Do you share any background with this person?
          </Label>
          <div className="space-y-2">
            {AFFILIATION_TYPES.map((type) => (
              <div key={type.value} className="flex items-center space-x-3">
                <Checkbox
                  id={`affiliation-${type.value}`}
                  checked={selectedAffiliationTypes.includes(type.value)}
                  onCheckedChange={() => handleAffiliationTypeToggle(type.value)}
                />
                <Label
                  htmlFor={`affiliation-${type.value}`}
                  className="font-normal cursor-pointer"
                >
                  {type.label}
                </Label>
              </div>
            ))}
          </div>
        </div>

        {hasRealAffiliationSelected && (
          <div className="space-y-5 pl-4 border-l-2 border-border">
            <div className="space-y-2">
              <Label htmlFor="affiliationName" className="text-sm font-medium">
                Shared institution or organization name <span className="text-destructive">*</span>
              </Label>
              <Input
                id="affiliationName"
                placeholder="Stanford GSB, McKinsey & Company, YC W23, Harvard College..."
                value={affiliationName}
                onChange={(e) => setAffiliationName(e.target.value)}
                className="bg-background border-border"
                required={hasRealAffiliationSelected}
                maxLength={150}
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="affiliationDetail" className="text-sm font-medium">
                Your connection to it <span className="text-muted-foreground">(optional)</span>
              </Label>
              <Input
                id="affiliationDetail"
                placeholder="MBA '24, Strategy & Ops 20192021, Class of 2018..."
                value={affiliationDetail}
                onChange={(e) => setAffiliationDetail(e.target.value)}
                className="bg-background border-border"
                maxLength={100}
              />
              <p className="text-xs text-muted-foreground">
                1 short phrase to add context
              </p>
            </div>
          </div>
        )}
      </section>

      {/* Info banner */}
      <div className="bg-muted/50 border border-border p-4 text-sm text-muted-foreground flex items-start gap-3">
        <Sparkles className="h-4 w-4 mt-0.5 shrink-0" />
        <span>We'll automatically research public information about the recipient to personalize your email.</span>
      </div>

      {/* Debug mode toggle */}
      <div className="flex items-center space-x-3 p-3 bg-muted/30 border border-border/50 rounded">
        <Checkbox
          id="debug-mode"
          checked={debugMode}
          onCheckedChange={(checked) => setDebugMode(checked === true)}
        />
        <Label
          htmlFor="debug-mode"
          className="text-sm font-mono cursor-pointer text-muted-foreground"
        >
          Enable debug mode (show trace)
        </Label>
      </div>

      <Button
        type="submit"
        disabled={isLoading || !isFormValid}
        className="w-full bg-foreground text-background font-medium h-12 text-base transition-all hover:bg-foreground/90 disabled:opacity-50 rounded-none"
      >
        {isLoading ? 'Generating...' : 'Generate Email'}
      </Button>
    </form>
  );
}
</file>

<file path="src/components/StageIndicator.tsx">
import { Check, Circle, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { Stage } from '@/hooks/useEmailGenerationProgress';

export type StageStatus = 'pending' | 'current' | 'completed';

interface StageIndicatorProps {
  stage: Stage;
  status: StageStatus;
}

export function StageIndicator({ stage, status }: StageIndicatorProps) {
  return (
    <div
      className={cn(
        'flex items-center gap-3 text-sm transition-opacity duration-300',
        status === 'pending' && 'opacity-40',
        status === 'current' && 'opacity-100',
        status === 'completed' && 'opacity-60'
      )}
    >
      {status === 'completed' && (
        <Check className="h-4 w-4 text-foreground shrink-0" />
      )}
      {status === 'current' && (
        <Loader2 className="h-4 w-4 animate-spin text-foreground shrink-0" />
      )}
      {status === 'pending' && (
        <Circle className="h-4 w-4 text-muted-foreground shrink-0" />
      )}
      <span
        className={cn(
          'font-body',
          status === 'current' && 'font-medium text-foreground',
          status === 'completed' && 'text-muted-foreground',
          status === 'pending' && 'text-muted-foreground'
        )}
      >
        {stage.label}
      </span>
    </div>
  );
}
</file>

<file path="src/components/TipsCarousel.tsx">
import { Sparkles } from 'lucide-react';
import { cn } from '@/lib/utils';

interface TipsCarouselProps {
  tips: string[];
  currentTipIndex: number;
}

export function TipsCarousel({ tips, currentTipIndex }: TipsCarouselProps) {
  if (!tips || tips.length === 0) return null;

  return (
    <div className="bg-muted/50 border border-border p-4 space-y-3">
      <div className="flex items-start gap-3">
        <Sparkles className="h-4 w-4 mt-0.5 text-muted-foreground shrink-0" />
        <div className="space-y-1 flex-1">
          <p className="text-sm font-medium">Did you know?</p>
          <p className="text-sm text-muted-foreground transition-opacity duration-300">
            {tips[currentTipIndex]}
          </p>
        </div>
      </div>

      {/* Tip pagination dots */}
      {tips.length > 1 && (
        <div className="flex gap-1.5 justify-center pt-1">
          {tips.map((_, i) => (
            <div
              key={i}
              className={cn(
                'h-1.5 w-1.5 rounded-full transition-colors duration-300',
                i === currentTipIndex ? 'bg-foreground' : 'bg-border'
              )}
            />
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/contexts/ProlificContext.tsx">
import { createContext, useContext, useState, ReactNode } from 'react';
import type { EmailResponse } from '@/lib/prompt';

interface ProlificData {
  prolificId: string;
  studyId: string;
  sessionId: string;
  profession: string;
  coldEmailFrequency: string;
  wasAutoCaptured: boolean;
}

interface ProlificContextType {
  data: ProlificData;
  updateData: (updates: Partial<ProlificData>) => void;
  currentStep: number;
  setCurrentStep: (step: number) => void;
  generatedEmail: EmailResponse | null;
  setGeneratedEmail: (email: EmailResponse | null) => void;
}

const ProlificContext = createContext<ProlificContextType | undefined>(undefined);

const STEPS = [
  { path: '/prolific', label: 'Welcome' },
  { path: '/prolific/setup', label: 'Setup' },
  { path: '/prolific/app', label: 'Task' },
  { path: '/prolific/read', label: 'Review' },
  { path: '/prolific/survey', label: 'Feedback' },
  { path: '/prolific/complete', label: 'Complete' },
];

export const PROLIFIC_STEPS = STEPS;

export function ProlificProvider({ children }: { children: ReactNode }) {
  const [data, setData] = useState<ProlificData>({
    prolificId: '',
    studyId: '',
    sessionId: '',
    profession: '',
    coldEmailFrequency: '',
    wasAutoCaptured: false,
  });
  const [currentStep, setCurrentStep] = useState(0);
  const [generatedEmail, setGeneratedEmail] = useState<EmailResponse | null>(null);

  const updateData = (updates: Partial<ProlificData>) => {
    setData(prev => ({ ...prev, ...updates }));
  };

  return (
    <ProlificContext.Provider value={{ 
      data, 
      updateData, 
      currentStep, 
      setCurrentStep,
      generatedEmail,
      setGeneratedEmail,
    }}>
      {children}
    </ProlificContext.Provider>
  );
}

export function useProlific() {
  const context = useContext(ProlificContext);
  if (!context) {
    throw new Error('useProlific must be used within a ProlificProvider');
  }
  return context;
}
</file>

<file path="src/hooks/use-mobile.tsx">
import * as React from "react";

const MOBILE_BREAKPOINT = 768;

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined);

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`);
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    };
    mql.addEventListener("change", onChange);
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    return () => mql.removeEventListener("change", onChange);
  }, []);

  return !!isMobile;
}
</file>

<file path="src/hooks/use-toast.ts">
import * as React from "react";

import type { ToastActionElement, ToastProps } from "@/components/ui/toast";

const TOAST_LIMIT = 1;
const TOAST_REMOVE_DELAY = 1000000;

type ToasterToast = ToastProps & {
  id: string;
  title?: React.ReactNode;
  description?: React.ReactNode;
  action?: ToastActionElement;
};

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const;

let count = 0;

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER;
  return count.toString();
}

type ActionType = typeof actionTypes;

type Action =
  | {
      type: ActionType["ADD_TOAST"];
      toast: ToasterToast;
    }
  | {
      type: ActionType["UPDATE_TOAST"];
      toast: Partial<ToasterToast>;
    }
  | {
      type: ActionType["DISMISS_TOAST"];
      toastId?: ToasterToast["id"];
    }
  | {
      type: ActionType["REMOVE_TOAST"];
      toastId?: ToasterToast["id"];
    };

interface State {
  toasts: ToasterToast[];
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>();

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return;
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId);
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    });
  }, TOAST_REMOVE_DELAY);

  toastTimeouts.set(toastId, timeout);
};

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      };

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) => (t.id === action.toast.id ? { ...t, ...action.toast } : t)),
      };

    case "DISMISS_TOAST": {
      const { toastId } = action;

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId);
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id);
        });
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t,
        ),
      };
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        };
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      };
  }
};

const listeners: Array<(state: State) => void> = [];

let memoryState: State = { toasts: [] };

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action);
  listeners.forEach((listener) => {
    listener(memoryState);
  });
}

type Toast = Omit<ToasterToast, "id">;

function toast({ ...props }: Toast) {
  const id = genId();

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    });
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id });

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss();
      },
    },
  });

  return {
    id: id,
    dismiss,
    update,
  };
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState);

  React.useEffect(() => {
    listeners.push(setState);
    return () => {
      const index = listeners.indexOf(setState);
      if (index > -1) {
        listeners.splice(index, 1);
      }
    };
  }, [state]);

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  };
}

export { useToast, toast };
</file>

<file path="src/hooks/useEmailGenerationProgress.ts">
import { useState, useEffect, useMemo } from 'react';

export interface Stage {
  id: string;
  label: string;
  description: string;
  estimatedDuration: number; // milliseconds
  tips?: string[];
}

export const GENERATION_STAGES: Stage[] = [
  {
    id: 'identity',
    label: 'Confirming identity',
    description: 'Searching for {recipientName} at {recipientCompany}',
    estimatedDuration: 10000,
    tips: ['We verify the recipient exists before researching', 'This prevents wasted effort on incorrect names']
  },
  {
    id: 'scan',
    label: 'Scanning public sources',
    description: 'LinkedIn, interviews, articles, podcasts',
    estimatedDuration: 10000,
    tips: ['Looking across 10+ public data sources', 'We prioritize recent content (last 2 years)']
  },
  {
    id: 'research',
    label: 'Finding specific hooks',
    description: 'Looking for quotes, projects, and insights',
    estimatedDuration: 30000,
    tips: [
      'Best emails reference specific facts, not generic achievements',
      'We look for named projects, quotes, and decisions',
      'This is the most time-intensive step'
    ]
  },
  {
    id: 'synthesis',
    label: 'Analyzing research findings',
    description: 'Extracting 2-3 personalization hooks',
    estimatedDuration: 20000,
    tips: ['Scoring each finding by relevance to your purpose', 'Only the top 2 hooks make it into your email']
  },
  {
    id: 'drafting',
    label: 'Drafting your email',
    description: 'Writing "Like you," connection',
    estimatedDuration: 15000,
    tips: ['Creating a natural bridge between your story and theirs', 'Aiming for 80-120 words (readable in 20 seconds)']
  },
  {
    id: 'polish',
    label: 'Polishing the final draft',
    description: 'Checking tone and format',
    estimatedDuration: 5000,
    tips: ['Validating against 15+ quality rules', 'Ensuring "Like you," appears exactly once']
  }
];

const TOTAL_ESTIMATED_DURATION = GENERATION_STAGES.reduce((sum, stage) => sum + stage.estimatedDuration, 0);

function getProgressMultiplier(stageIndex: number, stageProgressPercent: number): number {
  // Speed up early stages (builds confidence)
  if (stageIndex <= 1) return 1.3;

  // Slow down Stage 2 (research: 20-50s) but show continuous movement
  if (stageIndex === 2) {
    // Faster in first 30% and last 20% of stage
    if (stageProgressPercent < 30 || stageProgressPercent > 80) return 1.1;
    return 0.8; // Slower in middle, but still moving
  }

  // Speed up final stages (creates anticipation)
  if (stageIndex >= 4) return 1.4;

  return 1.0;
}

export function useEmailGenerationProgress() {
  const [elapsedTime, setElapsedTime] = useState(0);
  const [currentTipIndex, setCurrentTipIndex] = useState(0);

  // Timer - increments every 100ms
  useEffect(() => {
    const timer = setInterval(() => {
      setElapsedTime((prev) => prev + 100);
    }, 100);

    return () => clearInterval(timer);
  }, []);

  // Calculate which stage we're in based on elapsed time
  const { currentStageIndex, stageStartTime } = useMemo(() => {
    let cumulativeTime = 0;
    let adjustedElapsed = elapsedTime;

    // Apply multipliers retroactively
    for (let i = 0; i < GENERATION_STAGES.length; i++) {
      const stage = GENERATION_STAGES[i];
      const multiplier = getProgressMultiplier(i, 50); // Use mid-point multiplier for calculation
      const adjustedDuration = stage.estimatedDuration / multiplier;

      if (adjustedElapsed < adjustedDuration) {
        return {
          currentStageIndex: i,
          stageStartTime: cumulativeTime
        };
      }

      cumulativeTime += stage.estimatedDuration;
      adjustedElapsed -= adjustedDuration;
    }

    // If we've exceeded all stages, stay on last stage
    return {
      currentStageIndex: GENERATION_STAGES.length - 1,
      stageStartTime: TOTAL_ESTIMATED_DURATION - GENERATION_STAGES[GENERATION_STAGES.length - 1].estimatedDuration
    };
  }, [elapsedTime]);

  const currentStage = GENERATION_STAGES[currentStageIndex];

  // Calculate progress within current stage
  const stageProgress = useMemo(() => {
    const stageElapsed = elapsedTime - stageStartTime;
    const multiplier = getProgressMultiplier(currentStageIndex, 50);
    const adjustedDuration = currentStage.estimatedDuration / multiplier;
    const progress = Math.min((stageElapsed / adjustedDuration) * 100, 100);
    return progress;
  }, [elapsedTime, stageStartTime, currentStage.estimatedDuration, currentStageIndex]);

  // Calculate total progress (capped at 99% until real completion)
  const totalProgress = useMemo(() => {
    let cumulativeProgress = 0;

    for (let i = 0; i < currentStageIndex; i++) {
      const weight = GENERATION_STAGES[i].estimatedDuration / TOTAL_ESTIMATED_DURATION;
      cumulativeProgress += weight * 100;
    }

    const currentWeight = currentStage.estimatedDuration / TOTAL_ESTIMATED_DURATION;
    cumulativeProgress += (stageProgress / 100) * currentWeight * 100;

    // Cap at 99% to avoid showing 100% before actual completion
    return Math.min(cumulativeProgress, 99);
  }, [currentStageIndex, currentStage.estimatedDuration, stageProgress]);

  // Rotate tips for current stage
  useEffect(() => {
    if (!currentStage.tips || currentStage.tips.length <= 1) return;

    const interval = setInterval(() => {
      setCurrentTipIndex((prev) => (prev + 1) % (currentStage.tips?.length || 1));
    }, 8000); // Change tip every 8 seconds

    return () => clearInterval(interval);
  }, [currentStage.id, currentStage.tips]);

  // Reset tip index when stage changes
  useEffect(() => {
    setCurrentTipIndex(0);
  }, [currentStage.id]);

  const currentTip = currentStage.tips?.[currentTipIndex];

  return {
    currentStage,
    currentStageIndex,
    stageProgress,
    totalProgress,
    elapsedTime,
    currentTip,
    currentTipIndex,
    allStages: GENERATION_STAGES
  };
}
</file>

<file path="src/integrations/supabase/client.ts">
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
  }
});
</file>

<file path="src/integrations/supabase/types.ts">
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "14.1"
  }
  public: {
    Tables: {
      email_generations: {
        Row: {
          body: string
          cliche_count: number | null
          created_at: string
          enforcement_results: Json | null
          exa_queries: Json | null
          exa_results: Json | null
          has_em_dash: boolean | null
          id: string
          input_json: Json
          latency_ms: number | null
          like_you_count: number | null
          model_name: string
          prompt_version: string
          research_model_name: string | null
          researched_facts: Json | null
          scenario_name: string | null
          selected_sources: Json | null
          session_id: string | null
          source: string
          subject: string | null
          user_id: string | null
          validator_errors: Json | null
          validator_passed: boolean | null
          word_count: number | null
        }
        Insert: {
          body: string
          cliche_count?: number | null
          created_at?: string
          enforcement_results?: Json | null
          exa_queries?: Json | null
          exa_results?: Json | null
          has_em_dash?: boolean | null
          id?: string
          input_json: Json
          latency_ms?: number | null
          like_you_count?: number | null
          model_name: string
          prompt_version: string
          research_model_name?: string | null
          researched_facts?: Json | null
          scenario_name?: string | null
          selected_sources?: Json | null
          session_id?: string | null
          source?: string
          subject?: string | null
          user_id?: string | null
          validator_errors?: Json | null
          validator_passed?: boolean | null
          word_count?: number | null
        }
        Update: {
          body?: string
          cliche_count?: number | null
          created_at?: string
          enforcement_results?: Json | null
          exa_queries?: Json | null
          exa_results?: Json | null
          has_em_dash?: boolean | null
          id?: string
          input_json?: Json
          latency_ms?: number | null
          like_you_count?: number | null
          model_name?: string
          prompt_version?: string
          research_model_name?: string | null
          researched_facts?: Json | null
          scenario_name?: string | null
          selected_sources?: Json | null
          session_id?: string | null
          source?: string
          subject?: string | null
          user_id?: string | null
          validator_errors?: Json | null
          validator_passed?: boolean | null
          word_count?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "email_generations_session_id_fkey"
            columns: ["session_id"]
            isOneToOne: false
            referencedRelation: "prolific_sessions"
            referencedColumns: ["id"]
          },
        ]
      }
      prolific_post_survey: {
        Row: {
          changes_before_sending: Json | null
          comparison_rating: number | null
          created_at: string
          id: string
          likelihood_change: string | null
          likelihood_reasons: Json | null
          most_useful_part: string | null
          session_id: string
          what_felt_off: string | null
          whats_missing: string | null
        }
        Insert: {
          changes_before_sending?: Json | null
          comparison_rating?: number | null
          created_at?: string
          id?: string
          likelihood_change?: string | null
          likelihood_reasons?: Json | null
          most_useful_part?: string | null
          session_id: string
          what_felt_off?: string | null
          whats_missing?: string | null
        }
        Update: {
          changes_before_sending?: Json | null
          comparison_rating?: number | null
          created_at?: string
          id?: string
          likelihood_change?: string | null
          likelihood_reasons?: Json | null
          most_useful_part?: string | null
          session_id?: string
          what_felt_off?: string | null
          whats_missing?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "prolific_post_survey_session_id_fkey"
            columns: ["session_id"]
            isOneToOne: false
            referencedRelation: "prolific_sessions"
            referencedColumns: ["id"]
          },
        ]
      }
      prolific_sessions: {
        Row: {
          cold_email_frequency: string
          completed_at: string | null
          created_at: string
          id: string
          profession: string
          prolific_id: string
          prolific_session_id: string | null
          study_id: string | null
        }
        Insert: {
          cold_email_frequency: string
          completed_at?: string | null
          created_at?: string
          id?: string
          profession: string
          prolific_id: string
          prolific_session_id?: string | null
          study_id?: string | null
        }
        Update: {
          cold_email_frequency?: string
          completed_at?: string | null
          created_at?: string
          id?: string
          profession?: string
          prolific_id?: string
          prolific_session_id?: string | null
          study_id?: string | null
        }
        Relationships: []
      }
      prolific_step_tracking: {
        Row: {
          created_at: string
          event_data: Json | null
          event_type: string
          id: string
          prolific_id: string
          session_id: string | null
          step_name: string
          step_number: number
        }
        Insert: {
          created_at?: string
          event_data?: Json | null
          event_type: string
          id?: string
          prolific_id: string
          session_id?: string | null
          step_name: string
          step_number: number
        }
        Update: {
          created_at?: string
          event_data?: Json | null
          event_type?: string
          id?: string
          prolific_id?: string
          session_id?: string | null
          step_name?: string
          step_number?: number
        }
        Relationships: [
          {
            foreignKeyName: "prolific_step_tracking_session_id_fkey"
            columns: ["session_id"]
            isOneToOne: false
            referencedRelation: "prolific_sessions"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      [_ in never]: never
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {},
  },
} as const
</file>

<file path="src/lib/prompt.ts">
export type AskType = 'chat' | 'feedback' | 'referral' | 'job' | 'other';

export type SharedAffiliationType = 
  | 'none'
  | 'school'
  | 'business_school'
  | 'company'
  | 'accelerator'
  | 'personal_characteristics'
  | 'other';

export interface SharedAffiliation {
  types: SharedAffiliationType[];
  name: string;
  detail?: string;
}

export interface EmailRequest {
  // Recipient info
  recipientName: string;
  recipientCompany: string;
  recipientRole: string;
  
  // Purpose
  askType: AskType;
  reachingOutBecause: string;
  
  // Credibility
  credibilityStory: string;
  
  // Shared affiliation (optional)
  sharedAffiliation?: SharedAffiliation;
}

export interface EmailResponse {
  subject: string;
  body: string;
}

// ============= V2 Hook Pack Types =============

// Bridge angle for "Like you" connections
export type BridgeAngle = 'domain' | 'value' | 'tradeoff' | 'artifact' | 'inflection' | 'shared-affiliation';

// V2 Hook Pack (replaces HookFact as primary output)
export interface HookPack {
  hook_fact: {
    claim: string;
    source_url: string;
    evidence: string;
  };
  bridge: {
    bridge_angle: BridgeAngle;
    why_relevant: string;
    like_you_ingredients: {
      shared_action: string;
      shared_axis: string;
      shared_stakes: string;
    };
  };
  scores: {
    identity_conf: number;
    non_generic: number;
    bridgeability: number;
    intent_fit: number;
    overall: number;
  };
}

// Identity fingerprint for disambiguation
export interface IdentityFingerprint {
  canonical_name: string;
  company: string;
  role_keywords: string[];
  disambiguators: string[];  // product areas, prior companies, geography, business units
  confounders: { name: string; negative_keywords: string[] }[];
}

// Bridge hypothesis for bridge-first search
export interface BridgeHypothesis {
  type: 'domain' | 'value' | 'tradeoff';
  keywords: string[];
  query_templates: string[];
  proof_target: string;
}

// Legacy V1 Hook Fact (kept for backward compatibility)
export interface HookFact {
  claim: string;
  source_url: string;
  evidence_quote: string;
  why_relevant: string;
  bridge_type: 'intent' | 'credibility' | 'curiosity';
  hook_score: number;
}

// V2 Exa Result structure
export interface ExaResult {
  url: string;
  title: string;
  snippet: string;
}

// V2 Enforcement Results
export interface EnforcementResults {
  did_retry: boolean;
  failures_first_pass: string[];
  failures_retry: string[];
}

// V2 Extended Response
export interface ResearchedEmailResponse extends EmailResponse {
  // V2 Hook Packs (primary output)
  hookPacks?: HookPack[];
  
  // Research data
  exaQueries?: string[];
  exaResults?: ExaResult[];
  selectedSources?: string[];
  
  // Legacy compatibility (V1)
  hookFacts?: HookFact[];
  researchedFacts?: string[];
  
  // Enforcement
  enforcementResults?: EnforcementResults;
  
  // Validation
  validatorPassed?: boolean;
  validatorErrors?: string[] | null;
  
  // Metrics
  likeYouCount?: number;
  wordCount?: number;
  clicheCount?: number;
  retryUsed?: boolean;
  
  // Debug (test harness only)
  debug?: {
    // V2 debug fields
    identityFingerprint?: IdentityFingerprint;
    bridgeHypotheses?: BridgeHypothesis[];
    candidateUrls?: { url: string; title: string; passed_niche_gate: boolean; reasons: string[] }[];
    
    // V1 legacy fields (kept for compatibility)
    queryPlan?: any;
    queriesUsed?: string[];
    urlScores?: any[];
    urlsFetched?: string[];
    factRejectionReasons?: string[];
    notes?: string;
    identityAnchor?: {
      confirmed: boolean;
      identityUrls: string[];
      identityScores: any[];
      notes?: string;
    };
  };
}
</file>

<file path="src/lib/utils.ts">
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="src/pages/prolific/ProlificApp.tsx">
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ProlificLayout } from '@/components/prolific/ProlificLayout';
import { Button } from '@/components/ui/button';
import { useProlific } from '@/contexts/ProlificContext';
import { ResearchEmailForm } from '@/components/ResearchEmailForm';
import { EmailResult } from '@/components/EmailResult';
import { supabase } from '@/integrations/supabase/client';
import type { EmailRequest } from '@/lib/prompt';
import { useToast } from '@/hooks/use-toast';

const SESSION_STORAGE_KEY = 'prolific_session_id';

export default function ProlificApp() {
  const navigate = useNavigate();
  const { data, setCurrentStep, setGeneratedEmail, generatedEmail } = useProlific();
  const { toast } = useToast();
  const [localEmail, setLocalEmail] = useState(generatedEmail);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    setCurrentStep(2);
    if (!data.prolificId || !data.profession) {
      navigate('/prolific');
    }
    // Verify session exists
    const sessionId = localStorage.getItem(SESSION_STORAGE_KEY);
    if (!sessionId) {
      navigate('/prolific/setup');
    }
  }, [data, navigate, setCurrentStep]);

  const handleSubmit = async (request: EmailRequest) => {
    const sessionId = localStorage.getItem(SESSION_STORAGE_KEY);
    if (!sessionId) {
      toast({
        title: 'Session Error',
        description: 'Session not found. Please restart the study.',
        variant: 'destructive',
      });
      navigate('/prolific');
      return;
    }

    setIsLoading(true);
    try {
      const { data: responseData, error } = await supabase.functions.invoke('log-email-generation', {
        body: {
          sessionId,
          ...request,
        },
      });

      if (error) throw error;

      const email = {
        subject: responseData.subject,
        body: responseData.body,
      };
      
      setLocalEmail(email);
      setGeneratedEmail(email);
    } catch (error) {
      console.error('Error generating email:', error);
      toast({
        title: 'Error',
        description: 'Failed to generate email. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsLoading(false);
    }
  };

  const handleContinue = () => {
    navigate('/prolific/read');
  };

  return (
    <ProlificLayout>
      <div className="space-y-8">
        <div className="text-center space-y-3">
          <h1 className="text-3xl font-serif font-semibold text-foreground">
            Describe Your Cold Email
          </h1>
          <p className="text-muted-foreground max-w-xl mx-auto">
            Tell us about a real person you want to email and why. The AI will research 
            public information about them and draft a personalized cold email.
          </p>
        </div>

        <div className="bg-card border border-border rounded-sm p-6">
          <ResearchEmailForm onSubmit={handleSubmit} isLoading={isLoading} />
        </div>

        {localEmail && (
          <div className="bg-card border border-border rounded-sm p-6">
            <EmailResult result={localEmail} />
          </div>
        )}

        {localEmail && (
          <div className="flex justify-center pt-4">
            <Button onClick={handleContinue} size="lg" className="min-w-[200px]">
              Continue to Review
            </Button>
          </div>
        )}
      </div>
    </ProlificLayout>
  );
}
</file>

<file path="src/pages/prolific/ProlificComplete.tsx">
import { useEffect } from 'react';
import { ProlificLayout } from '@/components/prolific/ProlificLayout';
import { Button } from '@/components/ui/button';
import { useProlific } from '@/contexts/ProlificContext';
import { CheckCircle, ExternalLink } from 'lucide-react';

export default function ProlificComplete() {
  const { setCurrentStep } = useProlific();

  useEffect(() => {
    setCurrentStep(5);
  }, [setCurrentStep]);

  // Replace with your actual Prolific completion URL
  const completionUrl = 'https://app.prolific.com/submissions/complete?cc=XXXXXXX';

  return (
    <ProlificLayout>
      <div className="space-y-8">
        <div className="text-center space-y-4">
          <div className="flex justify-center">
            <CheckCircle className="w-16 h-16 text-green-600" />
          </div>
          <h1 className="text-3xl font-serif font-semibold text-foreground">
            Study Complete
          </h1>
          <p className="text-muted-foreground max-w-xl mx-auto">
            Thank you for participating in our research study. Your feedback 
            is invaluable in helping us improve AI-powered writing tools.
          </p>
        </div>

        <div className="bg-card border border-border rounded-sm p-6 space-y-6">
          <div className="space-y-4">
            <h2 className="font-serif text-lg font-medium text-center">
              Complete Your Submission
            </h2>
            <p className="text-sm text-muted-foreground text-center">
              Please click the button below to return to Prolific and confirm your submission.
            </p>
          </div>

          <div className="flex justify-center">
            <Button asChild size="lg" className="min-w-[250px]">
              <a href={completionUrl} target="_blank" rel="noopener noreferrer">
                Return to Prolific
                <ExternalLink className="w-4 h-4 ml-2" />
              </a>
            </Button>
          </div>

          <div className="border-t border-border pt-4">
            <p className="text-xs text-muted-foreground text-center">
              If the button doesn't work, copy this completion code: <code className="bg-muted px-1.5 py-0.5 rounded">XXXXXXX</code>
            </p>
          </div>
        </div>

        <div className="text-center">
          <p className="text-sm text-muted-foreground">
            Questions? Contact us at <span className="text-foreground">research@example.com</span>
          </p>
        </div>
      </div>
    </ProlificLayout>
  );
}
</file>

<file path="src/pages/prolific/ProlificRead.tsx">
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ProlificLayout } from '@/components/prolific/ProlificLayout';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import { useProlific } from '@/contexts/ProlificContext';

export default function ProlificRead() {
  const navigate = useNavigate();
  const { data, setCurrentStep, generatedEmail } = useProlific();
  const [hasConfirmed, setHasConfirmed] = useState(false);

  useEffect(() => {
    setCurrentStep(3);
    if (!data.prolificId) {
      navigate('/prolific');
    }
    if (!generatedEmail) {
      navigate('/prolific/app');
    }
  }, [data.prolificId, generatedEmail, navigate, setCurrentStep]);

  const handleContinue = () => {
    navigate('/prolific/survey');
  };

  const handleBack = () => {
    navigate('/prolific/app');
  };

  if (!generatedEmail) {
    return null;
  }

  return (
    <ProlificLayout>
      <div className="space-y-8">
        <div className="text-center space-y-3">
          <h1 className="text-3xl font-serif font-semibold text-foreground">
            Review the Generated Email
          </h1>
          <p className="text-muted-foreground max-w-xl mx-auto">
            Please read the email below carefully. Imagine whether you would actually send it.
          </p>
        </div>

        {/* Generated Email Display */}
        <div className="bg-card border border-border rounded-sm p-6 space-y-4">
          <div className="space-y-1">
            <p className="text-sm text-muted-foreground">Subject</p>
            <p className="font-medium text-foreground">{generatedEmail.subject}</p>
          </div>
          <div className="border-t border-border pt-4 space-y-1">
            <p className="text-sm text-muted-foreground">Body</p>
            <div className="whitespace-pre-wrap text-foreground leading-relaxed">
              {generatedEmail.body}
            </div>
          </div>
        </div>

        {/* Evaluation prompts */}
        <div className="bg-muted/30 border border-border rounded-sm p-6 space-y-6">
          <div className="space-y-4">
            <h2 className="font-serif text-lg font-medium">As you read, consider:</h2>
            <ul className="space-y-3 text-sm text-muted-foreground">
              <li className="flex items-start gap-3">
                <span className="w-1.5 h-1.5 rounded-full bg-primary mt-2 flex-shrink-0" />
                <span>Does the email reference specific, accurate details about the recipient?</span>
              </li>
              <li className="flex items-start gap-3">
                <span className="w-1.5 h-1.5 rounded-full bg-primary mt-2 flex-shrink-0" />
                <span>Does it sound like something you would write?</span>
              </li>
              <li className="flex items-start gap-3">
                <span className="w-1.5 h-1.5 rounded-full bg-primary mt-2 flex-shrink-0" />
                <span>Would you feel comfortable sending this email as-is?</span>
              </li>
              <li className="flex items-start gap-3">
                <span className="w-1.5 h-1.5 rounded-full bg-primary mt-2 flex-shrink-0" />
                <span>How does this compare to cold emails you usually write?</span>
              </li>
            </ul>
          </div>

          <div className="border-t border-border pt-4">
            <div className="flex items-start space-x-3">
              <Checkbox
                id="confirm-read"
                checked={hasConfirmed}
                onCheckedChange={(checked) => setHasConfirmed(checked === true)}
              />
              <Label 
                htmlFor="confirm-read" 
                className="text-sm font-normal cursor-pointer leading-relaxed"
              >
                I have read the email and considered whether I would send it.
              </Label>
            </div>
          </div>
        </div>

        <div className="flex justify-between">
          <Button variant="outline" onClick={handleBack}>
            Back to Email
          </Button>
          <Button 
            onClick={handleContinue} 
            disabled={!hasConfirmed}
            size="lg" 
            className="min-w-[150px]"
          >
            Continue to Survey
          </Button>
        </div>
      </div>
    </ProlificLayout>
  );
}
</file>

<file path="src/pages/prolific/ProlificSetup.tsx">
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ProlificLayout } from '@/components/prolific/ProlificLayout';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { useProlific } from '@/contexts/ProlificContext';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';

const FREQUENCY_OPTIONS = [
  { value: 'never', label: 'Never' },
  { value: 'rarely', label: 'Rarely (a few per year)' },
  { value: 'occasionally', label: 'Occasionally (a few per month)' },
  { value: 'regularly', label: 'Regularly (weekly)' },
  { value: 'frequently', label: 'Frequently (daily)' },
];

const SESSION_STORAGE_KEY = 'prolific_session_id';

export default function ProlificSetup() {
  const navigate = useNavigate();
  const { data, updateData, setCurrentStep } = useProlific();
  const { toast } = useToast();
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    setCurrentStep(1);
    // Redirect if no prolific ID
    if (!data.prolificId) {
      navigate('/prolific');
    }
  }, [data.prolificId, navigate, setCurrentStep]);

  const isValid = data.profession.trim() && data.coldEmailFrequency;

  const handleContinue = async () => {
    if (!isValid || isSubmitting) return;

    setIsSubmitting(true);
    try {
      const { data: responseData, error } = await supabase.functions.invoke('create-prolific-session', {
        body: {
          prolificId: data.prolificId,
          studyId: data.studyId,
          prolificSessionId: data.sessionId,
          profession: data.profession,
          coldEmailFrequency: data.coldEmailFrequency,
        },
      });

      if (error) throw error;

      if (!responseData?.sessionId) {
        throw new Error('No session ID returned');
      }

      // Store session ID in localStorage
      localStorage.setItem(SESSION_STORAGE_KEY, responseData.sessionId);
      
      navigate('/prolific/app');
    } catch (error) {
      console.error('Error creating session:', error);
      toast({
        title: 'Error',
        description: 'Failed to start session. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleBack = () => {
    navigate('/prolific');
  };

  return (
    <ProlificLayout>
      <div className="space-y-8">
        <div className="text-center space-y-3">
          <h1 className="text-3xl font-serif font-semibold text-foreground">
            About You
          </h1>
          <p className="text-muted-foreground max-w-xl mx-auto">
            Please tell us a bit about your background. This helps us understand 
            how different people use email outreach tools.
          </p>
        </div>

        <div className="bg-card border border-border rounded-sm p-6 space-y-8">
          <div className="space-y-3">
            <Label htmlFor="profession">What is your profession or field of work?</Label>
            <Input
              id="profession"
              value={data.profession}
              onChange={(e) => updateData({ profession: e.target.value })}
              placeholder="e.g., MBA Student, Sales Manager, Recruiter"
              className="max-w-md"
            />
          </div>

          <div className="space-y-4">
            <Label>How often do you write cold outreach emails?</Label>
            <RadioGroup
              value={data.coldEmailFrequency}
              onValueChange={(value) => updateData({ coldEmailFrequency: value })}
              className="space-y-3"
            >
              {FREQUENCY_OPTIONS.map((option) => (
                <div key={option.value} className="flex items-center space-x-3">
                  <RadioGroupItem value={option.value} id={option.value} />
                  <Label
                    htmlFor={option.value}
                    className="font-normal cursor-pointer"
                  >
                    {option.label}
                  </Label>
                </div>
              ))}
            </RadioGroup>
          </div>
        </div>

        <div className="flex justify-between">
          <Button variant="outline" onClick={handleBack}>
            Back
          </Button>
          <Button
            onClick={handleContinue}
            disabled={!isValid || isSubmitting}
            size="lg"
            className="min-w-[150px]"
          >
            {isSubmitting ? 'Starting...' : 'Continue'}
          </Button>
        </div>
      </div>
    </ProlificLayout>
  );
}
</file>

<file path="src/pages/prolific/ProlificSurvey.tsx">
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ProlificLayout } from '@/components/prolific/ProlificLayout';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import { useProlific } from '@/contexts/ProlificContext';
import { supabase } from '@/integrations/supabase/client';
import { useToast } from '@/hooks/use-toast';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Copy, Check } from 'lucide-react';

const PROLIFIC_COMPLETION_CODE = 'CYR4O8BL';
const PROLIFIC_COMPLETION_URL = 'https://app.prolific.com/submissions/complete?cc=CYR4O8BL';

// Q1: Comparison to usual emails
const COMPARISON_OPTIONS = [
  { value: '1', label: 'Much worse' },
  { value: '2', label: 'Somewhat worse' },
  { value: '3', label: 'About the same' },
  { value: '4', label: 'Somewhat better' },
  { value: '5', label: 'Much better' },
];

// Q2: Would this make you more likely to send cold emails?
const LIKELIHOOD_OPTIONS = [
  { value: 'significantly_more', label: 'Yes, significantly more likely' },
  { value: 'somewhat_more', label: 'Yes, somewhat more likely' },
  { value: 'no_change', label: 'No change' },
  { value: 'less_likely', label: 'Less likely' },
];

// Q3: Why would this make you more likely? (select up to 2)
const LIKELIHOOD_REASONS = [
  { value: 'lower_effort', label: 'It lowers the mental effort to get started' },
  { value: 'personalize', label: 'It helps me personalize without overthinking' },
  { value: 'strong_opening', label: "It gives me a strong opening I wouldn't write myself" },
  { value: 'frame_story', label: 'It helps me frame my story clearly' },
  { value: 'natural_ask', label: 'It makes the ask feel more natural' },
];

// Q4: What would you change before sending?
const CHANGE_OPTIONS = [
  { value: 'nothing', label: "Nothing  I'd send it as-is" },
  { value: 'opening', label: 'Change the opening' },
  { value: 'more_specific', label: 'Make it more specific' },
  { value: 'tone', label: 'Adjust the tone' },
  { value: 'ask', label: 'Change the ask' },
  { value: 'shorten', label: 'Shorten it' },
  { value: 'sound_like_me', label: 'Make it sound more like me' },
  { value: 'wouldnt_send', label: "I wouldn't send this even with changes" },
];

// Q6: Most useful part
const USEFUL_PART_OPTIONS = [
  { value: 'research', label: 'Researching the recipient for me' },
  { value: 'structure', label: 'The structure of the cold email' },
  { value: 'connection', label: 'How it connected my story to the recipient' },
  { value: 'ask_framing', label: 'The way it framed the ask' },
  { value: 'flow', label: 'The overall flow showing how a good cold email should be written' },
  { value: 'none', label: 'None of the above' },
];

const SESSION_STORAGE_KEY = 'prolific_session_id';

export default function ProlificSurvey() {
  const navigate = useNavigate();
  const { data, setCurrentStep, setGeneratedEmail, generatedEmail } = useProlific();
  const { toast } = useToast();
  
  // Completion dialog state
  const [showCompletionDialog, setShowCompletionDialog] = useState(false);
  const [codeCopied, setCodeCopied] = useState(false);
  
  // Q1
  const [comparisonRating, setComparisonRating] = useState('');
  // Q2
  const [likelihoodChange, setLikelihoodChange] = useState('');
  // Q3 - up to 2 selections
  const [likelihoodReasons, setLikelihoodReasons] = useState<string[]>([]);
  const [likelihoodOther, setLikelihoodOther] = useState('');
  // Q4 - multiple selections
  const [changesBeforeSending, setChangesBeforeSending] = useState<string[]>([]);
  // Q5
  const [whatFeltOff, setWhatFeltOff] = useState('');
  // Q6
  const [mostUsefulPart, setMostUsefulPart] = useState('');
  // Q7
  const [whatsMissing, setWhatsMissing] = useState('');
  
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    setCurrentStep(4);
    if (!data.prolificId) {
      navigate('/prolific');
    }
  }, [data.prolificId, navigate, setCurrentStep]);

  const showQ3 = likelihoodChange === 'significantly_more' || likelihoodChange === 'somewhat_more';
  
  const isValid = comparisonRating && likelihoodChange && changesBeforeSending.length > 0 && mostUsefulPart;

  const handleLikelihoodReasonToggle = (value: string) => {
    setLikelihoodReasons(prev => {
      if (prev.includes(value)) {
        return prev.filter(v => v !== value);
      }
      if (prev.length >= 2) {
        return prev;
      }
      return [...prev, value];
    });
  };

  const handleChangeToggle = (value: string) => {
    setChangesBeforeSending(prev => {
      if (prev.includes(value)) {
        return prev.filter(v => v !== value);
      }
      // If selecting "nothing" or "wouldnt_send", clear others
      if (value === 'nothing' || value === 'wouldnt_send') {
        return [value];
      }
      // If selecting something else, remove "nothing" and "wouldnt_send"
      const filtered = prev.filter(v => v !== 'nothing' && v !== 'wouldnt_send');
      return [...filtered, value];
    });
  };

  const handleSubmit = async () => {
    if (!isValid || isSubmitting) return;

    const sessionId = localStorage.getItem(SESSION_STORAGE_KEY);
    if (!sessionId) {
      toast({
        title: 'Session Error',
        description: 'Session not found. Please restart the study.',
        variant: 'destructive',
      });
      navigate('/prolific');
      return;
    }

    setIsSubmitting(true);
    try {
      // Build likelihood reasons with "other" if provided
      const finalLikelihoodReasons = showQ3 
        ? [...likelihoodReasons, ...(likelihoodOther.trim() ? [`other: ${likelihoodOther.trim()}`] : [])]
        : null;

      const { error } = await supabase.functions.invoke('submit-prolific-survey', {
        body: {
          sessionId,
          comparisonRating: parseInt(comparisonRating, 10),
          likelihoodChange,
          likelihoodReasons: finalLikelihoodReasons,
          changesBeforeSending,
          whatFeltOff: whatFeltOff.trim() || null,
          mostUsefulPart,
          whatsMissing: whatsMissing.trim() || null,
        },
      });

      if (error) throw error;

      localStorage.removeItem(SESSION_STORAGE_KEY);
      setGeneratedEmail(null);
      
      // If user came from Prolific (auto-captured), show completion code dialog
      if (data.wasAutoCaptured) {
        setShowCompletionDialog(true);
      } else {
        navigate('/prolific/complete');
      }
    } catch (error) {
      console.error('Error submitting survey:', error);
      toast({
        title: 'Error',
        description: 'Failed to submit survey. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleCopyCode = async () => {
    try {
      await navigator.clipboard.writeText(PROLIFIC_COMPLETION_CODE);
      setCodeCopied(true);
      setTimeout(() => setCodeCopied(false), 2000);
    } catch {
      toast({
        title: 'Copy failed',
        description: 'Please copy the code manually.',
        variant: 'destructive',
      });
    }
  };

  const handleProlificRedirect = () => {
    window.location.href = PROLIFIC_COMPLETION_URL;
  };

  const handleBack = () => {
    navigate('/prolific/read');
  };

  return (
    <ProlificLayout>
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Left side: Generated email */}
        <div className="space-y-4">
          <h2 className="text-xl font-semibold text-foreground">Generated Email</h2>
          {generatedEmail ? (
            <div className="bg-card border border-border rounded-sm p-6 space-y-4 sticky top-4">
              <div>
                <p className="text-sm text-muted-foreground mb-1">Subject</p>
                <p className="font-medium text-foreground">{generatedEmail.subject}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground mb-1">Body</p>
                <div className="whitespace-pre-wrap text-foreground text-sm leading-relaxed">
                  {generatedEmail.body}
                </div>
              </div>
            </div>
          ) : (
            <div className="bg-card border border-border rounded-sm p-6 text-muted-foreground">
              No email generated yet.
            </div>
          )}
        </div>

        {/* Right side: Survey questions */}
        <div className="space-y-8">
          <div className="text-center space-y-3 lg:text-left">
            <h1 className="text-3xl font-serif font-semibold text-foreground">
              Your Feedback
            </h1>
            <p className="text-muted-foreground">
              Please share your thoughts on the generated email.
            </p>
          </div>

          <div className="bg-card border border-border rounded-sm p-6 space-y-8">
            {/* Q1: Comparison */}
            <div className="space-y-4">
              <Label className="text-base font-medium">
                Q1. Compared to cold emails you usually write, how was this email?
              </Label>
              <RadioGroup
                value={comparisonRating}
                onValueChange={setComparisonRating}
                className="space-y-2"
              >
                {COMPARISON_OPTIONS.map((option) => (
                  <div key={option.value} className="flex items-center space-x-3">
                    <RadioGroupItem value={option.value} id={`comparison-${option.value}`} />
                    <Label
                      htmlFor={`comparison-${option.value}`}
                      className="font-normal cursor-pointer"
                    >
                      {option.label}
                    </Label>
                  </div>
                ))}
              </RadioGroup>
            </div>

            {/* Q2: Likelihood change */}
            <div className="space-y-4">
              <Label className="text-base font-medium">
                Q2. Would using a tool like this make you more likely to send cold emails?
              </Label>
              <RadioGroup
                value={likelihoodChange}
                onValueChange={setLikelihoodChange}
                className="space-y-2"
              >
                {LIKELIHOOD_OPTIONS.map((option) => (
                  <div key={option.value} className="flex items-center space-x-3">
                    <RadioGroupItem value={option.value} id={`likelihood-${option.value}`} />
                    <Label
                      htmlFor={`likelihood-${option.value}`}
                      className="font-normal cursor-pointer"
                    >
                      {option.label}
                    </Label>
                  </div>
                ))}
              </RadioGroup>
            </div>

            {/* Q3: Why more likely (conditional) */}
            {showQ3 && (
              <div className="space-y-4 border-l-2 border-primary/30 pl-4">
                <Label className="text-base font-medium">
                  Q3. Why would this make you more likely to send cold emails?
                  <span className="text-muted-foreground font-normal ml-1">(Select up to 2)</span>
                </Label>
                <div className="space-y-2">
                  {LIKELIHOOD_REASONS.map((option) => (
                    <div key={option.value} className="flex items-center space-x-3">
                      <Checkbox
                        id={`reason-${option.value}`}
                        checked={likelihoodReasons.includes(option.value)}
                        onCheckedChange={() => handleLikelihoodReasonToggle(option.value)}
                        disabled={likelihoodReasons.length >= 2 && !likelihoodReasons.includes(option.value)}
                      />
                      <Label
                        htmlFor={`reason-${option.value}`}
                        className="font-normal cursor-pointer"
                      >
                        {option.label}
                      </Label>
                    </div>
                  ))}
                </div>
                <div className="pt-2">
                  <Label htmlFor="reason-other" className="text-sm text-muted-foreground">
                    Other (optional)
                  </Label>
                  <Textarea
                    id="reason-other"
                    value={likelihoodOther}
                    onChange={(e) => setLikelihoodOther(e.target.value)}
                    placeholder="Any other reason..."
                    rows={2}
                    maxLength={500}
                    className="mt-1"
                  />
                </div>
              </div>
            )}

            {/* Q4: Changes before sending */}
            <div className="space-y-4">
              <Label className="text-base font-medium">
                Q4. What would you change before sending this email?
                <span className="text-muted-foreground font-normal ml-1">(Select all that apply)</span>
              </Label>
              <div className="space-y-2">
                {CHANGE_OPTIONS.map((option) => (
                  <div key={option.value} className="flex items-center space-x-3">
                    <Checkbox
                      id={`change-${option.value}`}
                      checked={changesBeforeSending.includes(option.value)}
                      onCheckedChange={() => handleChangeToggle(option.value)}
                    />
                    <Label
                      htmlFor={`change-${option.value}`}
                      className="font-normal cursor-pointer"
                    >
                      {option.label}
                    </Label>
                  </div>
                ))}
              </div>
            </div>

            {/* Q5: What felt off */}
            <div className="space-y-3">
              <Label htmlFor="what-felt-off" className="text-base font-medium">
                Q5. What, if anything, felt most off or least convincing in this email?
              </Label>
              <Textarea
                id="what-felt-off"
                value={whatFeltOff}
                onChange={(e) => setWhatFeltOff(e.target.value)}
                placeholder='If nothing, say "nothing."'
                rows={3}
                maxLength={2000}
              />
            </div>

            {/* Q6: Most useful part */}
            <div className="space-y-4">
              <Label className="text-base font-medium">
                Q6. What was the most useful part of this cold email writer for you?
                <span className="text-muted-foreground font-normal ml-1">(Choose one)</span>
              </Label>
              <RadioGroup
                value={mostUsefulPart}
                onValueChange={setMostUsefulPart}
                className="space-y-2"
              >
                {USEFUL_PART_OPTIONS.map((option) => (
                  <div key={option.value} className="flex items-center space-x-3">
                    <RadioGroupItem value={option.value} id={`useful-${option.value}`} />
                    <Label
                      htmlFor={`useful-${option.value}`}
                      className="font-normal cursor-pointer"
                    >
                      {option.label}
                    </Label>
                  </div>
                ))}
              </RadioGroup>
            </div>

            {/* Q7: What's missing */}
            <div className="space-y-3">
              <Label htmlFor="whats-missing" className="text-base font-medium">
                Q7. If you were to use this tool to write cold emails in the future, what would be missing?
              </Label>
              <Textarea
                id="whats-missing"
                value={whatsMissing}
                onChange={(e) => setWhatsMissing(e.target.value)}
                placeholder="Share your thoughts..."
                rows={3}
                maxLength={2000}
              />
            </div>
          </div>

          <div className="flex justify-between">
            <Button variant="outline" onClick={handleBack}>
              Back
            </Button>
            <Button
              onClick={handleSubmit}
              disabled={!isValid || isSubmitting}
              size="lg"
              className="min-w-[150px]"
            >
              {isSubmitting ? 'Submitting...' : 'Submit & Finish'}
            </Button>
          </div>
        </div>
      </div>

      {/* Prolific Completion Code Dialog */}
      <Dialog open={showCompletionDialog} onOpenChange={() => {}}>
        <DialogContent className="sm:max-w-md" onInteractOutside={(e) => e.preventDefault()}>
          <DialogHeader>
            <DialogTitle className="text-center text-xl">Study Complete!</DialogTitle>
            <DialogDescription className="text-center">
              Thank you for participating. Copy your completion code below and click Done to return to Prolific.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-6 py-4">
            <div className="flex items-center justify-center gap-3">
              <div className="bg-muted px-6 py-3 rounded-md font-mono text-2xl font-bold tracking-wider">
                {PROLIFIC_COMPLETION_CODE}
              </div>
              <Button
                variant="outline"
                size="icon"
                onClick={handleCopyCode}
                className="shrink-0"
              >
                {codeCopied ? <Check className="h-4 w-4 text-green-600" /> : <Copy className="h-4 w-4" />}
              </Button>
            </div>
            <p className="text-sm text-muted-foreground text-center">
              Keep this code safe. You'll need it to complete your submission on Prolific.
            </p>
            <Button
              onClick={handleProlificRedirect}
              className="w-full"
              size="lg"
            >
              Done  Return to Prolific
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </ProlificLayout>
  );
}
</file>

<file path="src/pages/prolific/ProlificWelcome.tsx">
import { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { ProlificLayout } from '@/components/prolific/ProlificLayout';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useProlific } from '@/contexts/ProlificContext';
import { Check } from 'lucide-react';

export default function ProlificWelcome() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const { data, updateData, setCurrentStep } = useProlific();
  const [wasAutoCapured, setWasAutoCaptured] = useState(false);

  useEffect(() => {
    setCurrentStep(0);
    // Auto-capture Prolific params from URL if present
    const prolificPid = searchParams.get('PROLIFIC_PID');
    const studyId = searchParams.get('STUDY_ID');
    const sessionId = searchParams.get('SESSION_ID');
    
    const updates: Partial<typeof data> = {};
    if (prolificPid && !data.prolificId) {
      updates.prolificId = prolificPid;
      updates.wasAutoCaptured = true;
      setWasAutoCaptured(true);
    }
    if (studyId && !data.studyId) updates.studyId = studyId;
    if (sessionId && !data.sessionId) updates.sessionId = sessionId;
    
    if (Object.keys(updates).length > 0) {
      updateData(updates);
    }
  }, [searchParams, setCurrentStep]);

  const handleContinue = () => {
    if (data.prolificId.trim()) {
      navigate('/prolific/setup');
    }
  };

  return (
    <ProlificLayout>
      <div className="space-y-8">
        <div className="text-center space-y-3">
          <h1 className="text-3xl font-serif font-semibold text-foreground">
            Welcome to Our Study
          </h1>
          <p className="text-muted-foreground max-w-xl mx-auto">
            Thank you for participating in this research study. You will be testing an AI-powered 
            email writing tool and providing feedback on your experience.
          </p>
        </div>

        <div className="bg-card border border-border rounded-sm p-6 space-y-6">
          <div className="space-y-4">
            <h2 className="font-serif text-lg font-medium">What to Expect</h2>
            <ul className="space-y-2 text-sm text-muted-foreground">
              <li className="flex items-start gap-2">
                <span className="text-primary mt-0.5">1.</span>
                <span>Brief background questions about your experience</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary mt-0.5">2.</span>
                <span>Use the AI tool to generate a cold outreach email</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary mt-0.5">3.</span>
                <span>Review the generated email</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary mt-0.5">4.</span>
                <span>Complete a short feedback survey</span>
              </li>
            </ul>
            <p className="text-sm text-muted-foreground">
              Estimated time: <span className="font-medium text-foreground">10-15 minutes</span>
            </p>
          </div>

          <div className="border-t border-border pt-6 space-y-4">
            <div className="space-y-2">
              <Label htmlFor="prolificId">Name / User ID</Label>
              {wasAutoCapured ? (
                <div className="flex items-center gap-2 max-w-sm">
                  <div className="flex-1 px-3 py-2 bg-muted/50 border border-border rounded-md text-sm text-foreground">
                    {data.prolificId}
                  </div>
                  <div className="flex items-center gap-1.5 text-sm text-green-600">
                    <Check className="h-4 w-4" />
                    <span>Auto-captured</span>
                  </div>
                </div>
              ) : (
                <>
                  <Input
                    id="prolificId"
                    value={data.prolificId}
                    onChange={(e) => updateData({ prolificId: e.target.value })}
                    placeholder="Enter your name or user ID"
                    className="max-w-sm"
                  />
                  <p className="text-xs text-muted-foreground">
                    If you came from Prolific, this should be auto-filled. Otherwise, please enter it manually.
                  </p>
                </>
              )}
            </div>
          </div>
        </div>

        <div className="flex justify-center">
          <Button
            onClick={handleContinue}
            disabled={!data.prolificId.trim()}
            size="lg"
            className="min-w-[200px]"
          >
            Begin Study
          </Button>
        </div>
      </div>
    </ProlificLayout>
  );
}
</file>

<file path="src/pages/Index.tsx">
import { useState, useEffect, useRef } from 'react';
import { ResearchEmailForm } from '@/components/ResearchEmailForm';
import { EmailResult } from '@/components/EmailResult';
import { GenerationProgress } from '@/components/GenerationProgress';
import { HookPicker } from '@/components/HookPicker';
import { supabase } from '@/integrations/supabase/client';
import type { EmailRequest, EmailResponse } from '@/lib/prompt';
import { toast } from 'sonner';

const Index = () => {
  const [isLoading, setIsLoading] = useState(false);
  const [result, setResult] = useState<EmailResponse | null>(null);
  const [debugTrace, setDebugTrace] = useState<any>(null);
  const [debugData, setDebugData] = useState<any>(null);
  const [currentRequest, setCurrentRequest] = useState<EmailRequest | null>(null);

  // NEW: Research jobs state
  const [researchStatus, setResearchStatus] = useState<'idle' | 'researching' | 'ready' | 'generating'>('idle');
  const [requestId, setRequestId] = useState<string | null>(null);
  const [hooks, setHooks] = useState<any[]>([]);
  const [selectedHook, setSelectedHook] = useState<any | null>(null);
  const pollIntervalRef = useRef<NodeJS.Timeout | null>(null);

  // Debug: Real-time research progress
  const [researchDebug, setResearchDebug] = useState<any>(null);

  // NEW: Poll research status
  useEffect(() => {
    if (!requestId || researchStatus !== 'researching') {
      if (pollIntervalRef.current) {
        clearInterval(pollIntervalRef.current);
        pollIntervalRef.current = null;
      }
      return;
    }

    const pollStatus = async () => {
      try {
        const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
        const supabaseKey = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;

        const response = await fetch(
          `${supabaseUrl}/functions/v1/research-status?requestId=${requestId}`,
          {
            headers: {
              'Authorization': `Bearer ${supabaseKey}`,
            },
          }
        );

        if (!response.ok) {
          console.error('Poll error:', response.status);
          return;
        }

        const data = await response.json();
        console.log('Research status:', data.status, 'Hooks:', data.counts.hooks);

        // Update debug info with full research state
        setResearchDebug({
          requestId: data.requestId,
          status: data.status,
          phaseLabel: data.phaseLabel,
          progress: data.progress,
          counts: data.counts,
          urls: data.urls,
          hooks: data.hooks,
          partial: data.partial,
          fallback_mode: data.fallback_mode,
          error: data.error,
          updated_at: data.updated_at,
        });

        if (data.status === 'complete') {
          setHooks(data.hooks || []);
          setResearchStatus('ready');
          setIsLoading(false); // Stop showing loading state when hooks are ready
          if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
            pollIntervalRef.current = null;
          }
        } else if (data.status === 'failed') {
          toast.error(data.error || 'Research failed. Please try again.');
          setResearchStatus('idle');
          setIsLoading(false);
          if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
            pollIntervalRef.current = null;
          }
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    };

    // Poll every 700ms
    pollIntervalRef.current = setInterval(pollStatus, 700);

    // Initial poll
    pollStatus();

    return () => {
      if (pollIntervalRef.current) {
        clearInterval(pollIntervalRef.current);
      }
    };
  }, [requestId, researchStatus]);

  // NEW: Generate email when hook is selected (only when user clicks)
  const handleHookSelect = (hook: any) => {
    setSelectedHook(hook);
    if (currentRequest) {
      generateEmailWithHook(hook);
    }
  };

  const generateEmailWithHook = async (hook: any) => {
    if (!hook || !currentRequest) return;

    setResearchStatus('generating');
    setIsLoading(true);
    setResult(null);

    try {
      const { data, error } = await supabase.functions.invoke('generate-email', {
        body: {
          ...currentRequest,
          selectedHook: hook,
        },
      });

      if (error) {
        console.error('Edge function error:', error);
        toast.error('Failed to generate email. Please try again.');
        return;
      }

      if (data.error) {
        console.error('API error:', data.error);
        toast.error(data.details || data.error);
        return;
      }

      setResult({
        subject: data.subject,
        body: data.body,
      });

      if (data.debug) {
        setDebugData(data.debug);
        if (data.debug.trace) {
          setDebugTrace(data.debug.trace);
        }
      }
    } catch (err) {
      console.error('Error generating email:', err);
      toast.error('Something went wrong. Please try again.');
    } finally {
      setIsLoading(false);
      setResearchStatus('idle');
    }
  };

  const handleSubmit = async (request: EmailRequest) => {
    setIsLoading(true);
    setResult(null);
    setDebugTrace(null);
    setDebugData(null);
    setResearchDebug(null); // Clear previous research debug
    setCurrentRequest(request);
    setHooks([]);
    setSelectedHook(null);

    // NEW FLOW: Start research job
    try {
      const { data, error } = await supabase.functions.invoke('research', {
        body: {
          recipientName: request.recipientName,
          recipientCompany: request.recipientCompany,
          recipientRole: request.recipientRole,
          senderIntent: request.reachingOutBecause,
          credibilityStory: request.credibilityStory,
        },
      });

      if (error) {
        console.error('Research start error:', error);
        toast.error('Failed to start research. Please try again.');
        setIsLoading(false);
        return;
      }

      if (data.error) {
        console.error('Research API error:', data.error);
        toast.error(data.error);
        setIsLoading(false);
        return;
      }

      console.log('Research started:', data.requestId);
      setRequestId(data.requestId);
      setResearchStatus('researching');
    } catch (err) {
      console.error('Error starting research:', err);
      toast.error('Something went wrong. Please try again.');
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <div className="container mx-auto max-w-2xl px-4 py-16">
        {/* Masthead */}
        <header className="mb-12 text-center border-b border-foreground pb-8">
          <p className="text-xs uppercase tracking-[0.3em] text-muted-foreground mb-3">
            The MBA Networking Toolkit
          </p>
          <h1 className="font-serif text-4xl sm:text-5xl font-medium tracking-tight mb-4 italic">
            Cold Email Assistant
          </h1>
          <p className="text-muted-foreground font-body text-lg">
            Describe a real person. We'll research and draft a personalized email.
          </p>
        </header>

        {/* Main Content */}
        <main>
          <div className="border-t border-foreground pt-8 mb-8">
            <h2 className="font-serif text-2xl font-medium mb-2">Compose Your Message</h2>
            <p className="text-muted-foreground text-sm font-body">
              Complete the fields below. We'll use public information to personalize your email.
            </p>
          </div>

          <ResearchEmailForm onSubmit={handleSubmit} isLoading={isLoading} />
        </main>

        {/* Progress Indicator (shown during research) */}
        {researchStatus === 'researching' && currentRequest && (
          <div className="mt-12 border-t border-foreground pt-8">
            <GenerationProgress
              recipientName={currentRequest.recipientName}
              recipientCompany={currentRequest.recipientCompany}
            />
          </div>
        )}

        {/* Hook Picker (shown when research is complete) */}
        {researchStatus === 'ready' && hooks.length > 0 && (
          <div className="mt-12 border-t border-foreground pt-8">
            <HookPicker
              hooks={hooks}
              selectedHook={selectedHook}
              onSelectHook={handleHookSelect}
            />
          </div>
        )}

        {/* Progress during email generation */}
        {researchStatus === 'generating' && (
          <div className="mt-12 border-t border-foreground pt-8">
            <div className="space-y-4 py-8 text-center">
              <div className="font-serif text-xl font-medium">
                Generating your email...
              </div>
              <p className="text-muted-foreground font-body">
                Using your selected hook to craft a personalized message
              </p>
            </div>
          </div>
        )}

        {/* Research Debug (shown in debug mode during/after research) */}
        {researchDebug && currentRequest?.includeDebug && (
          <div className="mt-8 border-2 border-purple-500/50 rounded p-4 bg-purple-50/10">
            <h3 className="font-mono text-sm font-bold mb-3 text-purple-600 dark:text-purple-400">
               Research Pipeline Debug
            </h3>

            {/* Current Status */}
            <div className="mb-4 p-3 bg-background/50 rounded border border-border">
              <div className="grid grid-cols-2 gap-2 text-xs font-mono">
                <div>
                  <span className="text-muted-foreground">Status: </span>
                  <span className={`font-semibold ${
                    researchDebug.status === 'complete' ? 'text-green-600' :
                    researchDebug.status === 'failed' ? 'text-red-600' :
                    'text-blue-600'
                  }`}>{researchDebug.status}</span>
                </div>
                <div>
                  <span className="text-muted-foreground">Phase: </span>
                  <span className="font-semibold">{researchDebug.phaseLabel}</span>
                </div>
                {researchDebug.progress && (
                  <>
                    <div>
                      <span className="text-muted-foreground">Progress: </span>
                      <span className="font-semibold">{researchDebug.progress.phase}/{researchDebug.progress.total}</span>
                    </div>
                    <div>
                      <span className="text-muted-foreground">Fallback: </span>
                      <span className="font-semibold">{researchDebug.fallback_mode}</span>
                    </div>
                  </>
                )}
              </div>
            </div>

            {/* Counts */}
            {researchDebug.counts && (
              <div className="mb-4 p-3 bg-background/50 rounded border border-border">
                <h4 className="font-mono text-xs font-semibold mb-2">Counts:</h4>
                <div className="grid grid-cols-2 gap-2 text-xs font-mono">
                  <div>
                    <span className="text-muted-foreground">URLs: </span>
                    <span className="font-semibold">{researchDebug.counts.urls}</span>
                  </div>
                  <div>
                    <span className="text-muted-foreground">Hooks: </span>
                    <span className="font-semibold">{researchDebug.counts.hooks}</span>
                  </div>
                </div>
              </div>
            )}

            {/* Error */}
            {researchDebug.error && (
              <div className="mb-4 p-3 bg-red-50/10 border border-red-500/30 rounded">
                <h4 className="font-mono text-xs font-semibold mb-2 text-red-600 dark:text-red-400">
                  Error:
                </h4>
                <div className="text-xs text-red-500">
                  {researchDebug.error}
                </div>
              </div>
            )}

            {/* URLs Found */}
            {researchDebug.urls && researchDebug.urls.length > 0 && (
              <div className="mb-4">
                <h4 className="font-mono text-xs font-semibold mb-2">URLs Found ({researchDebug.urls.length}):</h4>
                <div className="space-y-1">
                  {researchDebug.urls.slice(0, 5).map((url: any, idx: number) => (
                    <div key={idx} className="text-xs font-mono p-2 bg-background/50 rounded border border-border">
                      <a href={url.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline break-all">
                        {url.title || url.url}
                      </a>
                    </div>
                  ))}
                  {researchDebug.urls.length > 5 && (
                    <div className="text-xs text-muted-foreground">
                      ... and {researchDebug.urls.length - 5} more
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Full JSON */}
            <details className="mt-4">
              <summary className="cursor-pointer text-xs font-mono text-muted-foreground hover:text-foreground">
                View Full Research State JSON
              </summary>
              <pre className="mt-2 p-3 bg-background/80 rounded border border-border text-xs overflow-x-auto">
                {JSON.stringify(researchDebug, null, 2)}
              </pre>
            </details>
          </div>
        )}

        {/* Results (shown after email generation complete) */}
        {result && !isLoading && (
          <div className="mt-12 border-t border-foreground pt-8">
            <EmailResult result={result} />
          </div>
        )}

        {/* Debug Data - Full Debug Object */}
        {debugData && (
          <div className="mt-8 border-2 border-blue-500/50 rounded p-4 bg-blue-50/10">
            <h3 className="font-mono text-sm font-bold mb-3 text-blue-600 dark:text-blue-400">
               Debug Data (Full Object)
            </h3>

            {/* Error/Notes section */}
            {debugData.notes && (
              <div className="mb-4 p-3 bg-red-50/10 border border-red-500/30 rounded">
                <h4 className="font-mono text-xs font-semibold mb-2 text-red-600 dark:text-red-400">
                  Research Notes
                </h4>
                <div className="text-xs text-red-500">
                  {debugData.notes}
                </div>
              </div>
            )}

            {/* Key metrics at the top */}
            <div className="mb-4 p-3 bg-background/50 rounded border border-border">
              <div className="grid grid-cols-2 gap-2 text-xs font-mono">
                {debugData.identityDecision && (
                  <div>
                    <span className="text-muted-foreground">Identity: </span>
                    <span className="font-semibold">{debugData.identityDecision}</span>
                  </div>
                )}
                {debugData.identityConfidence !== undefined && (
                  <div>
                    <span className="text-muted-foreground">Confidence: </span>
                    <span className="font-semibold">{(debugData.identityConfidence * 100).toFixed(0)}%</span>
                  </div>
                )}
                {debugData.exaResearchLatencyMs && (
                  <div>
                    <span className="text-muted-foreground">Research Time: </span>
                    <span className="font-semibold">
                      {(debugData.exaResearchLatencyMs / 1000).toFixed(1)}s
                      {debugData.exaPartialResults && <span className="text-orange-500 ml-1">(partial)</span>}
                    </span>
                  </div>
                )}
                {debugData.citations && (
                  <div>
                    <span className="text-muted-foreground">Citations: </span>
                    <span className="font-semibold">{debugData.citations.length}</span>
                  </div>
                )}
                {debugData.exaResearchId && (
                  <div className="col-span-2">
                    <span className="text-muted-foreground">Research ID: </span>
                    <span className="font-semibold text-xs">{debugData.exaResearchId}</span>
                  </div>
                )}
              </div>
            </div>

            {/* Exa Debug Info */}
            {(debugData.exa_http_status || debugData.exa_response_bytes || debugData.exa_raw_keys || debugData.exa_parse_error) && (
              <div className="mb-4 p-3 bg-orange-50/10 border border-orange-500/30 rounded">
                <h4 className="font-mono text-xs font-semibold mb-2 text-orange-600 dark:text-orange-400">
                  Exa API Debug
                </h4>
                <div className="grid grid-cols-2 gap-2 text-xs font-mono">
                  {debugData.exa_http_status !== undefined && (
                    <div>
                      <span className="text-muted-foreground">HTTP Status: </span>
                      <span className="font-semibold">{debugData.exa_http_status}</span>
                    </div>
                  )}
                  {debugData.exa_response_bytes !== undefined && (
                    <div>
                      <span className="text-muted-foreground">Response Bytes: </span>
                      <span className="font-semibold">{debugData.exa_response_bytes.toLocaleString()}</span>
                    </div>
                  )}
                  {debugData.exa_raw_keys && (
                    <div className="col-span-2">
                      <span className="text-muted-foreground">Response Keys: </span>
                      <span className="font-semibold">{debugData.exa_raw_keys.join(', ')}</span>
                    </div>
                  )}
                  {debugData.exa_parse_error && (
                    <div className="col-span-2">
                      <span className="text-red-600 font-semibold">Parse Error: </span>
                      <span className="text-red-500">{debugData.exa_parse_error}</span>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Trace if it exists */}
            {debugTrace && (
              <div className="mb-4">
                <h4 className="font-mono text-xs font-semibold mb-2 text-muted-foreground">Generation Trace:</h4>
                <div className="space-y-2 font-mono text-xs">
                  {debugTrace.map((entry: any, idx: number) => (
                    <div key={idx} className="border-l-2 border-blue-500/30 pl-3 py-1">
                      <div className="flex items-baseline gap-2">
                        <span className="font-semibold text-foreground">{idx + 1}. {entry.stage}</span>
                        {entry.decision && (
                          <span className={entry.decision === 'error' ? 'text-red-500' : 'text-muted-foreground'}>
                             {entry.decision}
                          </span>
                        )}
                      </div>
                      {entry.counts && (
                        <div className="text-muted-foreground mt-1">
                          {Object.entries(entry.counts).map(([key, value]) => (
                            <span key={key} className="mr-3">
                              {key}: {typeof value === 'number' ? value : String(value)}
                            </span>
                          ))}
                        </div>
                      )}
                      {entry.error && (
                        <div className="text-red-500 mt-1 text-xs">
                          Error: {entry.error}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Full JSON */}
            <details className="mt-4">
              <summary className="cursor-pointer text-xs font-mono text-muted-foreground hover:text-foreground">
                View Full JSON
              </summary>
              <pre className="mt-2 p-3 bg-background/80 rounded border border-border text-xs overflow-x-auto">
                {JSON.stringify(debugData, null, 2)}
              </pre>
            </details>
          </div>
        )}

        {/* Footer */}
        <footer className="mt-16 pt-8 border-t border-border text-center">
          <p className="text-sm text-muted-foreground font-body italic">
            "The best cold emails tell one sharp story, not a rsum."
          </p>
        </footer>
      </div>
    </div>
  );
};

export default Index;
</file>

<file path="src/pages/NotFound.tsx">
import { useLocation } from "react-router-dom";
import { useEffect } from "react";

const NotFound = () => {
  const location = useLocation();

  useEffect(() => {
    console.error("404 Error: User attempted to access non-existent route:", location.pathname);
  }, [location.pathname]);

  return (
    <div className="flex min-h-screen items-center justify-center bg-muted">
      <div className="text-center">
        <h1 className="mb-4 text-4xl font-bold">404</h1>
        <p className="mb-4 text-xl text-muted-foreground">Oops! Page not found</p>
        <a href="/" className="text-primary underline hover:text-primary/90">
          Return to Home
        </a>
      </div>
    </div>
  );
};

export default NotFound;
</file>

<file path="src/pages/TestHarness.tsx">
import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Loader2, Play, CheckCircle, XCircle, AlertTriangle, Download, ExternalLink, RefreshCw } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { supabase } from '@/integrations/supabase/client';
import { TEST_CASES, TestCase } from '@/testCases';
import type { ResearchedEmailResponse, HookFact } from '@/lib/prompt';

interface TestResult {
  testCase: TestCase;
  response: ResearchedEmailResponse | null;
  error: string | null;
  metrics: {
    wordCount: number;
    hasEmDash: boolean;
    hasCliches: string[];
    likeYouCount: number;
  } | null;
}

const FORBIDDEN_CLICHES = [
  'keen interest',
  'passionate about',
  'impact at scale',
  'innovative solutions',
  'extensive experience',
  'impressed by',
  'reaching out',
  'excited about',
  'leverage my',
  'synergy',
  'thought leader',
  'game-changer',
  'paradigm shift',
];

function countLikeYou(body: string): number {
  const matches = body.match(/Like you,/g);
  return matches ? matches.length : 0;
}

function analyzeEmail(body: string): { wordCount: number; hasEmDash: boolean; hasCliches: string[]; likeYouCount: number } {
  const wordCount = body.split(/\s+/).filter(Boolean).length;
  const hasEmDash = body.includes('') || body.includes('--');
  const lowerBody = body.toLowerCase();
  const hasCliches = FORBIDDEN_CLICHES.filter(cliche => lowerBody.includes(cliche.toLowerCase()));
  const likeYouCount = countLikeYou(body);
  return { wordCount, hasEmDash, hasCliches, likeYouCount };
}

function getAskTypeLabel(askType: string): string {
  const labels: Record<string, string> = {
    'chat': 'Introductory Chat',
    'feedback': 'Feedback',
    'referral': 'Referral',
    'job': 'Job/Recruiting',
    'other': 'Other',
  };
  return labels[askType] || askType;
}

export default function TestHarness() {
  const [results, setResults] = useState<TestResult[]>([]);
  const [isRunning, setIsRunning] = useState(false);
  const [progress, setProgress] = useState(0);

  const runAllTests = async () => {
    setIsRunning(true);
    setResults([]);
    setProgress(0);

    const newResults: TestResult[] = [];

    for (let i = 0; i < TEST_CASES.length; i++) {
      const testCase = TEST_CASES[i];
      setProgress(i + 1);

      try {
        const { data, error } = await supabase.functions.invoke('generate-email', {
          body: {
            recipientName: testCase.recipientName,
            recipientRole: testCase.recipientRole,
            recipientCompany: testCase.recipientCompany,
            askType: testCase.askType,
            reachingOutBecause: testCase.reachingOutBecause,
            credibilityStory: testCase.credibilityStory,
            sharedAffiliation: testCase.sharedAffiliation,
            source: 'test-harness',
            scenarioName: testCase.label,
          },
        });

        if (error) {
          newResults.push({
            testCase,
            response: null,
            error: error.message,
            metrics: null,
          });
        } else {
          const metrics = analyzeEmail(data.body || '');
          newResults.push({
            testCase,
            response: data,
            error: null,
            metrics,
          });
        }
      } catch (err) {
        newResults.push({
          testCase,
          response: null,
          error: err instanceof Error ? err.message : 'Unknown error',
          metrics: null,
        });
      }

      setResults([...newResults]);
    }

    setIsRunning(false);
  };

  const exportAsJSON = () => {
    const exportData = results.map(r => ({
      id: r.testCase.id,
      label: r.testCase.label,
      recipient: `${r.testCase.recipientName} @ ${r.testCase.recipientCompany}`,
      askType: r.testCase.askType,
      subject: r.response?.subject || null,
      body: r.response?.body || null,
      // V2 Research data
      exaQueries: r.response?.exaQueries || [],
      exaResults: r.response?.exaResults || [],
      selectedSources: r.response?.selectedSources || [],
      hookFacts: r.response?.hookFacts || [],
      // Enforcement
      enforcementResults: r.response?.enforcementResults || null,
      // Legacy
      researchedFacts: r.response?.researchedFacts || [],
      // Metrics
      error: r.error,
      wordCount: r.metrics?.wordCount || null,
      likeYouCount: r.metrics?.likeYouCount || 0,
      hasEmDash: r.metrics?.hasEmDash || false,
      clichesFound: r.metrics?.hasCliches || [],
      validatorPassed: r.response?.validatorPassed || false,
      validatorErrors: r.response?.validatorErrors || [],
      retryUsed: r.response?.retryUsed || false,
    }));
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `email-test-results-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const exportAsCSV = () => {
    const headers = ['ID', 'Label', 'Recipient', 'Ask Type', 'Subject', 'Body', 'Hook Facts', 'Retry Used', 'Validator Passed', 'Error', 'Word Count', 'Like You Count', 'Has Em-Dash', 'Clichs Found'];
    const rows = results.map(r => [
      r.testCase.id.toString(),
      r.testCase.label,
      `${r.testCase.recipientName} @ ${r.testCase.recipientCompany}`,
      r.testCase.askType,
      r.response?.subject || '',
      r.response?.body?.replace(/\n/g, '\\n').replace(/"/g, '""') || '',
      r.response?.hookFacts?.map(f => f.claim).join(' | ') || '',
      r.response?.retryUsed ? 'Yes' : 'No',
      r.response?.validatorPassed ? 'Yes' : 'No',
      r.error || '',
      r.metrics?.wordCount?.toString() || '',
      r.metrics?.likeYouCount?.toString() || '0',
      r.metrics?.hasEmDash ? 'Yes' : 'No',
      r.metrics?.hasCliches?.join('; ') || '',
    ]);
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `email-test-results-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const HookFactDisplay = ({ fact }: { fact: HookFact }) => (
    <div className="bg-primary/5 border border-primary/20 rounded-md p-3 text-sm space-y-1">
      <div className="flex items-start justify-between gap-2">
        <p className="font-medium text-foreground">{fact.claim}</p>
        <Badge variant="outline" className="text-xs shrink-0">
          {fact.bridge_type}  {fact.hook_score}/5
        </Badge>
      </div>
      <p className="text-muted-foreground italic">"{fact.evidence_quote}"</p>
      <div className="flex items-center gap-2 text-xs text-muted-foreground">
        <a href={fact.source_url} target="_blank" rel="noopener noreferrer" className="text-primary hover:underline flex items-center gap-1">
          <ExternalLink className="h-3 w-3" />
          Source
        </a>
        <span></span>
        <span>{fact.why_relevant}</span>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-background">
      <div className="container max-w-5xl py-8 px-4">
        <header className="mb-8">
          <div className="flex items-center gap-3 mb-4">
            <AlertTriangle className="h-5 w-5 text-amber-500" />
            <Badge variant="outline" className="text-amber-600 border-amber-300">
              Internal Testing Only
            </Badge>
          </div>
          <h1 className="text-3xl font-bold text-foreground mb-2">Email Generator Test Harness (V2)</h1>
          <p className="text-muted-foreground">
            This page runs {TEST_CASES.length} predefined scenarios through the V2 research-based email generator with Exa integration and "Like you," enforcement.
          </p>
        </header>

        <div className="mb-8 flex gap-3">
          <Button
            onClick={runAllTests}
            disabled={isRunning}
            size="lg"
            className="gradient-primary text-primary-foreground"
          >
            {isRunning ? (
              <>
                <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                Running... ({progress}/{TEST_CASES.length})
              </>
            ) : (
              <>
                <Play className="mr-2 h-5 w-5" />
                Run All Tests
              </>
            )}
          </Button>

          {results.length > 0 && (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="outline" size="lg">
                  <Download className="mr-2 h-5 w-5" />
                  Export Results
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent>
                <DropdownMenuItem onClick={exportAsJSON}>
                  Export as JSON
                </DropdownMenuItem>
                <DropdownMenuItem onClick={exportAsCSV}>
                  Export as CSV
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          )}
        </div>

        {results.length > 0 && (
          <div className="space-y-6">
            {results.map((result) => (
              <div
                key={result.testCase.id}
                className="border border-border rounded-lg bg-card overflow-hidden"
              >
                <div className="bg-muted/50 px-4 py-3 border-b border-border">
                  <div className="flex items-start justify-between gap-4">
                    <div>
                      <h3 className="font-semibold text-foreground">
                        #{result.testCase.id}: {result.testCase.label}
                      </h3>
                      <p className="text-sm text-muted-foreground mt-1">
                        {result.testCase.recipientName}  {result.testCase.recipientRole} @ {result.testCase.recipientCompany}
                      </p>
                    </div>
                    {result.metrics && (
                      <div className="flex gap-2 flex-wrap justify-end">
                        <Badge variant={result.metrics.wordCount >= 90 && result.metrics.wordCount <= 170 ? 'default' : 'destructive'}>
                          {result.metrics.wordCount} words
                        </Badge>
                        <Badge variant={result.metrics.likeYouCount === 1 ? 'default' : 'destructive'}>
                          {result.metrics.likeYouCount === 1 ? (
                            <><CheckCircle className="h-3 w-3 mr-1" /> "Like you,"</>
                          ) : (
                            <><XCircle className="h-3 w-3 mr-1" /> {result.metrics.likeYouCount}x "Like you,"</>
                          )}
                        </Badge>
                        {result.response?.retryUsed && (
                          <Badge variant="secondary">
                            <RefreshCw className="h-3 w-3 mr-1" /> Retry
                          </Badge>
                        )}
                        <Badge variant={result.response?.validatorPassed ? 'default' : 'destructive'}>
                          {result.response?.validatorPassed ? (
                            <><CheckCircle className="h-3 w-3 mr-1" /> Valid</>
                          ) : (
                            <><XCircle className="h-3 w-3 mr-1" /> Invalid</>
                          )}
                        </Badge>
                      </div>
                    )}
                  </div>
                </div>

                <div className="p-4">
                  {result.error ? (
                    <div className="text-destructive bg-destructive/10 rounded-md p-3">
                      Error: {result.error}
                    </div>
                  ) : result.response ? (
                    <div className="space-y-4">
                      {/* Research Results */}
                      <details className="group">
                        <summary className="cursor-pointer text-sm font-medium text-muted-foreground hover:text-foreground flex items-center gap-2">
                          <span>Research Details</span>
                          {/* Identity Anchor Status */}
                          {result.response.debug?.identityAnchor && (
                            <Badge 
                              variant={result.response.debug.identityAnchor.confirmed ? 'default' : 'destructive'} 
                              className="text-xs"
                            >
                              {result.response.debug.identityAnchor.confirmed ? (
                                <><CheckCircle className="h-3 w-3 mr-1" /> Identity confirmed</>
                              ) : (
                                <><XCircle className="h-3 w-3 mr-1" /> Identity failed</>
                              )}
                            </Badge>
                          )}
                          <Badge variant="outline" className="text-xs">
                            {result.response.hookFacts?.length || 0} hook facts
                          </Badge>
                          {result.response.exaResults && result.response.exaResults.length > 0 && (
                            <Badge variant="outline" className="text-xs">
                              {result.response.exaResults.length} Exa results
                            </Badge>
                          )}
                        </summary>
                        <div className="mt-3 space-y-3">
                          {/* Identity Anchor Details */}
                          {result.response.debug?.identityAnchor && (
                            <div>
                              <p className="text-xs uppercase tracking-wide text-muted-foreground mb-1">
                                Identity Anchor {result.response.debug.identityAnchor.confirmed ? '' : ''}
                              </p>
                              <div className={`rounded-md p-2 text-xs space-y-1 ${result.response.debug.identityAnchor.confirmed ? 'bg-green-500/10 border border-green-500/20' : 'bg-red-500/10 border border-red-500/20'}`}>
                                {result.response.debug.identityAnchor.notes && (
                                  <p className="text-muted-foreground italic">{result.response.debug.identityAnchor.notes}</p>
                                )}
                                {result.response.debug.identityAnchor.identityUrls && result.response.debug.identityAnchor.identityUrls.length > 0 && (
                                  <div>
                                    <span className="text-muted-foreground">Confirmed URLs: </span>
                                    {result.response.debug.identityAnchor.identityUrls.map((url: string, i: number) => (
                                      <a key={i} href={url} target="_blank" rel="noopener noreferrer" className="block text-primary hover:underline truncate">
                                        {url}
                                      </a>
                                    ))}
                                  </div>
                                )}
                                {result.response.debug.identityAnchor.identityScores && result.response.debug.identityAnchor.identityScores.length > 0 && (
                                  <details className="mt-1">
                                    <summary className="cursor-pointer text-muted-foreground hover:text-foreground">Identity Scores ({result.response.debug.identityAnchor.identityScores.length})</summary>
                                    <div className="mt-1 space-y-1 pl-2 border-l-2 border-muted">
                                      {result.response.debug.identityAnchor.identityScores.slice(0, 5).map((s: any, i: number) => (
                                        <div key={i} className="text-xs">
                                          <span className={`font-mono ${s.isIdentityMatch ? 'text-green-600' : 'text-red-600'}`}>
                                            [{s.score}] {s.isIdentityMatch ? '' : ''}
                                          </span>
                                          <span className="text-muted-foreground ml-1 truncate block">{s.url.substring(0, 60)}...</span>
                                          <span className="text-muted-foreground/60 text-[10px]">{s.reasons.join(', ')}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </details>
                                )}
                              </div>
                            </div>
                          )}
                          
                          {/* Exa Queries */}
                          {result.response.exaQueries && result.response.exaQueries.length > 0 && (
                            <div>
                              <p className="text-xs uppercase tracking-wide text-muted-foreground mb-1">Exa Queries</p>
                              <div className="bg-muted/30 rounded-md p-2 text-xs space-y-1">
                                {result.response.exaQueries.map((q, i) => (
                                  <p key={i} className="font-mono text-foreground/80">{i + 1}. {q}</p>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Selected Sources */}
                          {result.response.selectedSources && result.response.selectedSources.length > 0 && (
                            <div>
                              <p className="text-xs uppercase tracking-wide text-muted-foreground mb-1">Selected Sources for Extraction</p>
                              <div className="bg-muted/30 rounded-md p-2 text-xs space-y-1">
                                {result.response.selectedSources.map((url, i) => (
                                  <a key={i} href={url} target="_blank" rel="noopener noreferrer" className="block text-primary hover:underline truncate">
                                    {url}
                                  </a>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Hook Facts */}
                          {result.response.hookFacts && result.response.hookFacts.length > 0 ? (
                            <div>
                              <p className="text-xs uppercase tracking-wide text-muted-foreground mb-2">Hook Facts</p>
                              <div className="space-y-2">
                                {result.response.hookFacts.map((fact, i) => (
                                  <HookFactDisplay key={i} fact={fact} />
                                ))}
                              </div>
                            </div>
                          ) : (
                            <p className="text-xs text-muted-foreground italic">No hook facts extracted (email generated without specific research)</p>
                          )}
                        </div>
                      </details>

                      {/* Enforcement Results */}
                      {result.response.enforcementResults && (result.response.enforcementResults.failures_first_pass.length > 0 || result.response.enforcementResults.did_retry) && (
                        <details className="group">
                          <summary className="cursor-pointer text-sm font-medium text-muted-foreground hover:text-foreground flex items-center gap-2">
                            <span>Enforcement Details</span>
                            {result.response.enforcementResults.did_retry && (
                              <Badge variant="secondary" className="text-xs">
                                <RefreshCw className="h-3 w-3 mr-1" /> Retry used
                              </Badge>
                            )}
                          </summary>
                          <div className="mt-3 space-y-2">
                            {result.response.enforcementResults.failures_first_pass.length > 0 && (
                              <div>
                                <p className="text-xs uppercase tracking-wide text-amber-600 mb-1">First Pass Failures</p>
                                <ul className="bg-amber-500/10 border border-amber-500/20 rounded-md p-2 text-xs space-y-1">
                                  {result.response.enforcementResults.failures_first_pass.map((f, i) => (
                                    <li key={i} className="text-amber-700">{f}</li>
                                  ))}
                                </ul>
                              </div>
                            )}
                            {result.response.enforcementResults.failures_retry.length > 0 && (
                              <div>
                                <p className="text-xs uppercase tracking-wide text-destructive mb-1">Retry Failures (Still Present)</p>
                                <ul className="bg-destructive/10 border border-destructive/20 rounded-md p-2 text-xs space-y-1">
                                  {result.response.enforcementResults.failures_retry.map((f, i) => (
                                    <li key={i} className="text-destructive">{f}</li>
                                  ))}
                                </ul>
                              </div>
                            )}
                          </div>
                        </details>
                      )}

                      {/* Email Output */}
                      <div>
                        <p className="text-xs uppercase tracking-wide text-muted-foreground mb-1">Subject</p>
                        <p className="font-medium text-foreground">{result.response.subject}</p>
                      </div>
                      <div>
                        <p className="text-xs uppercase tracking-wide text-muted-foreground mb-1">Body</p>
                        <div className="text-sm text-foreground/90 whitespace-pre-wrap bg-muted/30 rounded-md p-3">
                          {result.response.body}
                        </div>
                      </div>

                      {/* Validation Errors (if any remain) */}
                      {result.response.validatorErrors && result.response.validatorErrors.length > 0 && (
                        <div>
                          <p className="text-xs uppercase tracking-wide text-destructive mb-1">Validation Errors</p>
                          <ul className="bg-destructive/10 rounded-md p-2 text-xs space-y-1">
                            {result.response.validatorErrors.map((err, i) => (
                              <li key={i} className="text-destructive">{err}</li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {/* Detected Clichs */}
                      {result.metrics && result.metrics.hasCliches.length > 0 && (
                        <div>
                          <p className="text-xs uppercase tracking-wide text-destructive mb-1">Detected Clichs</p>
                          <div className="flex gap-2 flex-wrap">
                            {result.metrics.hasCliches.map((cliche, i) => (
                              <Badge key={i} variant="destructive" className="text-xs">
                                "{cliche}"
                              </Badge>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  ) : null}
                </div>

                <details className="border-t border-border">
                  <summary className="px-4 py-2 text-sm text-muted-foreground cursor-pointer hover:bg-muted/30">
                    View Input Details
                  </summary>
                  <div className="px-4 py-3 text-xs space-y-2 bg-muted/20">
                    <p><strong>Recipient:</strong> {result.testCase.recipientName}, {result.testCase.recipientRole} at {result.testCase.recipientCompany}</p>
                    <p><strong>Ask Type:</strong> {getAskTypeLabel(result.testCase.askType)}</p>
                    <p><strong>Reaching Out Because:</strong> {result.testCase.reachingOutBecause}</p>
                    <p><strong>Credibility Story:</strong> {result.testCase.credibilityStory}</p>
                    {result.testCase.sharedAffiliation && (
                      <p><strong>Shared Background:</strong> {result.testCase.sharedAffiliation.types.join(', ')}  {result.testCase.sharedAffiliation.name}{result.testCase.sharedAffiliation.detail ? ` (${result.testCase.sharedAffiliation.detail})` : ''}</p>
                    )}
                  </div>
                </details>
              </div>
            ))}
          </div>
        )}

        {results.length === 0 && !isRunning && (
          <div className="text-center py-16 text-muted-foreground">
            <p>Click "Run All Tests" to generate emails for all {TEST_CASES.length} test scenarios.</p>
            <p className="text-sm mt-2">Each test will use Exa to research the recipient before generating the email with "Like you," enforcement.</p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/App.tsx">
import { Toaster } from "@/components/ui/toaster";
import { Toaster as Sonner } from "@/components/ui/sonner";
import { TooltipProvider } from "@/components/ui/tooltip";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { BrowserRouter, Routes, Route } from "react-router-dom";
import Index from "./pages/Index";
import TestHarness from "./pages/TestHarness";
import NotFound from "./pages/NotFound";
import { ProlificProvider } from "./contexts/ProlificContext";
import ProlificWelcome from "./pages/prolific/ProlificWelcome";
import ProlificSetup from "./pages/prolific/ProlificSetup";
import ProlificApp from "./pages/prolific/ProlificApp";
import ProlificRead from "./pages/prolific/ProlificRead";
import ProlificSurvey from "./pages/prolific/ProlificSurvey";
import ProlificComplete from "./pages/prolific/ProlificComplete";

const queryClient = new QueryClient();

const App = () => (
  <QueryClientProvider client={queryClient}>
    <TooltipProvider>
      <Toaster />
      <Sonner />
      <BrowserRouter>
        <Routes>
          <Route path="/" element={<Index />} />
          <Route path="/tests" element={<TestHarness />} />
          
          {/* Prolific Study Routes - wrapped in single provider */}
          <Route
            path="/prolific/*"
            element={
              <ProlificProvider>
                <Routes>
                  <Route index element={<ProlificWelcome />} />
                  <Route path="setup" element={<ProlificSetup />} />
                  <Route path="app" element={<ProlificApp />} />
                  <Route path="read" element={<ProlificRead />} />
                  <Route path="survey" element={<ProlificSurvey />} />
                  <Route path="complete" element={<ProlificComplete />} />
                </Routes>
              </ProlificProvider>
            }
          />
          
          {/* ADD ALL CUSTOM ROUTES ABOVE THE CATCH-ALL "*" ROUTE */}
          <Route path="*" element={<NotFound />} />
        </Routes>
      </BrowserRouter>
    </TooltipProvider>
  </QueryClientProvider>
);

export default App;
</file>

<file path="src/index.css">
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Source+Serif+4:ital,wght@0,400;0,500;0,600;1,400&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 40 20% 98%;
    --foreground: 0 0% 8%;

    --card: 0 0% 100%;
    --card-foreground: 0 0% 8%;

    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 8%;

    --primary: 0 0% 8%;
    --primary-foreground: 40 20% 98%;

    --secondary: 40 10% 94%;
    --secondary-foreground: 0 0% 8%;

    --muted: 40 10% 94%;
    --muted-foreground: 0 0% 40%;

    --accent: 40 10% 94%;
    --accent-foreground: 0 0% 8%;

    --destructive: 0 72% 51%;
    --destructive-foreground: 40 20% 98%;

    --border: 0 0% 85%;
    --input: 0 0% 85%;
    --ring: 0 0% 8%;

    --radius: 0.125rem;

    /* NYT-inspired tokens */
    --font-serif: 'Playfair Display', 'Georgia', 'Times New Roman', serif;
    --font-body: 'Source Serif 4', 'Georgia', serif;
    --shadow-subtle: 0 1px 2px 0 rgb(0 0 0 / 0.03);
    --shadow-card: 0 1px 3px 0 rgb(0 0 0 / 0.05);
    --border-rule: 1px solid hsl(0 0% 8%);

    --sidebar-background: 0 0% 98%;
    --sidebar-foreground: 0 0% 8%;
    --sidebar-primary: 0 0% 8%;
    --sidebar-primary-foreground: 0 0% 98%;
    --sidebar-accent: 40 10% 94%;
    --sidebar-accent-foreground: 0 0% 8%;
    --sidebar-border: 0 0% 85%;
    --sidebar-ring: 0 0% 8%;
  }

  .dark {
    --background: 0 0% 6%;
    --foreground: 40 10% 92%;

    --card: 0 0% 9%;
    --card-foreground: 40 10% 92%;

    --popover: 0 0% 9%;
    --popover-foreground: 40 10% 92%;

    --primary: 40 10% 92%;
    --primary-foreground: 0 0% 6%;

    --secondary: 0 0% 14%;
    --secondary-foreground: 40 10% 92%;

    --muted: 0 0% 14%;
    --muted-foreground: 0 0% 55%;

    --accent: 0 0% 14%;
    --accent-foreground: 40 10% 92%;

    --destructive: 0 63% 31%;
    --destructive-foreground: 40 10% 92%;

    --border: 0 0% 18%;
    --input: 0 0% 18%;
    --ring: 40 10% 92%;
  }
}

@layer base {
  * {
    @apply border-border;
  }

  body {
    @apply bg-background text-foreground antialiased;
    font-family: var(--font-body);
  }
  
  h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-serif);
  }
}

@layer utilities {
  .font-serif {
    font-family: var(--font-serif);
  }
  
  .font-body {
    font-family: var(--font-body);
  }
  
  .border-rule {
    border-top: var(--border-rule);
  }
  
  .shadow-subtle {
    box-shadow: var(--shadow-subtle);
  }
  
  .shadow-card {
    box-shadow: var(--shadow-card);
  }
}
</file>

<file path="src/main.tsx">
import { createRoot } from "react-dom/client";
import App from "./App.tsx";
import "./index.css";

createRoot(document.getElementById("root")!).render(<App />);
</file>

<file path="src/testCases.ts">
import { SharedAffiliationType } from './lib/prompt';

export interface TestCase {
  id: number;
  label: string;
  recipientName: string;
  recipientRole: string;
  recipientCompany: string;
  askType: 'chat' | 'feedback' | 'referral' | 'job' | 'other';
  reachingOutBecause: string;
  credibilityStory: string;
  sharedAffiliation?: {
    types: SharedAffiliationType[];
    name: string;
    detail?: string;
  };
}

export const TEST_CASES: TestCase[] = [
  {
    id: 1,
    label: "VC outreach  Latina investor to Kara Nortman",
    recipientName: "Kara Nortman",
    recipientRole: "Co-Managing Partner",
    recipientCompany: "Upfront Ventures",
    askType: "chat",
    reachingOutBecause: "I want to learn how a Latina investor can thrive in LA VC and hear about your experience building pathways for underrepresented investors.",
    credibilityStory: "I grew up in a small Texas border town, first in my family to attend college, and now I'm a VC Fellow at PayPal Ventures developing a thesis on gig economy infrastructure. I've been researching how gig economy payments differ across LATAM markets and have a few early-stage companies on my radar.",
    sharedAffiliation: {
      types: ['personal_characteristics'],
      name: "Latina women in VC",
      detail: "Both Latina investors in a male-dominated industry"
    }
  },
  {
    id: 2,
    label: "Creative outreach  storyteller to Steph Curry",
    recipientName: "Steph Curry",
    recipientRole: "Co-founder",
    recipientCompany: "Unanimous Media",
    askType: "feedback",
    reachingOutBecause: "I have a short film idea about underdog stories that I think would fit Unanimous Media's slate, and I'd love 15 minutes to share it.",
    credibilityStory: "I once organized a 3-on-3 tournament in Detroit where our team came back from 184 in the final. That moment pushed me into telling underdog stories through film. I've since made a two-minute proof-of-concept and have a one-page story outline ready."
    // No shared background
  },
  {
    id: 3,
    label: "Writer outreach  climate organizer to Rebecca Solnit",
    recipientName: "Rebecca Solnit",
    recipientRole: "Author",
    recipientCompany: "Independent",
    askType: "chat",
    reachingOutBecause: "I'm at a crossroads between corporate sustainability, running a youth climate camp, or writing, and would love your perspective on choosing a path.",
    credibilityStory: "I spent five years lobbying Congress on climate policy, then came to business school feeling disconnected from the work that first brought me to activism. I've been reflecting on your book Hope in the Dark and how small human actions can move people toward change.",
    sharedAffiliation: {
      types: ['school'],
      name: "UC Berkeley",
      detail: "Environmental Studies, 2018"
    }
  },
  {
    id: 4,
    label: "Product operator  payments experience to Stripe PM",
    recipientName: "John Collison",
    recipientRole: "President",
    recipientCompany: "Stripe",
    askType: "chat",
    reachingOutBecause: "I want to understand how to transition from ops-heavy roles into product leadership at a payments company.",
    credibilityStory: "I spent three years across South America stitching together unreliable payment rails, including a night in Buenos Aires debugging settlement failures at 2 a.m. I've written a brief memo on how AI agents might reduce operational load in payments that I could share.",
    sharedAffiliation: {
      types: ['accelerator'],
      name: "YC W19",
      detail: "Founded a fintech startup"
    }
  },
  {
    id: 5,
    label: "Impact founder  health access founder to HBS lecturer",
    recipientName: "Michael Chu",
    recipientRole: "Lecturer and impact investor",
    recipientCompany: "Harvard Business School",
    askType: "feedback",
    reachingOutBecause: "I'd love to share what we're building and get your perspective on scaling models for low-income health access.",
    credibilityStory: "My cofounder and I started an O2O women's health platform in Mexico after seeing how few middle-income women had access to reliable care. We've tested our model across three cities and have ground-level insights on what works.",
    sharedAffiliation: {
      types: ['business_school'],
      name: "Harvard Business School",
      detail: "MBA '24"
    }
  },
  {
    id: 6,
    label: "Manufacturing investor  distressed debt to niche operator",
    recipientName: "Nick Howley",
    recipientRole: "Executive Chairman",
    recipientCompany: "TransDigm",
    askType: "chat",
    reachingOutBecause: "I want to understand how you think about evaluating operators and markets when acquiring niche aerospace manufacturers.",
    credibilityStory: "I spent years as a distressed-debt investor studying overlooked industrial companies and now want to find small Midwestern manufacturers ready for succession. I've come across a few acquisition targets through my research that might interest you."
    // No shared background
  },
  {
    id: 7,
    label: "Food founder  alt dairy question to Whole Foods founder",
    recipientName: "John Mackey",
    recipientRole: "Founder",
    recipientCompany: "Whole Foods",
    askType: "feedback",
    reachingOutBecause: "I'm launching an affordable alternative dairy brand and want to understand how you'd navigate centralized merchandising if you were launching today.",
    credibilityStory: "I'm launching an affordable alternative dairy brand out of the GSB after seeing how many families can't afford healthy options. I've been speaking with other founders trying to enter grocery retail in 2025 and have fresh insights on the current landscape.",
    sharedAffiliation: {
      types: ['business_school'],
      name: "Stanford GSB",
      detail: "MBA '25"
    }
  },
  {
    id: 8,
    label: "Privacy researcher  David vs Goliath ask to Max Schrems",
    recipientName: "Max Schrems",
    recipientRole: "Privacy activist",
    recipientCompany: "NOYB",
    askType: "chat",
    reachingOutBecause: "I want to hear how you stayed persistent through repeated setbacks in your privacy advocacy work.",
    credibilityStory: "I'm an Uzbek refugee who fought through a male-dominated legal system, studied at Oxford, and now research GDPR enforcement at Stanford. I have fresh interview data from my dissertation on privacy enforcement that I could share.",
    sharedAffiliation: {
      types: ['personal_characteristics'],
      name: "Central Asian immigrants in tech policy",
      detail: "Both navigating Western institutions as outsiders"
    }
  },
  {
    id: 9,
    label: "Music + tech founder  Lagos story to Dr. Dre",
    recipientName: "Andre Young",
    recipientRole: "Producer and entrepreneur",
    recipientCompany: "Aftermath Entertainment",
    askType: "chat",
    reachingOutBecause: "I want to ask what you look for in people working at the intersection of music and tech.",
    credibilityStory: "I grew up in a neighborhood in Lagos where bootleg Dre tapes were my first window into another world. I recorded verses over your beats at 14. Now I'm building early concepts for connecting African artists to global audiences."
    // No shared background
  },
  {
    id: 10,
    label: "Tech exec outreach  Microsoft exec",
    recipientName: "Chris Young",
    recipientRole: "Executive Vice President",
    recipientCompany: "Microsoft",
    askType: "feedback",
    reachingOutBecause: "I'm building medical software for nursing homes and would love your perspective on navigating large-scale tech transitions.",
    credibilityStory: "For a decade, I was COO of a medical company, spending a good chunk of that time moving our entire operation to cloud-based software. That experience ignited an idea to build my own medical software platform.",
    sharedAffiliation: {
      types: ['company'],
      name: "McKesson",
      detail: "VP of Technology, 20152019"
    }
  }
];
</file>

<file path="src/vite-env.d.ts">
/// <reference types="vite/client" />
</file>

<file path="supabase/functions/create-prolific-session/index.ts">
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const body = await req.json();
    const { prolificId, studyId, prolificSessionId, profession, coldEmailFrequency } = body;

    // Validation
    if (!prolificId || typeof prolificId !== 'string' || prolificId.trim().length === 0) {
      console.error('Validation failed: missing prolificId');
      return new Response(
        JSON.stringify({ error: 'Prolific ID is required' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const trimmedProlificId = prolificId.trim();
    
    // Allow test IDs (prefixed with "test_" or "TEST_") OR valid Prolific format (24 char alphanumeric)
    const isTestId = /^test_/i.test(trimmedProlificId);
    const isValidProlificFormat = /^[a-zA-Z0-9]{24}$/.test(trimmedProlificId);
    
    if (!isTestId && !isValidProlificFormat) {
      // For non-test IDs, require minimum 3 characters to allow flexibility during development
      if (trimmedProlificId.length < 3) {
        console.error('Validation failed: prolificId too short');
        return new Response(
          JSON.stringify({ error: 'Prolific ID must be at least 3 characters' }),
          { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        );
      }
      console.log('Accepting non-standard prolificId for testing:', trimmedProlificId);
    }

    if (!profession || typeof profession !== 'string' || profession.trim().length === 0) {
      console.error('Validation failed: missing profession');
      return new Response(
        JSON.stringify({ error: 'Profession is required' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    if (!coldEmailFrequency || typeof coldEmailFrequency !== 'string') {
      console.error('Validation failed: missing coldEmailFrequency');
      return new Response(
        JSON.stringify({ error: 'Cold email frequency is required' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const supabaseUrl = Deno.env.get('SUPABASE_URL');
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');

    if (!supabaseUrl || !supabaseServiceKey) {
      console.error('Missing Supabase configuration');
      return new Response(
        JSON.stringify({ error: 'Server configuration error' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    console.log('Creating prolific session for:', trimmedProlificId);

    // Check if session already exists for this prolific_id (rate limiting / duplicate prevention)
    const { data: existingSession } = await supabase
      .from('prolific_sessions')
      .select('id')
      .eq('prolific_id', trimmedProlificId)
      .maybeSingle();

    if (existingSession) {
      console.log('Session already exists for prolific_id:', trimmedProlificId);
      return new Response(
        JSON.stringify({ sessionId: existingSession.id }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const { data, error } = await supabase
      .from('prolific_sessions')
      .insert({
        prolific_id: trimmedProlificId,
        study_id: studyId?.trim() || null,
        prolific_session_id: prolificSessionId?.trim() || null,
        profession: profession.trim(),
        cold_email_frequency: coldEmailFrequency,
      })
      .select('id')
      .single();

    if (error) {
      console.error('Database error:', error);
      return new Response(
        JSON.stringify({ error: 'Failed to create session' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    console.log('Session created:', data.id);

    return new Response(
      JSON.stringify({ sessionId: data.id }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error('Error in create-prolific-session:', error);
    return new Response(
      JSON.stringify({ error: 'An unexpected error occurred' }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
</file>

<file path="supabase/functions/generate-email/index.ts">
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// ============= DEPLOY VERSION - BUMP THIS ON EACH DEPLOY =============
const DEPLOY_VERSION = "2025-12-27d-exa-flat-schema";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Expose-Headers": "x-deploy-version, x-generation-id",
};

const PROMPT_VERSION = "v9.0-voice-first";
const MODEL_NAME = "gemini-2.5-flash";

// Exa Research config
const EXA_RESEARCH_TIMEOUT_MS = 90000; // 90 seconds - Exa needs time to complete research gathering phase
const EXA_RESEARCH_POLL_INTERVAL_MS = 2000; // 2 seconds (faster polling for early stop)

// Helper to build response headers with deploy version and generation ID
function buildResponseHeaders(generationId: string): Record<string, string> {
  return {
    ...corsHeaders,
    "Content-Type": "application/json",
    "x-deploy-version": DEPLOY_VERSION,
    "x-generation-id": generationId,
  };
}

// ============= SUPER PROMPT (Voice-First v9) =============
const SUPER_PROMPT = `

You write cold emails that read like a single, continuous thought from a real person  not a template, not a checklist.
The email should feel like someone thinking out loud to a respected peer: warm, specific, human, and slightly under-polished.

CORE MENTAL MODEL (THIS OVERRIDES ALL OTHER RULES)
Do not assemble an email. Explain why you're writing.
Write as if you're answering this question in one flowing explanation:
"Why should this person care about this message right now?"
Everything in the email should logically follow from that explanation.
If a sentence doesn't naturally lead to the next one, rewrite.

BEFORE WRITING THE EMAIL:
In 23 sentences, silently explain to yourself:
Why am I writing this person right now?
What specific overlap or tension makes this message necessary?

Then write the email as a natural explanation of that.
Do NOT structure the email. Let it flow.

YOUR PERSONA
You are a real person with a real reason for reaching out.
You respect the recipient. You are not pitching. You are not performing. You are not trying to sound impressive.
Write like you'd text someone you admire but don't know yet.

THE ONE NON-NEGOTIABLE RULE
The email MUST contain exactly one instance of:
"Like you," (capital L, comma after)
This phrase is not decoration. It should feel inevitable, not inserted.
Rule: If the sentence still works without "Like you," rewrite it until it doesn't.

HOW "LIKE YOU" SHOULD FUNCTION
"Like you," must express a shared lived reality, not a belief or value.
It should connect:
* what they've done
* to what you've done
* and why that overlap matters now
GOOD:
* "Like you, I'm now dedicated to storytelling as an avenue for inspiring black boys and girls."
* "Like you, I want to write about the small human actions that transform hearts and minds"
* "Like you, I want to devote my career to applying technology to improving conservation."
* "Like you, I was born and raised in Italy, but I built my career outside our country."
* "Like you, I am often told I bite off more than I can chew"
NEVER:
* "Like you, I care about inclusion."
* "Like you, I believe in innovation."
* "Like you, we share a commitment to"
If it sounds like a mission statement, rewrite.
You may NOT use belief verbs (believe, think, care, passionate).


FLOW OVER STRUCTURE (IMPORTANT)
Do not write:
* hook paragraph
* credibility paragraph
* ask paragraph
Instead:
* Let one idea naturally lead to the next
* Use connective language a human would use out loud:

The email should feel like ONE thought, not three blocks.

OPENING RULE (STILL STRICT)
The first sentence after the greeting must contain new information.
Default to sender-side news:
* what you're building
* what you're organizing
* what you're offering
* a concrete detail from their work (the detail itself, not "I read")
ALLOWED:
* "Stanford's Black Business Conference is coming back in October."
* "We're building a payments tool focused on LatAm gig workers."
* "That stat in your Afrotech piece  40% lacking device access  stuck with me."
BANNED AS FIRST SENTENCE:
* "I read"
* "I saw"
* "I wanted to reach out"
* "This might be out of the blue"
* "My name is"
* "I'm a"

LANGUAGE + TONE (UNCHANGED, BUT SIMPLIFIED)
* Simple words beat impressive ones
* One sentence = one idea
* Short is better than clever
* Warm, but not emotional
* Casual, but not sloppy
* No corporate polish
If a 12-year-old wouldn't say it, rewrite it.

CREDIBILITY (SUBTLE)
Credibility should feel incidental, not announced.
Prefer:
* "I've been working on X for a few years" Over:
* "I bring extensive experience in X"
No titles. No awards. No flexing.

SHOW, DON'T TELL (MANDATORY)
Never describe their qualities. Point to something concrete instead.
* BAD: "Your leadership demonstrated vision"
* GOOD: "The Activision deal took two years  that kind of patience is rare."

TEXTURE RULES (USE SPARINGLY)
* One-line paragraphs are fine
* A single specific detail beats three generic ones
* Don't explain who they are to them
* Ask one real, answerable question

LENGTH
Readable in under 20 seconds. If you can say it in 80 words, don't stretch to 120.

ENDING + ASK
The ask should feel like the natural conclusion of the explanation  not a switch in tone.
Prefer:
* "Would you be up for a quick call?"
* "Any chance you'd want to talk about it?"
Avoid:
* formality
* hedging
* "no pressure" language

HARD RULES (AUTOMATIC REJECTION IF VIOLATED)
* "Like you," appears exactly once
* No em-dashes
* No clichs ("reaching out because", "would love to connect", etc.)
* No invented research
* No rsum summaries
* End with exactly:
Best,
Nothing after.

FINAL CHECK  READ ALOUD

Before returning the email, read it as if you're saying it out loud to a real person.

If any sentence:
- sounds like something you wouldn't say in a normal conversation
- feels polite but empty
- sounds like a press release, slide deck, or LinkedIn post

Rewrite that sentence using simpler, more natural words.

Do this once. Then return the final email only.

`;

// ============= TYPES =============

type AskType = "chat" | "feedback" | "referral" | "job" | "other";
type BridgeAngle = "domain" | "value" | "tradeoff" | "artifact" | "inflection" | "shared-affiliation";
type EvidenceType = "quote" | "named_initiative" | "described_decision" | "named_artifact" | "public_stance";
type IdentityDecision = "PASS" | "FAIL";

interface ValidationResult {
  valid: boolean;
  errors: string[];
  likeYouCount: number;
  wordCount: number;
  clicheCount: number;
}

interface LikeYouIngredients {
  shared_axis: string;
  shared_action: string;
  shared_stakes: string;
  optional_phrases?: string[];
}

interface HookPack {
  hook_fact: {
    claim: string;
    source_url: string;
    evidence: string;
    evidence_type: EvidenceType;
  };
  bridge: {
    bridge_angle: BridgeAngle;
    why_relevant: string;
    like_you_ingredients: LikeYouIngredients;
    intent_theme: string;
  };
  scores: {
    identity_conf: number;
    non_generic: number;
    intent_fit: number;
    bridgeability: number;
    overall: number;
  };
}

interface ProfileSummary {
  current_role: string;
  current_company: string;
  education: string[];
  past_companies: string[];
  skills: string[];
  career_trajectory?: string;
  company_context?: string;
  likely_interests: string[];
  source: "linkedin" | "fingerprint" | "hypothesis" | "mixed" | "exa_research";
}

interface SenderIntentProfile {
  primary_theme: string;
  secondary_themes: string[];
  must_include_terms: string[];
  avoid_terms: string[];
  preferred_evidence_types: EvidenceType[];
}

interface EnforcementResults {
  did_retry: boolean;
  failures_first_pass: string[];
  failures_retry: string[];
}

// ============= EXA RESEARCH OUTPUT SCHEMA =============
// This schema is the HARD CONTRACT with Exa Research API.
// All research logic is delegated to Exa via instructions.

// FLATTENED SCHEMA - Max depth 5 levels to satisfy Exa API constraints
// We flatten nested objects (scores, like_you_ingredients) to top-level properties
const EXA_RESEARCH_OUTPUT_SCHEMA = {
  type: "object",
  properties: {
    identity_canonical_name: { type: "string" },
    identity_company: { type: "string" },
    identity_role: { type: "string" },
    identity_confidence: { type: "number" },
    identity_decision: { type: "string", enum: ["PASS", "FAIL"] },
    identity_disambiguators: { type: "array", items: { type: "string" } },
    hook_packs: {
      type: "array",
      items: {
        type: "object",
        properties: {
          // hook_fact fields (flattened)
          claim: { type: "string" },
          source_url: { type: "string" },
          evidence: { type: "string" },
          evidence_type: { type: "string", enum: ["quote", "named_initiative", "described_decision", "named_artifact", "public_stance"] },
          // bridge fields (flattened)
          bridge_angle: { type: "string", enum: ["domain", "value", "tradeoff", "artifact", "inflection", "shared-affiliation"] },
          why_relevant: { type: "string" },
          // like_you_ingredients (flattened)
          shared_axis: { type: "string" },
          shared_action: { type: "string" },
          shared_stakes: { type: "string" },
          // simplified scoring - just one score
          score_intent_fit: { type: "number" },
        },
        required: ["claim", "source_url", "evidence", "evidence_type", "bridge_angle", "why_relevant", "shared_axis", "shared_action", "shared_stakes", "score_intent_fit"],
      },
    },
    fallback_mode: { type: "string", enum: ["sufficient", "minimal", "failed"] },
    fallback_reason: { type: "string" },
    // Profile summary fields (simplified)
    profile_education: { type: "array", items: { type: "string" } },
    profile_past_companies: { type: "array", items: { type: "string" } },
    profile_named_artifacts: { type: "array", items: { type: "string" } },
    profile_key_topics: { type: "array", items: { type: "string" } },
    citations: {
      type: "array",
      items: {
        type: "object",
        properties: {
          url: { type: "string" },
          title: { type: "string" },
        },
        required: ["url"],
      },
    },
    research_notes: { type: "string" },
  },
  required: ["identity_canonical_name", "identity_company", "identity_confidence", "identity_decision", "hook_packs", "fallback_mode", "citations"],
};

// Helper to map flattened Exa output back to internal HookPack type
function mapFlatHookPackToInternal(flat: Record<string, unknown>): HookPack {
  const intentFit = (flat.score_intent_fit as number) || 0;
  return {
    hook_fact: {
      claim: (flat.claim as string) || "",
      source_url: (flat.source_url as string) || "",
      evidence: (flat.evidence as string) || "",
      evidence_type: (flat.evidence_type as EvidenceType) || "quote",
    },
    bridge: {
      bridge_angle: (flat.bridge_angle as BridgeAngle) || "domain",
      why_relevant: (flat.why_relevant as string) || "",
      like_you_ingredients: {
        shared_axis: (flat.shared_axis as string) || "",
        shared_action: (flat.shared_action as string) || "",
        shared_stakes: (flat.shared_stakes as string) || "",
      },
      intent_theme: (flat.intent_theme as string) || "",
    },
    scores: {
      // Simplified scoring: we only have score_intent_fit now
      // Map it to all score fields for backward compatibility
      identity_conf: intentFit,
      non_generic: intentFit,
      intent_fit: intentFit,
      bridgeability: intentFit,
      overall: intentFit,
    },
  };
}

// ============= EXA RESEARCH FUNCTIONS =============

function buildExaResearchInstructions(
  recipientName: string,
  recipientCompany: string,
  recipientRole: string,
  reachingOutBecause: string,
  credibilityStory: string,
  askType: AskType,
): string {
  return `
You are researching ${recipientName} (${recipientRole} at ${recipientCompany}) to find 1-2 SPECIFIC hooks for a cold email.

TIME BUDGET: 30 seconds max. STOP IMMEDIATELY once you find 2 hooks with score_intent_fit >= 0.7.

SENDER'S PURPOSE:
"${reachingOutBecause}"
Ask type: ${askType}
Credibility: "${credibilityStory}"

INSTRUCTIONS:
1. IDENTITY: Confirm this person exists at this company. Extract 2-3 disambiguators (e.g., past company, project name, education). Set identity_decision = "PASS" if confident, "FAIL" if not.

2. SEARCH STRATEGY (you decide which to try first):
   - Intent-first: Search for topics related to sender's purpose. Filter results to ${recipientName}.
   - Profile-first: Search for ${recipientName} + ${recipientCompany}. Filter results for intent relevance.

3. WHAT COUNTS AS A HOOK:
    Quote they said (with exact words)
    Named initiative/project they led
    Specific decision/tradeoff they made
    Named artifact (talk, article, paper by title)
    Generic "passionate about X" or "known for Y"
    Job history without specifics

4. SCORE EACH HOOK (0.01.0):
   score_intent_fit: How well does this connect to sender's purpose?
   - 1.0 = perfect bridge
   - 0.7 = strong relevance
   - 0.5 = weak connection
   Only return hooks with score_intent_fit >= 0.5.

5. LIKE_YOU INGREDIENTS (for each hook):
   - shared_axis: domain both care about
   - shared_action: what they both do
   - shared_stakes: why it matters

6. EARLY STOP POLICY:
   - If you find 2 hooks with score_intent_fit >= 0.7, STOP and return immediately.
   - Quality over quantity: better to have 1 excellent hook (0.8+) than 2 mediocre ones.

7. FALLBACK_MODE:
   - "sufficient": 2 hooks found (score_intent_fit >= 0.7) OR 1 excellent hook (>= 0.8)
   - "minimal": identity passed, but no strong hooks. ALWAYS fill profile_* fields (max 2 items each: education, past companies, named artifacts, key topics).
   - "failed": identity failed or no usable data. Still provide any profile_* data you found.

OUTPUT (max 2 hooks):
{
  "identity_decision": "PASS" | "FAIL",
  "identity_confidence": 0.01.0,
  "identity_canonical_name": "...",
  "identity_company": "...",
  "identity_disambiguators": ["...", "..."],
  "hook_packs": [
    {
      "claim": "...",
      "source_url": "https://...",
      "evidence": "...",
      "evidence_type": "quote" | "named_initiative" | ...,
      "bridge_angle": "domain" | "value" | "tradeoff" | ...,
      "why_relevant": "...",
      "shared_axis": "...",
      "shared_action": "...",
      "shared_stakes": "...",
      "score_intent_fit": 0.8
    }
  ],
  "fallback_mode": "sufficient" | "minimal" | "failed",
  "fallback_reason": "...",
  "profile_education": ["...", "..."],
  "profile_past_companies": ["...", "..."],
  "profile_named_artifacts": ["...", "..."],
  "profile_key_topics": ["...", "..."],
  "citations": [{"url": "...", "title": "..."}]
}

DO NOT fabricate. DO NOT pad with generic facts. Return 2 hooks. PRIORITIZE SPEED.
`;
}

// Raw flattened output from Exa Research API
interface FlatExaResearchOutput {
  identity_canonical_name: string;
  identity_company: string;
  identity_role?: string;
  identity_confidence: number;
  identity_decision: IdentityDecision;
  identity_disambiguators?: string[];
  hook_packs: Array<Record<string, unknown>>;
  fallback_mode: "sufficient" | "minimal" | "failed";
  fallback_reason?: string;
  // Simplified profile fields
  profile_education?: string[];
  profile_past_companies?: string[];
  profile_named_artifacts?: string[];
  profile_key_topics?: string[];
  citations: { url: string; title?: string }[];
  research_notes?: string;
}

interface ExaResearchResult {
  researchId: string;
  status: "pending" | "completed" | "failed";
  output?: FlatExaResearchOutput;
  error?: string;
  latency_ms?: number;
  partial?: boolean; // True if this was partial data grabbed at timeout
  // Debug fields
  exa_http_status?: number;
  exa_response_bytes?: number;
  exa_raw_keys?: string[];
  exa_parse_error?: string;
}

async function createExaResearchTask(
  instructions: string,
  exaApiKey: string,
  generationId: string,
): Promise<{ researchId: string; error?: string }> {
  console.log(`[exa_research] Creating task generation_id=${generationId}`);

  try {
    const response = await fetch("https://api.exa.ai/research/v1", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${exaApiKey}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        instructions,
        outputSchema: EXA_RESEARCH_OUTPUT_SCHEMA,
        model: "exa-research", // Use standard model for cost efficiency
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`[exa_research] Create task failed: status=${response.status} body=${errorText} generation_id=${generationId}`);
      return { researchId: "", error: `Exa API error: ${response.status}` };
    }

    const data = await response.json();
    console.log(`[exa_research] Task created: researchId=${data.researchId} generation_id=${generationId}`);
    return { researchId: data.researchId };
  } catch (e) {
    console.error(`[exa_research] Create task error: ${e} generation_id=${generationId}`);
    return { researchId: "", error: String(e) };
  }
}

async function pollExaResearchTask(
  researchId: string,
  exaApiKey: string,
  generationId: string,
  timeoutMs: number = EXA_RESEARCH_TIMEOUT_MS,
): Promise<ExaResearchResult> {
  const startTime = Date.now();
  let pollCount = 0;

  while (Date.now() - startTime < timeoutMs) {
    pollCount++;

    try {
      const response = await fetch(`https://api.exa.ai/research/v1/${researchId}`, {
        method: "GET",
        headers: {
          Authorization: `Bearer ${exaApiKey}`,
        },
      });

      // DEBUG: Capture HTTP status
      const httpStatus = response.status;

      if (!response.ok) {
        const errorText = await response.text();
        console.error(`[exa_research] Poll failed: status=${response.status} body=${errorText} generation_id=${generationId}`);
        return {
          researchId,
          status: "failed",
          error: `Exa poll error: ${response.status}`,
          latency_ms: Date.now() - startTime,
          exa_http_status: httpStatus,
        };
      }

      // DEBUG: Capture raw response text before parsing
      const rawText = await response.text();
      const responseBytes = rawText.length;

      let data: any;
      let parseError: string | undefined;
      try {
        data = JSON.parse(rawText);
      } catch (e) {
        parseError = String(e);
        console.error(`[exa_research] Parse error: ${e} generation_id=${generationId}`);
        return {
          researchId,
          status: "failed",
          error: `JSON parse error: ${parseError}`,
          latency_ms: Date.now() - startTime,
          exa_http_status: httpStatus,
          exa_response_bytes: responseBytes,
          exa_parse_error: parseError,
        };
      }

      // DEBUG: Capture top-level keys
      const rawKeys = Object.keys(data);
      const elapsed = Date.now() - startTime;

      console.log(`[exa_research] Poll ${pollCount}: status=${data.status} elapsed=${elapsed}ms http_status=${httpStatus} bytes=${responseBytes} keys=${rawKeys.join(',')} generation_id=${generationId}`);

      if (data.status === "completed") {
        const latency = Date.now() - startTime;
        console.log(`[exa_research] Completed in ${latency}ms (${pollCount} polls) generation_id=${generationId}`);

        // Extract parsed output - Exa returns it in data.output, not data.result.parsed
        const parsed = data.output;
        console.log(`[exa_research] Output present: ${!!parsed}, type: ${typeof parsed}, generation_id=${generationId}`);

        if (!parsed) {
          console.error(`[exa_research] No output in response. Full data:`, JSON.stringify(data, null, 2));
          return {
            researchId,
            status: "failed",
            error: "No parsed output in response",
            latency_ms: latency,
            exa_http_status: httpStatus,
            exa_response_bytes: responseBytes,
            exa_raw_keys: rawKeys,
          };
        }

        return {
          researchId,
          status: "completed",
          output: parsed,
          latency_ms: latency,
          exa_http_status: httpStatus,
          exa_response_bytes: responseBytes,
          exa_raw_keys: rawKeys,
        };
      }

      if (data.status === "failed") {
        return {
          researchId,
          status: "failed",
          error: data.error || "Research task failed",
          latency_ms: Date.now() - startTime,
          exa_http_status: httpStatus,
          exa_response_bytes: responseBytes,
          exa_raw_keys: rawKeys,
        };
      }

      // Still pending, wait and poll again
      await new Promise((resolve) => setTimeout(resolve, EXA_RESEARCH_POLL_INTERVAL_MS));
    } catch (e) {
      console.error(`[exa_research] Poll error: ${e} generation_id=${generationId}`);
      // Continue polling unless timeout
    }
  }

  // Timeout - make one final attempt to grab partial results
  console.error(`[exa_research] Timeout after ${timeoutMs}ms, attempting final poll for partial results generation_id=${generationId}`);

  try {
    const response = await fetch(`https://api.exa.ai/research/v1/${researchId}`, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${exaApiKey}`,
      },
    });

    if (response.ok) {
      const rawText = await response.text();
      const data = JSON.parse(rawText);

      console.log(`[exa_research] Final poll status: ${data.status} generation_id=${generationId}`);

      // If we have any output, even if status is still "pending", try to use it
      // BUT: Only accept it if it has the minimum required structure
      if (data.output && typeof data.output === 'object') {
        console.log(`[exa_research] Found partial output on timeout. Output keys: ${Object.keys(data.output).join(', ')} generation_id=${generationId}`);
        console.log(`[exa_research] Partial output structure: has_hook_packs=${!!data.output.hook_packs}, has_identity_decision=${!!data.output.identity_decision}, has_fallback_mode=${!!data.output.fallback_mode} generation_id=${generationId}`);
        console.log(`[exa_research] Full partial output: ${JSON.stringify(data.output, null, 2)}`);

        // Ensure minimum required fields exist with defaults
        const normalizedOutput: FlatExaResearchOutput = {
          identity_canonical_name: data.output.identity_canonical_name || "",
          identity_company: data.output.identity_company || "",
          identity_role: data.output.identity_role || "",
          identity_confidence: typeof data.output.identity_confidence === 'number' ? data.output.identity_confidence : 0,
          identity_decision: (data.output.identity_decision as IdentityDecision) || "FAIL",
          identity_disambiguators: Array.isArray(data.output.identity_disambiguators) ? data.output.identity_disambiguators : [],
          hook_packs: Array.isArray(data.output.hook_packs) ? data.output.hook_packs : [],
          fallback_mode: (data.output.fallback_mode as "sufficient" | "minimal" | "failed") || "failed",
          fallback_reason: data.output.fallback_reason || "Partial results at timeout",
          profile_education: Array.isArray(data.output.profile_education) ? data.output.profile_education : [],
          profile_past_companies: Array.isArray(data.output.profile_past_companies) ? data.output.profile_past_companies : [],
          profile_named_artifacts: Array.isArray(data.output.profile_named_artifacts) ? data.output.profile_named_artifacts : [],
          profile_key_topics: Array.isArray(data.output.profile_key_topics) ? data.output.profile_key_topics : [],
          citations: Array.isArray(data.output.citations) ? data.output.citations : [],
          research_notes: data.output.research_notes || "Partial results captured at timeout",
        };

        return {
          researchId,
          status: "completed",
          output: normalizedOutput,
          latency_ms: timeoutMs,
          partial: true, // Flag to indicate this was partial data at timeout
        };
      }
    }
  } catch (e) {
    console.error(`[exa_research] Final poll failed: ${e} generation_id=${generationId}`);
  }

  return {
    researchId,
    status: "failed",
    error: `Research timeout after ${timeoutMs}ms`,
    latency_ms: timeoutMs,
  };
}

// ============= V2 RESEARCH RESULT (OUTPUT CONTRACT) =============

interface V2ResearchResult {
  hookPacks: HookPack[];
  senderIntentProfile: SenderIntentProfile | null;
  profileSummary?: ProfileSummary;
  minimalResearch: boolean;
  exaResearchId?: string;
  exaResearchLatencyMs?: number;
  exaPartialResults?: boolean; // True if results were grabbed at timeout
  citations: { url: string; title?: string }[];
  identityDecision: IdentityDecision;
  identityConfidence: number;
  notes?: string;
  // Exa debug fields
  exa_http_status?: number;
  exa_response_bytes?: number;
  exa_raw_keys?: string[];
  exa_parse_error?: string;
}

async function performV2Research(
  recipientName: string,
  recipientCompany: string,
  recipientRole: string,
  reachingOutBecause: string,
  credibilityStory: string,
  askType: AskType,
  exaApiKey: string,
  GEMINI_API_KEY: string,
  generationId: string,
): Promise<V2ResearchResult> {
  console.log(`=== V2 Research (Exa Research API) === generation_id=${generationId}`);

  // Stage 0: Extract sender intent profile (still useful for email generation context)
  let intentProfile: SenderIntentProfile;
  try {
    intentProfile = await extractSenderIntentProfile(
      reachingOutBecause,
      credibilityStory,
      askType,
      GEMINI_API_KEY,
    );

    console.log("Sender Intent Profile:", {
      primary_theme: intentProfile.primary_theme,
      must_include_terms: intentProfile.must_include_terms.slice(0, 5),
    });
  } catch (e) {
    console.error(`[sender_intent] Failed to extract sender intent profile: ${e} generation_id=${generationId}`);
    return {
      hookPacks: [],
      senderIntentProfile: null,
      minimalResearch: true,
      citations: [],
      identityDecision: "FAIL",
      identityConfidence: 0,
      notes: `Failed to extract sender intent profile: ${e instanceof Error ? e.message : String(e)}`,
    };
  }

  // Build instructions for Exa Research
  const instructions = buildExaResearchInstructions(
    recipientName,
    recipientCompany,
    recipientRole,
    reachingOutBecause,
    credibilityStory,
    askType,
  );

  // Create Exa Research task
  const { researchId, error: createError } = await createExaResearchTask(
    instructions,
    exaApiKey,
    generationId,
  );

  if (createError || !researchId) {
    console.error(`[exa_research] Failed to create task: ${createError} generation_id=${generationId}`);
    return {
      hookPacks: [],
      senderIntentProfile: intentProfile,
      minimalResearch: true,
      citations: [],
      identityDecision: "FAIL",
      identityConfidence: 0,
      notes: `Exa Research task creation failed: ${createError}`,
    };
  }

  // Poll for completion
  const result = await pollExaResearchTask(researchId, exaApiKey, generationId);

  if (result.status === "failed" || !result.output) {
    console.error(`[exa_research] Task failed: ${result.error} generation_id=${generationId}`);
    return {
      hookPacks: [],
      senderIntentProfile: intentProfile,
      minimalResearch: true,
      exaResearchId: researchId,
      exaResearchLatencyMs: result.latency_ms,
      citations: [],
      identityDecision: "FAIL",
      identityConfidence: 0,
      notes: `Exa Research failed: ${result.error}`,
      exa_http_status: result.exa_http_status,
      exa_response_bytes: result.exa_response_bytes,
      exa_raw_keys: result.exa_raw_keys,
      exa_parse_error: result.exa_parse_error,
    };
  }

  // Consume the output (TRUST THE SCHEMA - map flattened to internal types)
  const output = result.output;

  console.log(`[exa_research] About to process output. Output keys: ${Object.keys(output).join(', ')} generation_id=${generationId}`);
  console.log(`[exa_research] Output has hook_packs: ${!!output.hook_packs}, hook_packs type: ${typeof output.hook_packs}, is_array: ${Array.isArray(output.hook_packs)} generation_id=${generationId}`);
  console.log(`[exa_research] identity_decision=${output.identity_decision} confidence=${output.identity_confidence} hook_packs=${output.hook_packs?.length || 0} fallback_mode=${output.fallback_mode} generation_id=${generationId}`);

  // Map flattened hook_packs to internal HookPack type
  const hookPacks: HookPack[] = output.hook_packs ? output.hook_packs.map(mapFlatHookPackToInternal) : [];

  // Build profile summary from flattened fields if needed
  // IMPORTANT: Always build profile in minimal/failed mode so LLM has context even on timeout
  let profileSummary: ProfileSummary | undefined;
  const fallbackMode = output.fallback_mode || "failed";

  if (fallbackMode === "minimal" || fallbackMode === "failed") {
    const hasProfileData =
      (output.profile_education && output.profile_education.length > 0) ||
      (output.profile_past_companies && output.profile_past_companies.length > 0) ||
      (output.profile_named_artifacts && output.profile_named_artifacts.length > 0) ||
      (output.profile_key_topics && output.profile_key_topics.length > 0);

    if (hasProfileData) {
      // Use identity fields from Exa as fallback to user-provided fields
      const role = output.identity_role || recipientRole;
      const company = output.identity_company || recipientCompany;

      profileSummary = {
        current_role: role,
        current_company: company,
        education: output.profile_education || [],
        past_companies: output.profile_past_companies || [],
        skills: output.profile_key_topics || [], // Map key_topics to skills for compatibility
        career_trajectory: undefined, // Not in new schema
        likely_interests: output.profile_named_artifacts || [], // Map artifacts to interests
        source: "exa_research",
      };
    }
  }

  const isMinimalResearch = hookPacks.length === 0 || fallbackMode !== "sufficient";

  return {
    hookPacks,
    senderIntentProfile: intentProfile,
    profileSummary,
    minimalResearch: isMinimalResearch,
    exaResearchId: researchId,
    exaResearchLatencyMs: result.latency_ms,
    exaPartialResults: result.partial || false,
    citations: output.citations || [],
    identityDecision: output.identity_decision || "FAIL",
    identityConfidence: output.identity_confidence || 0,
    notes: output.research_notes || output.fallback_reason || "No research notes available",
    exa_http_status: result.exa_http_status,
    exa_response_bytes: result.exa_response_bytes,
    exa_raw_keys: result.exa_raw_keys,
    exa_parse_error: result.exa_parse_error,
  };
}

// ============= STAGE 0: SENDER INTENT PROFILE (KEPT) =============

async function extractSenderIntentProfile(
  reachingOutBecause: string,
  credibilityStory: string,
  askType: AskType,
  GEMINI_API_KEY: string,
): Promise<SenderIntentProfile> {
  console.log("=== Stage 0: Extract Sender Intent Profile ===");

  const prompt = `Analyze the sender's intent and extract a profile for research targeting.

SENDER CONTEXT:
- Why reaching out: "${reachingOutBecause}"
- Credibility story: "${credibilityStory}"
- Ask type: ${askType}

TASK:
Extract a Sender Intent Profile that captures what the sender ACTUALLY cares about.

OUTPUT JSON ONLY:
{
  "primary_theme": "the core topic/domain (e.g., 'inclusion / Black leadership pipeline', 'AI safety')",
  "secondary_themes": ["optional", "secondary", "themes"],
  "must_include_terms": ["6-12 terms likely to appear in relevant content"],
  "avoid_terms": ["4-10 terms that indicate irrelevant content"],
  "preferred_evidence_types": ["quote", "named_initiative", "described_decision"]
}`;

  try {
    const response = await callLLM(
      GEMINI_API_KEY,
      "You extract sender intent profiles to guide cold email research. Be specific about themes and terms.",
      prompt,
    );

    const cleaned = response.replace(/```json\n?|\n?```/g, "").trim();
    const parsed = JSON.parse(cleaned);

    return {
      primary_theme: parsed.primary_theme || "",
      secondary_themes: parsed.secondary_themes || [],
      must_include_terms: parsed.must_include_terms || [],
      avoid_terms: parsed.avoid_terms || [],
      preferred_evidence_types: parsed.preferred_evidence_types || ["quote", "named_initiative", "described_decision"],
    };
  } catch (e) {
    console.error("Failed to extract sender intent profile:", e);

    // Fallback: extract simple keywords
    const combinedText = `${reachingOutBecause} ${credibilityStory}`.toLowerCase();
    const simpleTerms = extractSimpleKeywords(combinedText);

    return {
      primary_theme: reachingOutBecause.substring(0, 50),
      secondary_themes: [],
      must_include_terms: simpleTerms.slice(0, 8),
      avoid_terms: [],
      preferred_evidence_types: ["quote", "named_initiative", "described_decision"],
    };
  }
}

function extractSimpleKeywords(text: string): string[] {
  const stopwords = new Set([
    "i", "me", "my", "we", "our", "you", "your", "the", "a", "an", "and", "or", "but",
    "to", "for", "of", "in", "on", "at", "by", "with", "is", "are", "was", "were",
    "be", "been", "have", "has", "had", "do", "does", "did", "will", "would", "could",
    "should", "this", "that", "these", "those", "it", "its", "about", "who", "what",
    "where", "when", "why", "how",
  ]);

  return text
    .toLowerCase()
    .replace(/[^\w\s]/g, " ")
    .split(/\s+/)
    .filter((w) => w.length > 3 && !stopwords.has(w))
    .slice(0, 12);
}

// ============= HELPER FUNCTIONS =============

async function callLLM(
  GEMINI_API_KEY: string,
  systemPrompt: string,
  userPrompt: string,
  modelName: string = MODEL_NAME,
): Promise<string> {
  // Direct Google Gemini API call
  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      contents: [{
        parts: [{
          text: `${systemPrompt}\n\n${userPrompt}`
        }]
      }],
      generationConfig: {
        temperature: 0.7,
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 8192,
      }
    }),
  });

  if (!response.ok) {
    const errorText = await response.text();
    console.error("Gemini API error:", response.status, errorText);
    throw new Error(`Gemini API error (${response.status}): ${errorText}`);
  }

  const data = await response.json();
  console.log("Gemini API response:", JSON.stringify(data, null, 2));

  // Better error handling for response structure
  if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
    console.error("Unexpected Gemini response structure:", JSON.stringify(data, null, 2));
    throw new Error(`Unexpected Gemini API response structure: ${JSON.stringify(data)}`);
  }

  return data.candidates[0].content.parts[0].text;
}

// ============= VALIDATION CONSTANTS =============

const BANNED_CLICHES = [
  "i'm reaching out because", "reaching out because", "passionate about",
  "would love to connect", "keen interest", "impact at scale", "innovative solutions",
  "extensive experience", "impressed by", "exceptional track record",
  "exploring career paths", "thought leadership", "fostering", "driving impact",
  "deeply resonated", "your incredible", "your remarkable", "your impressive",
  "dedicated my career", "share a commitment", "believe in the importance",
];

const GENERIC_LIKE_YOU_PATTERNS = [
  "passionate about", "think a lot about", "reaching out", "aligned with",
  "resonates", "inspired", "keen to", "deeply appreciate", "share a commitment",
  "believe in", "dedicated to", "driving", "fostering", "cultivating", "championing",
];

const BANNED_LIKE_YOU_VERBS = ["believe", "think", "care", "passionate", "focused", "committed", "want to"];

const CORPORATE_PADDING_PHRASES = [
  "in the space", "thought leader", "synergy", "leverage", "ecosystem", "holistic",
  "paradigm", "stakeholder", "best practices", "core competencies", "value proposition",
  "move the needle", "circle back", "take this offline",
];

const ROBOTIC_VOICE_PATTERNS = [
  "i came across", "i stumbled upon", "i noticed that you", "i was particularly struck",
  "i was impressed", "i was drawn to", "i wanted to reach out", "i hope this email finds you",
  "i would love to", "i'd love to connect", "i believe we could", "i think there's an opportunity",
  "excited to explore", "keen to discuss", "eager to learn", "looking forward to the opportunity",
  "would be thrilled", "would be honored", "greatly appreciate", "truly appreciate",
  "deeply appreciate", "resonate deeply", "resonated with me", "speaks to my",
  "aligns perfectly", "perfectly aligned", "really stood out", "caught my attention",
  "piqued my interest",
];

// ============= VALIDATION =============

function countWords(text: string): number {
  return text.trim().split(/\s+/).filter((w) => w.length > 0).length;
}

function hasEmDash(text: string): boolean {
  return text.includes("");
}

function countLikeYouCapitalized(text: string): number {
  const matches = text.match(/Like you,/g);
  return matches ? matches.length : 0;
}

function countLikeYouAny(text: string): number {
  const lowerText = text.toLowerCase();
  const matches = lowerText.match(/like you/g);
  return matches ? matches.length : 0;
}

function extractSentenceWithLikeYou(body: string): string | null {
  const sentences = body.split(/(?<=[.!?])\s+/);
  for (const sentence of sentences) {
    if (sentence.toLowerCase().includes("like you")) {
      return sentence;
    }
  }
  return null;
}

function countCliches(text: string): number {
  const lowerText = text.toLowerCase();
  let count = 0;
  for (const cliche of BANNED_CLICHES) {
    if (lowerText.includes(cliche)) count++;
  }
  return count;
}

function hasBracketPlaceholders(text: string): boolean {
  return /\[[A-Za-z]+\]/.test(text);
}

function validateEmail(rawText: string, recipientFirstName: string): ValidationResult {
  const errors: string[] = [];

  let parsed: { subject?: string; body?: string };
  try {
    const cleaned = rawText.replace(/```json\n?|\n?```/g, "").trim();
    parsed = JSON.parse(cleaned);
  } catch {
    errors.push("Output was not valid JSON");
    return { valid: false, errors, likeYouCount: 0, wordCount: 0, clicheCount: 0 };
  }

  if (!parsed.subject || typeof parsed.subject !== "string") {
    errors.push('Missing or invalid "subject" field');
  }
  if (!parsed.body || typeof parsed.body !== "string") {
    errors.push('Missing or invalid "body" field');
  }

  if (errors.length > 0) {
    return { valid: false, errors, likeYouCount: 0, wordCount: 0, clicheCount: 0 };
  }

  const subject = parsed.subject!;
  const body = parsed.body!;
  const combinedText = `${subject} ${body}`;

  const likeYouCapCount = countLikeYouCapitalized(body);
  const likeYouAnyCount = countLikeYouAny(body);

  if (likeYouCapCount === 0) {
    if (likeYouAnyCount > 0) {
      errors.push('Body contains "like you" but not in correct format. Must be "Like you," (capital L, comma)');
    } else {
      errors.push('Body must contain the exact phrase "Like you," (capital L, comma)');
    }
  } else if (likeYouCapCount > 1) {
    errors.push(`Body contains "Like you," ${likeYouCapCount} times (must be exactly once)`);
  }

  if (likeYouAnyCount >= 1) {
    const likeYouSentence = extractSentenceWithLikeYou(body);
    if (likeYouSentence) {
      const lowerSentence = likeYouSentence.toLowerCase();
      
      for (const pattern of GENERIC_LIKE_YOU_PATTERNS) {
        if (lowerSentence.includes(pattern)) {
          errors.push(`The "Like you," sentence contains generic phrase "${pattern}"`);
          break;
        }
      }
      
      for (const verb of BANNED_LIKE_YOU_VERBS) {
        const verbRegex = new RegExp(`\\b${verb}\\b`, 'i');
        if (verbRegex.test(likeYouSentence)) {
          errors.push(`The "Like you," sentence contains banned verb "${verb}" - express shared lived reality, not beliefs`);
          break;
        }
      }
    }
  }

  let clicheCount = 0;
  for (const cliche of BANNED_CLICHES) {
    if (combinedText.toLowerCase().includes(cliche)) {
      errors.push(`Contains banned clich: "${cliche}"`);
      clicheCount++;
    }
  }

  if (hasBracketPlaceholders(combinedText)) {
    errors.push("Contains bracket placeholders like [Name]");
  }

  const bodyLines = body.split("\n").map((l) => l.trim()).filter((l) => l.length > 0);
  if (bodyLines.length > 0) {
    const firstLine = bodyLines[0];
    const validGreeting1 = `Hi ${recipientFirstName},`;
    const validGreeting2 = `${recipientFirstName},`;
    if (!firstLine.startsWith(validGreeting1) && !firstLine.startsWith(validGreeting2)) {
      errors.push(`Greeting must start with "Hi ${recipientFirstName}," or "${recipientFirstName},"`);
    }
  }

  if (bodyLines.length > 0) {
    const lastLine = bodyLines[bodyLines.length - 1];
    if (lastLine !== "Best,") {
      errors.push('Body must end with exactly "Best," and nothing after');
    }
  }

  if (hasEmDash(body)) {
    errors.push("Body contains em-dash () which is banned");
  }
  if (hasEmDash(subject)) {
    errors.push("Subject contains em-dash () which is banned");
  }

  if (body.includes("...") || body.includes("")) {
    errors.push("Body contains ellipsis (... or ) which is banned");
  }

  const wordCount = countWords(body);
  if (wordCount < 60) {
    errors.push(`Body has ${wordCount} words (minimum 60 required)`);
  }
  if (wordCount > 150) {
    errors.push(`Body has ${wordCount} words (maximum 150 allowedshorter is better)`);
  }

  for (const phrase of CORPORATE_PADDING_PHRASES) {
    if (combinedText.toLowerCase().includes(phrase)) {
      errors.push(`Contains corporate padding phrase: "${phrase}"`);
    }
  }

  const roboticMatches: string[] = [];
  for (const pattern of ROBOTIC_VOICE_PATTERNS) {
    if (combinedText.toLowerCase().includes(pattern)) {
      roboticMatches.push(pattern);
    }
  }
  if (roboticMatches.length > 0) {
    errors.push(`Sounds robotic/generic. Remove: "${roboticMatches[0]}". Write like you'd text a friend.`);
  }

  const sentences = body.split(/[.!?]+/).filter((s) => s.trim().length > 0);
  for (const sentence of sentences) {
    const sentenceWords = countWords(sentence);
    if (sentenceWords > 35) {
      errors.push(`Contains a ${sentenceWords}-word sentence (max 35). Break it up.`);
      break;
    }
  }

  const likeYouSentenceForAbstraction = extractSentenceWithLikeYou(body);
  if (likeYouSentenceForAbstraction) {
    const likeYouWords = countWords(likeYouSentenceForAbstraction);
    if (likeYouWords > 30) {
      errors.push(`"Like you," sentence is ${likeYouWords} words (aim for under 25)`);
    }
  }

  // Opening sentence validation
  const contentLines = bodyLines.slice(1).filter((l) => l !== "Best,");
  if (contentLines.length > 0) {
    const firstParagraph = contentLines[0];
    const firstSentenceMatch = firstParagraph.match(/^[^.!?]+[.!?]/);
    const firstSentence = firstSentenceMatch ? firstSentenceMatch[0].toLowerCase() : firstParagraph.toLowerCase();

    const BANNED_OPENING_PATTERNS = [
      /^i read\b/, /^i saw\b/, /^i came across\b/, /^i found\b/, /^i noticed\b/,
      /^i stumbled\b/, /^i discovered\b/, /^i was reading\b/, /^i was looking\b/,
      /^i wanted to reach out\b/, /^reaching out\b/, /^i'm reaching out\b/, /^i'm writing\b/,
      /^i'll keep this short\b/, /^quick question\b/, /^quick note\b/, /^random question\b/,
      /^this might be out of the blue\b/, /^i'm a huge fan\b/, /^i've long admired\b/, /^i've been following\b/,
      /^i'm a\b/, /^i am a\b/, /^i'm an\b/, /^i am an\b/, /^my name is\b/,
      /^i work at\b/, /^i work as\b/, /^i just finished\b/, /^i'm working on\b/, /^i'm building\b/, /^i'm currently\b/,
    ];

    const SELF_INTRO_PATTERNS = [
      /^i'm a\b/, /^i am a\b/, /^i'm an\b/, /^i am an\b/, /^my name is\b/,
      /^i work at\b/, /^i work as\b/, /^i just finished\b/, /^i'm working on\b/, /^i'm building\b/, /^i'm currently\b/,
    ];

    let foundBanned = false;
    for (const pattern of SELF_INTRO_PATTERNS) {
      if (pattern.test(firstSentence)) {
        errors.push(`Opening sentence is self-intro  lead with what you're OFFERING (event/product/ask), not who you ARE.`);
        foundBanned = true;
        break;
      }
    }

    if (!foundBanned) {
      for (const pattern of BANNED_OPENING_PATTERNS) {
        if (pattern.test(firstSentence)) {
          errors.push(`Opening sentence starts with banned pattern  lead with sender-side news or a specific detail`);
          break;
        }
      }
    }
  }

  return {
    valid: errors.length === 0,
    errors,
    likeYouCount: likeYouCapCount,
    wordCount,
    clicheCount,
  };
}

function buildRetryInstruction(errors: string[], recipientFirstName?: string): string {
  const errorList = errors.map((e) => `- ${e}`).join("\n");

  const greetingReminder = recipientFirstName
    ? `- Email body MUST start with "Hi ${recipientFirstName}," on its own line`
    : '- Email body MUST start with "Hi [Name]," on its own line';

  return `

REWRITE REQUIRED  your previous output had issues:
${errorList}

VOICE REMINDER (most important):
- Write like you're texting a smart friend, not drafting a memo
- The "Like you," line should be the most NATURAL sentence, not the most formal
- Shorter is better. If it can be said in fewer words, do it.
- Reference specific things (names, projects, numbers) not abstractions

HARD FIXES:
${greetingReminder}
- "Like you," must appear exactly once (capital L, comma after)
- "Like you," sentence must be under 25 words and feel natural
- Readable in under 20 seconds. Shorter is better. Do not pad.
- End with just "Best," 
- No em-dashes, no brackets, no corporate buzzwords

Return ONLY valid JSON with "subject" and "body".`;
}

function getAskTypeLabel(askType: string): string {
  const labels: Record<string, string> = {
    chat: "a short introductory chat",
    feedback: "feedback on something",
    referral: "a referral or introduction",
    job: "job or recruiting related discussion",
    other: "other",
  };
  return labels[askType] || askType;
}

function buildProfileSummaryPromptSection(summary: ProfileSummary): string {
  const sections: string[] = [];

  sections.push(`RECIPIENT PROFILE (limited research - be honest about what you know):`);
  sections.push(`- Current: ${summary.current_role} at ${summary.current_company}`);

  if (summary.career_trajectory) {
    sections.push(`- Career path: ${summary.career_trajectory}`);
  }

  if (summary.education.length > 0) {
    sections.push(`- Education: ${summary.education.slice(0, 3).join(", ")}`);
  }

  if (summary.past_companies.length > 0 && !summary.career_trajectory) {
    sections.push(`- Previously at: ${summary.past_companies.slice(0, 3).join(", ")}`);
  }

  if (summary.skills.length > 0) {
    sections.push(`- Skills/expertise: ${summary.skills.slice(0, 5).join(", ")}`);
  }

  if (summary.likely_interests.length > 0) {
    sections.push(`- Likely cares about: ${summary.likely_interests.slice(0, 3).join(", ")}`);
  }

  sections.push(`
IMPORTANT - MINIMAL RESEARCH MODE:
We could not find specific interviews, podcasts, or quotes from this person.
DO NOT fabricate specific facts, quotes, or initiatives.

For your "Like you," line, use ONE of these approaches:
1. SHARED TRAJECTORY: If you share a similar career path
2. SHARED DOMAIN: If you work in the same space/industry
3. SHARED CHALLENGE: Reference a challenge common to their role

DO NOT USE generic phrases like "Like you, I'm passionate about..." or "Like you, I believe in..."`);

  return sections.join("\n");
}

// ============= MAIN HANDLER =============

serve(async (req) => {
  const generationId = crypto.randomUUID();

  // Initialize trace for debugging
  const trace: Array<{ stage: string; decision?: string; counts?: Record<string, number | string> }> = [];

  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  const startTime = Date.now();

  try {
    const body = await req.json();

    const recipientName = body.recipientName || "";
    const recipientCompany = body.recipientCompany || "";
    const recipientRole = body.recipientRole || "";
    const askType = (body.askType || "chat") as AskType;
    const reachingOutBecause = body.reachingOutBecause || "";
    const credibilityStory = body.credibilityStory || "";
    const sharedAffiliation = body.sharedAffiliation || null;

    // NEW: Accept selected hook from research_jobs flow
    const selectedHook = body.selectedHook || null;

    const source = body.source || "app";
    const scenarioName = body.scenario_name || body.scenarioName || null;
    const sessionId = body.sessionId || null;
    const includeDebug = body.includeDebug || source === "test_harness";
    
    // BOOT log
    console.log(`BOOT generate-email deploy_version=${DEPLOY_VERSION} generation_id=${generationId} session_id=${sessionId}`);
    
    const responseHeaders = buildResponseHeaders(generationId);

    // Input validation
    if (!recipientName || recipientName.length < 2 || recipientName.length > 100) {
      return new Response(JSON.stringify({ error: "Invalid recipient name" }), {
        status: 400,
        headers: responseHeaders,
      });
    }

    if (!recipientCompany || recipientCompany.length < 1 || recipientCompany.length > 100) {
      return new Response(JSON.stringify({ error: "Invalid company name" }), {
        status: 400,
        headers: responseHeaders,
      });
    }

    if (!recipientRole || recipientRole.length < 1 || recipientRole.length > 100) {
      return new Response(JSON.stringify({ error: "Invalid role/title" }), {
        status: 400,
        headers: responseHeaders,
      });
    }

    if (!credibilityStory || credibilityStory.length < 10 || credibilityStory.length > 1000) {
      return new Response(JSON.stringify({ error: "Credibility story must be between 10 and 1000 characters" }), {
        status: 400,
        headers: responseHeaders,
      });
    }

    if (!reachingOutBecause || reachingOutBecause.length < 5 || reachingOutBecause.length > 500) {
      return new Response(JSON.stringify({ error: "Please explain why you are reaching out (5-500 characters)" }), {
        status: 400,
        headers: responseHeaders,
      });
    }

    const recipientFirstName = recipientName.split(" ")[0];

    // Trace: input validation passed
    trace.push({
      stage: "input_validation",
      decision: "passed",
      counts: { fields_validated: 5 },
    });

    const inputJson = {
      recipientName,
      recipientCompany,
      recipientRole,
      askType,
      reachingOutBecause,
      credibilityStory,
      sharedAffiliation,
    };

    const GEMINI_API_KEY = Deno.env.get("GEMINI_API_KEY");
    const EXA_API_KEY = Deno.env.get("EXA_API_KEY");

    if (!GEMINI_API_KEY) {
      console.error("GEMINI_API_KEY is not configured");
      return new Response(JSON.stringify({ error: "Failed to generate email. Please try again." }), {
        status: 500,
        headers: responseHeaders,
      });
    }

    // ============= V2 RESEARCH =============
    // NEW FLOW: If selectedHook is provided, skip research (frontend already did it via research_jobs)
    // OLD FLOW: Still support direct Exa Research Agent call for backwards compatibility
    let researchResult: V2ResearchResult | null = null;

    if (selectedHook) {
      console.log("Using pre-selected hook from research_jobs flow");
      console.log(`Selected hook: "${selectedHook.title}" (confidence: ${selectedHook.confidence})`);

      // Trace: using selected hook
      trace.push({
        stage: "research_source",
        decision: "using_selected_hook",
        counts: {
          hook_confidence: selectedHook.confidence,
        },
      });

      // We'll use selectedHook directly in email generation below
      // No need to populate researchResult for the new flow
    } else if (EXA_API_KEY) {
      console.log("Starting V2 research (Exa Research API - legacy flow)...");

      // Trace: research start
      trace.push({
        stage: "exa_research_start",
        decision: "exa_api_key_present",
      });

      try {
        researchResult = await performV2Research(
          recipientName,
          recipientCompany,
          recipientRole,
          reachingOutBecause,
          credibilityStory,
          askType,
          EXA_API_KEY,
          GEMINI_API_KEY,
          generationId,
        );

        console.log(`V2 Research complete: ${researchResult.hookPacks.length} Hook Packs, identity=${researchResult.identityDecision}`);

        // Trace: research complete
        trace.push({
          stage: "exa_research_complete",
          decision: researchResult.identityDecision,
          counts: {
            hook_packs: researchResult.hookPacks.length,
            citations: researchResult.citations.length,
            identity_confidence: researchResult.identityConfidence,
          },
        });
      } catch (e) {
        console.error("V2 Research pipeline failed:", e);
        console.error("Error details:", e instanceof Error ? e.message : String(e));
        trace.push({
          stage: "exa_research_complete",
          decision: "error",
          counts: { hook_packs: 0 },
          error: e instanceof Error ? e.message : String(e),
        });
        // Don't set researchResult - it will remain undefined and we'll proceed without hooks
      }
    } else {
      console.log("No research data provided and EXA_API_KEY not configured");
      trace.push({
        stage: "research_source",
        decision: "no_research_available",
      });
    }

    // ============= GENERATE EMAIL =============
    console.log("=== Generate Email ===");

    // Build shared affiliation section if provided
    let sharedAffiliationSection = "";
    if (sharedAffiliation && sharedAffiliation.name) {
      sharedAffiliationSection = `
SHARED AFFILIATION (user-declared, use ONLY as last resort for "Like you," connection):
- Connection: ${sharedAffiliation.name}
${sharedAffiliation.detail ? `- Sender's connection: ${sharedAffiliation.detail}` : ""}

IMPORTANT: Only use this if no stronger craft/problem/constraint parallel exists.`;
    }

    // Build Hook Packs section
    let hookPacksSection = "";

    // NEW FLOW: Use selectedHook if provided from research_jobs
    if (selectedHook) {
      const sources = selectedHook.sources || [];
      const sourcesText = sources.map((s: any) => `${s.label}: ${s.url}`).join('\n   ');

      hookPacksSection = `
RESEARCH FOUND (use to craft your "Like you," line):
[SELECTED HOOK] ${selectedHook.title}
   Hook: ${selectedHook.hook}
   Why it works: ${selectedHook.whyItWorks}
   Confidence: ${(selectedHook.confidence * 100).toFixed(0)}%
   ${sourcesText ? `Sources:\n   ${sourcesText}` : ''}

INSTRUCTIONS:
- This hook was specifically selected by the user
- Use it to craft a natural "Like you," line
- Reference the specific fact from the hook somewhere in the email`;
    } else if (researchResult && researchResult.hookPacks.length > 0) {
      const topHookPacks = [...researchResult.hookPacks]
        .sort((a, b) => b.scores.intent_fit - a.scores.intent_fit)
        .slice(0, 2);

      const labels = ["PRIMARY", "BACKUP"];
      hookPacksSection = `
RESEARCH FOUND (use to craft your "Like you," line):
${topHookPacks
  .map(
    (hp, i) => `
[${labels[i]}] SPECIFIC FACT: ${hp.hook_fact.claim}
   Evidence: "${hp.hook_fact.evidence}"
   Source: ${hp.hook_fact.source_url}

   RAW INGREDIENTS FOR "Like you,":
   - What you both do: ${hp.bridge.like_you_ingredients.shared_action}
   - The world you share: ${hp.bridge.like_you_ingredients.shared_axis}
   - Why it matters: ${hp.bridge.like_you_ingredients.shared_stakes}

   Intent fit: ${(hp.scores.intent_fit * 100).toFixed(0)}%
`,
  )
  .join("")}

INSTRUCTIONS:
- Use the PRIMARY hook pack. It has the highest intent fit.
- Rewrite the "Like you," line to sound natural
- Reference the specific fact somewhere in the email`;
    } else if (researchResult?.profileSummary) {
      hookPacksSection = buildProfileSummaryPromptSection(researchResult.profileSummary);
    } else {
      hookPacksSection = `
NO RESEARCH AVAILABLE.
Create the "Like you," bridge from:
- The sender's own story (below)
- What someone in ${recipientRole} at ${recipientCompany} likely cares about
Keep it realdon't pretend you found something you didn't.`;
    }

    const userPrompt = `Write a cold email. Sound human.

TO: ${recipientFirstName} (${recipientRole} at ${recipientCompany})
${hookPacksSection}
${sharedAffiliationSection}

FROM (the sender):
- Wants: ${getAskTypeLabel(askType)}
- Why reaching out: ${reachingOutBecause}
- Their credibility: ${credibilityStory}
${researchResult?.senderIntentProfile ? `- Theme: ${researchResult.senderIntentProfile.primary_theme}` : ""}

REMEMBER:
- Include "Like you," exactly once (capital L, comma)
- Put the "Like you," line in paragraph 1 or 2
- Readable in under 20 seconds. Shorter is better.
- One clear ask at the end
- End with just "Best," (no name after)
- No em-dashes, no brackets, no corporate speak

Return JSON only:
{
  "subject": "...",
  "body": "..."
}`;

    // Generate email with validation and retry
    let rawResponse: string;
    let validation: ValidationResult;
    const enforcementResults: EnforcementResults = {
      did_retry: false,
      failures_first_pass: [],
      failures_retry: [],
    };

    try {
      console.log("Generating email (attempt 1)...");

      // Trace: email generation start
      const topHookPack = researchResult?.hookPacks?.[0];
      trace.push({
        stage: "email_generation_start",
        decision: topHookPack ? "using_primary_hook_pack" : "no_hooks_available",
        counts: {
          hook_packs_available: researchResult?.hookPacks.length || 0,
        },
      });

      rawResponse = await callLLM(GEMINI_API_KEY, SUPER_PROMPT, userPrompt);
      console.log("AI response:", rawResponse);

      validation = validateEmail(rawResponse, recipientFirstName);
      enforcementResults.failures_first_pass = validation.errors;

      if (!validation.valid) {
        console.log("Validation failed (attempt 1):", validation.errors);

        enforcementResults.did_retry = true;
        const retryPrompt = userPrompt + buildRetryInstruction(validation.errors, recipientFirstName);

        console.log("Generating email (attempt 2 - retry)...");
        rawResponse = await callLLM(GEMINI_API_KEY, SUPER_PROMPT, retryPrompt);
        console.log("AI response (retry):", rawResponse);

        validation = validateEmail(rawResponse, recipientFirstName);
        enforcementResults.failures_retry = validation.errors;

        if (!validation.valid) {
          console.log("Validation still failed after retry:", validation.errors);
        } else {
          console.log("Retry succeeded, validation passed");
        }
      } else {
        console.log("Validation passed on first attempt");
      }

      // Trace: email generation complete
      trace.push({
        stage: "email_generation_complete",
        decision: enforcementResults.did_retry ? "retry_used" : "first_attempt_success",
        counts: {
          attempts: enforcementResults.did_retry ? 2 : 1,
          validation_errors: validation.errors.length,
        },
      });
    } catch (error: any) {
      if (error.status === 429) {
        return new Response(JSON.stringify({ error: "Rate limit exceeded. Please try again in a moment." }), {
          status: 429,
          headers: responseHeaders,
        });
      }
      if (error.status === 402) {
        return new Response(JSON.stringify({ error: "AI credits exhausted. Please add credits to continue." }), {
          status: 402,
          headers: responseHeaders,
        });
      }

      console.error("Generation error:", error);
      return new Response(JSON.stringify({ error: "Failed to generate email. Please try again." }), {
        status: 500,
        headers: responseHeaders,
      });
    }

    // Parse final response
    let emailData: { subject: string; body: string };
    try {
      const cleanedContent = rawResponse.replace(/```json\n?|\n?```/g, "").trim();
      emailData = JSON.parse(cleanedContent);
    } catch {
      console.error("Failed to parse final response as JSON");
      return new Response(JSON.stringify({ error: "Failed to generate valid email. Please try again." }), {
        status: 500,
        headers: responseHeaders,
      });
    }

    const latencyMs = Date.now() - startTime;
    const wordCount = countWords(emailData.body);
    const clicheCount = countCliches(emailData.subject + " " + emailData.body);
    const likeYouCount = countLikeYouCapitalized(emailData.body);

    // Trace: final validation stats
    trace.push({
      stage: "final_validation",
      decision: validation.valid ? "passed" : "failed",
      counts: {
        word_count: wordCount,
        like_you_count: likeYouCount,
        cliche_count: clicheCount,
        validator_errors: validation.errors.length,
      },
    });

    // Log analytics
    console.log(`=== GENERATION ANALYTICS === generation_id=${generationId}`);
    console.log(`hook_packs: ${researchResult?.hookPacks.length || 0}`);
    console.log(`intent_profile: ${researchResult?.senderIntentProfile?.primary_theme || "none"}`);
    console.log(`exa_research_id: ${researchResult?.exaResearchId || "none"}`);
    console.log(`exa_research_latency_ms: ${researchResult?.exaResearchLatencyMs || 0}`);
    console.log(`identity_decision: ${researchResult?.identityDecision || "none"}`);
    console.log(`identity_confidence: ${researchResult?.identityConfidence || 0}`);
    console.log(`citations: ${researchResult?.citations.length || 0}`);
    console.log(`did_retry: ${enforcementResults.did_retry}`);
    console.log(`like_you_count: ${likeYouCount}`);
    console.log(`word_count: ${wordCount}`);
    console.log(`validator_passed: ${validation.valid}`);
    console.log(`latency_ms: ${latencyMs}`);
    console.log(`deploy_version: ${DEPLOY_VERSION}`);
    console.log(`============================`);

    // Log to database
    try {
      const supabaseUrl = Deno.env.get("SUPABASE_URL");
      const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

      if (supabaseUrl && supabaseServiceKey) {
        const supabase = createClient(supabaseUrl, supabaseServiceKey);

        const { error: insertError } = await supabase.from("email_generations").insert({
          session_id: sessionId,
          source,
          scenario_name: scenarioName,
          input_json: inputJson,
          prompt_version: PROMPT_VERSION,
          model_name: MODEL_NAME,
          research_model_name: "exa-research",
          subject: emailData.subject,
          body: emailData.body,
          word_count: wordCount,
          cliche_count: clicheCount,
          like_you_count: likeYouCount,
          has_em_dash: hasEmDash(emailData.body),
          validator_passed: validation.valid,
          validator_errors: validation.errors.length > 0 ? validation.errors : null,
          enforcement_results: enforcementResults,
          exa_queries: researchResult?.exaResearchId ? [researchResult.exaResearchId] : [],
          exa_results: researchResult?.citations.map((c) => ({ url: c.url, title: c.title })) || [],
          selected_sources: researchResult?.citations.map((c) => c.url) || [],
          researched_facts: researchResult?.hookPacks.map((hp) => hp.hook_fact.claim) || [],
          latency_ms: latencyMs,
        });

        if (insertError) {
          console.error("Failed to log generation:", insertError);
        }
      }
    } catch (logError) {
      console.error("Logging error:", logError);
    }

    // Build response
    const hookPacks = researchResult?.hookPacks || [];

    // Legacy format for UI
    const hookFacts = hookPacks.map((hp) => ({
      claim: hp.hook_fact.claim,
      source_url: hp.hook_fact.source_url,
      evidence_quote: hp.hook_fact.evidence,
      why_relevant: hp.bridge.why_relevant,
      bridge_type: hp.bridge.bridge_angle === "domain" ? ("intent" as const) :
                   hp.bridge.bridge_angle === "value" ? ("credibility" as const) : ("curiosity" as const),
      hook_score: Math.max(1, Math.min(5, Math.round(hp.scores.overall * 5))),
    }));

    const responsePayload: any = {
      subject: emailData.subject,
      body: emailData.body,
      hookPacks,
      hookFacts,
      exaQueries: researchResult?.exaResearchId ? [researchResult.exaResearchId] : [],
      exaResults: researchResult?.citations.map((c) => ({ url: c.url, title: c.title, snippet: "" })) || [],
      selectedSources: researchResult?.citations.map((c) => c.url) || [],
      enforcementResults,
      validatorPassed: validation.valid,
      validatorErrors: validation.errors.length > 0 ? validation.errors : null,
      likeYouCount,
      wordCount,
      clicheCount,
      retryUsed: enforcementResults.did_retry,
    };

    // Debug info for test harness
    if (includeDebug) {
      responsePayload.debug = {
        trace,
        ...(researchResult && {
          senderIntentProfile: researchResult.senderIntentProfile,
          exaResearchId: researchResult.exaResearchId,
          exaResearchLatencyMs: researchResult.exaResearchLatencyMs,
          exaPartialResults: researchResult.exaPartialResults,
          identityDecision: researchResult.identityDecision,
          identityConfidence: researchResult.identityConfidence,
          citations: researchResult.citations,
          notes: researchResult.notes,
          // Exa debug fields
          exa_http_status: researchResult.exa_http_status,
          exa_response_bytes: researchResult.exa_response_bytes,
          exa_raw_keys: researchResult.exa_raw_keys,
          exa_parse_error: researchResult.exa_parse_error,
        }),
      };
    }

    return new Response(JSON.stringify(responsePayload), {
      status: 200,
      headers: responseHeaders,
    });
  } catch (error) {
    console.error("Unhandled error:", error);
    console.error("Error stack:", error instanceof Error ? error.stack : "No stack trace");
    console.error("Error message:", error instanceof Error ? error.message : String(error));

    const errorMessage = error instanceof Error ? error.message : String(error);
    return new Response(JSON.stringify({
      error: "Failed to generate email. Please try again.",
      details: errorMessage,
      type: error instanceof Error ? error.constructor.name : typeof error
    }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
</file>

<file path="supabase/functions/log-email-generation/index.ts">
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const PROMPT_VERSION = "v2.0-research";
const MODEL_NAME = "google/gemini-2.5-flash";

const SUPER_PROMPT = `You are an expert writing coach who crafts short, vivid, highly personalized cold emails.
Your job is to use the senders inputs AND any researched information about the recipient to write a warm, confident, memorable email that a busy, impressive person will actually read and respond to.

The email must be short, sharp, and readable in under 20 seconds (roughly 120150 words).

MANDATORY LOGIC (do this in order):

STEP 1  PARALLEL CHECK  
Determine whether a genuine parallel exists between:
- the senders lived experience, decision, or tension
- and something the recipient has built, navigated, argued, or led

A genuine parallel must be:
- situational (same type of challenge, transition, or tradeoff)
- specific (rooted in a real moment, project, or decision)
- non-obvious (not just same school, same company, same title)

STEP 2  LEXICAL REQUIREMENT  
IF a genuine parallel exists:
- You MUST include the exact lowercase phrase: **like you**
- It MUST appear exactly once in the email body
- It MUST be part of a sentence that explicitly draws the parallel
- It MUST sound natural and conversational

IF no genuine parallel exists:
- Do NOT include the phrase like you at all

STEP 3  VERIFICATION (do this silently before returning output)  
- If a genuine parallel exists AND the phrase like you does NOT appear exactly once  REWRITE the email
- If the phrase like you appears more than once  REWRITE the email
- If no genuine parallel exists AND like you appears  REWRITE the email

SIGNAL PRIORITY (pick ONE primary lane):
1. A one-in-a-million like you parallel (preferred when available)
2. Shared affiliation (school, company, program) if it meaningfully strengthens the connection
3. Senders standalone story or insight
4. Researched facts for grounding or context

CORE RULES:
- If researched facts are provided, use at most 12 SPECIFIC facts
- Use facts only as anchors for a parallel or question, never as praise or rsum summary
- If NO researched facts are provided, do NOT imply research was done
- Do NOT summarize the recipients career or list accomplishments
- Pick ONE lane and commit to it
- Be one in a million, not one of a million

STYLE RULES:
- Use vivid, concrete language
- Simple, human tone
- No em-dashes (), no semicolons, no ellipses
- No MBA or corporate clichs
- No generic praise or flattery
- No bracket placeholders
- End with Best, and nothing after

STRUCTURE:
- Subject line: short, specific, intriguing
- Greeting using the recipients first name
- 12 short paragraphs establishing the hook
  - If a parallel exists, the sentence containing like you should appear here
- One small, specific ask that is easy to say yes to
- Sign-off: Best,

DO NOT EVER:
- Invent private or sensitive information
- Imply research when none exists
- Overuse shared affiliation
- Stack multiple personalization angles
- Use the phrase like you more than once
- Explain the connection instead of demonstrating it
- Include a name after the sign-off`;

function countWords(text: string): number {
  return text
    .trim()
    .split(/\s+/)
    .filter((w) => w.length > 0).length;
}

function hasEmDash(text: string): boolean {
  return text.includes("") || text.includes("--");
}

function getAskTypeLabel(askType: string): string {
  const labels: Record<string, string> = {
    chat: "a short introductory chat",
    feedback: "feedback on something",
    referral: "a referral or introduction",
    job: "job or recruiting related discussion",
    other: "other",
  };
  return labels[askType] || askType;
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  const startTime = Date.now();

  try {
    const body = await req.json();
    const { sessionId, ...emailRequest } = body;

    // Validation
    if (!sessionId || typeof sessionId !== "string") {
      console.error("Validation failed: missing sessionId");
      return new Response(JSON.stringify({ error: "Session ID is required" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // New research-based inputs
    const recipientName = emailRequest.recipientName || "";
    const recipientCompany = emailRequest.recipientCompany || "";
    const recipientRole = emailRequest.recipientRole || "";
    const recipientLink = emailRequest.recipientLink || "";
    const askType = emailRequest.askType || "chat";
    const reachingOutBecause = emailRequest.reachingOutBecause || "";
    const credibilityStory = emailRequest.credibilityStory || "";

    if (!recipientName || !recipientCompany || !credibilityStory || !reachingOutBecause) {
      console.error("Validation failed: missing required email fields");
      return new Response(JSON.stringify({ error: "Missing required email fields" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    if (!recipientLink || !recipientLink.startsWith("http")) {
      return new Response(JSON.stringify({ error: "Please provide a valid public URL" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const inputJson = {
      recipientName,
      recipientCompany,
      recipientRole,
      recipientLink,
      askType,
      reachingOutBecause,
      credibilityStory,
    };

    const supabaseUrl = Deno.env.get("SUPABASE_URL");
    const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");

    if (!supabaseUrl || !supabaseServiceKey) {
      console.error("Missing Supabase configuration");
      return new Response(JSON.stringify({ error: "Server configuration error" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    if (!LOVABLE_API_KEY) {
      console.error("LOVABLE_API_KEY is not configured");
      return new Response(JSON.stringify({ error: "AI service not configured" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Verify session exists and check rate limiting
    const { data: session, error: sessionError } = await supabase
      .from("prolific_sessions")
      .select("id, completed_at")
      .eq("id", sessionId)
      .maybeSingle();

    if (sessionError || !session) {
      console.error("Session not found:", sessionId);
      return new Response(JSON.stringify({ error: "Invalid session" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Reject if session is already completed
    if (session.completed_at) {
      console.error("Session already completed:", sessionId);
      return new Response(JSON.stringify({ error: "Session has already been completed" }), {
        status: 403,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Rate limiting: check number of generations for this session (max 10 per session)
    const { count: generationCount } = await supabase
      .from("email_generations")
      .select("id", { count: "exact", head: true })
      .eq("session_id", sessionId);

    if (generationCount && generationCount >= 10) {
      console.error("Rate limit exceeded for session:", sessionId);
      return new Response(JSON.stringify({ error: "Maximum email generations reached for this session" }), {
        status: 429,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    // Step 1: Research the recipient
    console.log("Step 1: Researching recipient from:", recipientLink);

    const researchPrompt = `I need to write a cold email to ${recipientName}, who is ${recipientRole} at ${recipientCompany}.

Public link to start from (may or may not be accessible):
${recipientLink}

SENDERS INTENT (use this to decide what is relevant):
- Why the sender is reaching out: ${reachingOutBecause}
- What they are asking for: ${getAskTypeLabel(askType)}
- Senders credibility or lived experience: ${credibilityStory}

TASK:
Extract 03 VERIFIABLE, NON-OBVIOUS hook facts that would make THIS outreach feel specific, intentional, and well-targeted.

A hook fact MUST satisfy BOTH:
- It is supported by a real, public URL
- It directly supports or deepens the senders reason for reaching out

Good hook facts are typically:
1) A specific idea, argument, or opinion the recipient has publicly expressed (article, post, talk)
2) A concrete project, initiative, or decision they led, with a clear angle (what problem it addressed or why it mattered)
3) A talk, interview, essay, or artifact with a notable takeaway
4) A non-obvious detail that creates a natural bridge to the senders story or question

AVOID returning generic biographical facts unless no hook facts exist:
- Job titles, tenure, or career timelines (joined X in 2023, previously at Y)
- Founding facts or leadership roles without a specific angle or takeaway
- Portfolio lists, awards, or accomplishments that do not connect to the senders intent

CRITICAL RULES:
1) Every fact MUST include a real, verifiable source_url
2) NEVER fabricate, guess, or approximate URLs
3) If you cannot find clearly relevant hook facts, return an EMPTY facts array
4) Prefer returning zero facts over returning generic or rsum-style information

Return ONLY this JSON format:
{
  "facts": [
    {
      "claim": "One specific, verifiable hook fact (not a generic bio line)",
      "source_url": "Exact URL where this was found",
      "why_relevant": "Brief explanation of how this fact supports the senders outreach intent"
    }
  ],
  "summary": "One sentence professional summary ONLY if directly supported by the returned sources; otherwise empty string"
}
The facts array may be empty [] if no verifiable facts are found. This is preferred over fabricating information.
Do not invent or assume private details. Do not fabricate source URLs.`;

    const researchResponse = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: MODEL_NAME,
        messages: [
          {
            role: "system",
            content:
              "You are a research assistant. Extract specific, factual information about people from public sources. Be accurate and do not invent information.",
          },
          { role: "user", content: researchPrompt },
        ],
      }),
    });

    let researchedFacts: Array<{ claim: string; source_url: string }> = [];
    let recipientSummary = "";

    if (researchResponse.ok) {
      const researchData = await researchResponse.json();
      const researchContent = researchData.choices[0].message.content;
      console.log("Research response:", researchContent);

      try {
        const cleanedResearch = researchContent.replace(/```json\n?|\n?```/g, "").trim();
        const parsed = JSON.parse(cleanedResearch);
        // Handle both old format (string[]) and new format ({claim, source_url}[])
        if (Array.isArray(parsed.facts)) {
          researchedFacts = parsed.facts.filter((f: any) => typeof f === "object" && f.claim && f.source_url);
        }
        recipientSummary = parsed.summary || "";
        console.log("Extracted facts:", researchedFacts);
      } catch (e) {
        console.log("Could not parse research response, continuing without specific facts");
      }
    } else {
      console.log("Research step failed, continuing with basic info");
    }

    // Step 2: Generate the email
    console.log("Step 2: Generating email for session:", sessionId);

    const factsForPrompt =
      researchedFacts.length > 0
        ? `- Researched facts (USE these to personalize):\n  ${researchedFacts.map((f, i) => `${i + 1}. ${f.claim} (source: ${f.source_url})`).join("\n  ")}`
        : "- Researched facts: NONE AVAILABLE";

    const userPrompt = `Generate a cold email with these details:

RECIPIENT:
- Name: ${recipientName}
- Role: ${recipientRole} at ${recipientCompany}
- Public profile: ${recipientLink}
${recipientSummary ? `- Summary: ${recipientSummary}` : ""}
${factsForPrompt}

SENDER'S CONTEXT:
- Asking for: ${getAskTypeLabel(askType)}
- Reason for reaching out: ${reachingOutBecause}
- Credibility story: ${credibilityStory}


INSTRUCTIONS:
${
  researchedFacts.length > 0
    ? `- Use 1-2 of the researched facts naturally in the email to show personalization`
    : `- NO researched facts are available. Do NOT imply you've researched the recipient or reference specific details about their work. Instead, connect through the sender's story and the recipient's role/company only.`
}
- Lead with the sender's credibility story as the hook
- Make a specific ask related to "${getAskTypeLabel(askType)}"
- Keep it around 120-150 words
- Address ${recipientName.split(" ")[0]} by their first name

Return your response in this exact JSON format:
{
  "subject": "Your subject line here",
  "body": "Your full email body here with proper line breaks"
}

Only return the JSON, no other text.`;

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: MODEL_NAME,
        messages: [
          { role: "system", content: SUPER_PROMPT },
          { role: "user", content: userPrompt },
        ],
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error("Lovable AI error:", response.status, errorText);

      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "Rate limit exceeded. Please try again in a moment." }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "AI credits exhausted." }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }

      return new Response(JSON.stringify({ error: "Failed to generate email" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const data = await response.json();
    const content = data.choices[0].message.content;

    let emailData;
    try {
      const cleanedContent = content.replace(/```json\n?|\n?```/g, "").trim();
      emailData = JSON.parse(cleanedContent);
    } catch (parseError) {
      console.error("Failed to parse AI response:", parseError);
      return new Response(JSON.stringify({ error: "Failed to generate email" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const latencyMs = Date.now() - startTime;

    // Log generation to database
    const { data: generation, error: insertError } = await supabase
      .from("email_generations")
      .insert({
        session_id: sessionId,
        source: "prolific",
        input_json: { ...inputJson, researchedFacts },
        prompt_version: PROMPT_VERSION,
        model_name: MODEL_NAME,
        subject: emailData.subject,
        body: emailData.body,
        word_count: countWords(emailData.body),
        has_em_dash: hasEmDash(emailData.body),
        latency_ms: latencyMs,
      })
      .select("id")
      .single();

    if (insertError) {
      console.error("Failed to log generation:", insertError);
    } else {
      console.log("Generation logged:", generation.id);
    }

    return new Response(
      JSON.stringify({
        subject: emailData.subject,
        body: emailData.body,
        generationId: generation?.id,
        researchedFacts,
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } },
    );
  } catch (error) {
    console.error("Error in log-email-generation:", error);
    return new Response(JSON.stringify({ error: "An unexpected error occurred" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
</file>

<file path="supabase/functions/research/index.ts">
// POST /research - Create a new research job
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface ResearchRequest {
  recipientName: string;
  recipientCompany: string;
  recipientRole?: string;
  senderIntent?: string;
  credibilityStory?: string;
}

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    // Parse request body
    const body: ResearchRequest = await req.json();
    const { recipientName, recipientCompany, recipientRole, senderIntent, credibilityStory } = body;

    // Validate required fields
    if (!recipientName || !recipientCompany) {
      return new Response(
        JSON.stringify({
          error: 'Missing required fields: recipientName and recipientCompany are required'
        }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    console.log(`[POST /research] Creating job for ${recipientName} at ${recipientCompany}`);

    // Create Supabase client
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? ''
    );

    // Create research job
    const { data, error } = await supabaseClient
      .from('research_jobs')
      .insert({
        status: 'queued',
        recipient_name: recipientName,
        recipient_company: recipientCompany,
        recipient_role: recipientRole ?? null,
        sender_intent: senderIntent ?? null,
        credibility_story: credibilityStory ?? null,
        progress: {},
        urls: [],
        hooks: [],
        partial: false,
        fallback_mode: 'failed'
      })
      .select('id')
      .single();

    if (error) {
      console.error('[POST /research] Database error:', error);
      return new Response(
        JSON.stringify({ error: 'Failed to create research job', details: error.message }),
        {
          status: 500,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    const requestId = data.id;
    console.log(`[POST /research] Created job ${requestId}`);

    // Trigger the worker (non-blocking)
    // Note: In production, this should be handled by a queue or cron job
    // For now, we'll make a fire-and-forget request to the worker
    const workerUrl = `${Deno.env.get('SUPABASE_URL')}/functions/v1/research-run`;
    fetch(workerUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${Deno.env.get('SUPABASE_ANON_KEY')}`
      },
      body: JSON.stringify({ requestId })
    }).catch(err => {
      console.error('[POST /research] Failed to trigger worker:', err);
    });

    return new Response(
      JSON.stringify({ requestId }),
      {
        status: 200,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('[POST /research] Error:', error);
    return new Response(
      JSON.stringify({
        error: 'Internal server error',
        details: error instanceof Error ? error.message : String(error)
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  }
});
</file>

<file path="supabase/functions/research-run/index.ts">
// POST /research-run - Background worker to execute 4-phase research
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";
import {
  verifyIdentity,
  discoverContent,
  fetchContent,
  extractHooks,
  type IdentityResult,
  type ContentDiscoveryResult,
  type ContentFetchResult,
  type HookExtractionResult
} from "../shared/exa-search.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface WorkerRequest {
  requestId: string;
}

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const body: WorkerRequest = await req.json();
    const { requestId } = body;

    if (!requestId) {
      return new Response(
        JSON.stringify({ error: 'Missing requestId' }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    console.log(`[research-run] Starting worker for ${requestId}`);

    // Get API keys from environment
    const exaApiKey = Deno.env.get('EXA_API_KEY');
    const geminiApiKey = Deno.env.get('GEMINI_API_KEY');

    if (!exaApiKey || !geminiApiKey) {
      console.error('[research-run] Missing API keys');
      return new Response(
        JSON.stringify({ error: 'Server configuration error: Missing API keys' }),
        {
          status: 500,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // Create Supabase client with service role for worker operations
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    );

    // Fetch the job
    const { data: job, error: fetchError } = await supabaseClient
      .from('research_jobs')
      .select('*')
      .eq('id', requestId)
      .single();

    if (fetchError || !job) {
      console.error('[research-run] Job not found:', fetchError);
      return new Response(
        JSON.stringify({ error: 'Job not found' }),
        {
          status: 404,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    const name = job.recipient_name ?? '';
    const company = job.recipient_company ?? '';
    const role = job.recipient_role ?? undefined;
    const senderIntent = job.sender_intent ?? undefined;
    const credibilityStory = job.credibility_story ?? undefined;

    // Helper function to update job status
    async function updateJob(updates: any) {
      const { error } = await supabaseClient
        .from('research_jobs')
        .update(updates)
        .eq('id', requestId);

      if (error) {
        console.error('[research-run] Failed to update job:', error);
      }
    }

    try {
      // ==================== PHASE 1: Identity Verification ====================
      console.log(`[research-run] Phase 1: Identity verification for ${name}`);
      await updateJob({
        status: 'identity',
        progress: { phase: 1, total: 4, label: 'Verifying identity' }
      });

      const identityResult: IdentityResult = await verifyIdentity({
        name,
        company,
        role,
        exaApiKey
      });

      console.log(`[research-run] Identity result: ${identityResult.identityDecision} (confidence: ${identityResult.confidence})`);

      // If identity fails, stop early
      if (identityResult.identityDecision === 'FAIL') {
        await updateJob({
          status: 'failed',
          error: `Could not verify identity for ${name} at ${company}`,
          progress: { phase: 1, total: 4, label: 'Identity verification failed' },
          partial: false,
          fallback_mode: 'failed'
        });

        return new Response(
          JSON.stringify({ success: false, error: 'Identity verification failed' }),
          {
            status: 200,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
          }
        );
      }

      // ==================== PHASE 2: Content Discovery ====================
      console.log(`[research-run] Phase 2: Content discovery`);
      await updateJob({
        status: 'discovery',
        progress: { phase: 2, total: 4, label: 'Discovering content sources' }
      });

      const discoveryResult: ContentDiscoveryResult = await discoverContent({
        name,
        company,
        role,
        senderIntent,
        credibilityStory,
        exaApiKey,
        geminiApiKey
      });

      console.log(`[research-run] Discovered ${discoveryResult.foundCount} sources`);

      // Update with URLs found
      await updateJob({
        urls: discoveryResult.urls
      });

      // If no URLs found, fail early
      if (discoveryResult.urls.length === 0) {
        await updateJob({
          status: 'failed',
          error: `No content sources found for ${name}`,
          progress: { phase: 2, total: 4, label: 'No sources found' },
          partial: false,
          fallback_mode: 'failed'
        });

        return new Response(
          JSON.stringify({ success: false, error: 'No content sources found' }),
          {
            status: 200,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
          }
        );
      }

      // ==================== PHASE 3: Content Fetching ====================
      console.log(`[research-run] Phase 3: Fetching content from ${discoveryResult.urls.length} URLs`);
      await updateJob({
        status: 'fetching',
        progress: { phase: 3, total: 4, label: 'Fetching full content' }
      });

      const fetchResult: ContentFetchResult = await fetchContent({
        urls: discoveryResult.urls,
        exaApiKey,
        senderIntent
      });

      console.log(`[research-run] Fetched ${fetchResult.fetchedCount} documents`);

      // If no content fetched, fail
      if (fetchResult.docs.length === 0) {
        await updateJob({
          status: 'failed',
          error: `Could not fetch content for ${name}`,
          progress: { phase: 3, total: 4, label: 'Content fetch failed' },
          partial: true, // We have URLs but no content
          fallback_mode: 'failed'
        });

        return new Response(
          JSON.stringify({ success: false, error: 'Content fetch failed' }),
          {
            status: 200,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
          }
        );
      }

      // ==================== PHASE 4: Hook Extraction ====================
      console.log(`[research-run] Phase 4: Extracting hooks from ${fetchResult.docs.length} documents`);
      await updateJob({
        status: 'extracting',
        progress: { phase: 4, total: 4, label: 'Extracting personalization hooks' }
      });

      const hookResult: HookExtractionResult = await extractHooks({
        docs: fetchResult.docs,
        name,
        company,
        senderIntent,
        geminiApiKey
      });

      console.log(`[research-run] Extracted ${hookResult.hooks.length} hooks (fallback_mode: ${hookResult.fallback_mode})`);

      // Determine if we have partial results
      const isPartial = hookResult.fallback_mode === 'minimal' || hookResult.fallback_mode === 'failed';

      // Mark as complete
      await updateJob({
        status: 'complete',
        hooks: hookResult.hooks,
        partial: isPartial,
        fallback_mode: hookResult.fallback_mode,
        progress: { phase: 4, total: 4, label: 'Complete' }
      });

      console.log(`[research-run] Worker completed for ${requestId}`);

      return new Response(
        JSON.stringify({ success: true, requestId, hookCount: hookResult.hooks.length }),
        {
          status: 200,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );

    } catch (phaseError) {
      // Handle errors during any phase
      console.error('[research-run] Phase error:', phaseError);

      await updateJob({
        status: 'failed',
        error: phaseError instanceof Error ? phaseError.message : String(phaseError),
        partial: true
      });

      return new Response(
        JSON.stringify({
          success: false,
          error: 'Worker failed during execution',
          details: phaseError instanceof Error ? phaseError.message : String(phaseError)
        }),
        {
          status: 200,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

  } catch (error) {
    console.error('[research-run] Error:', error);
    return new Response(
      JSON.stringify({
        error: 'Internal server error',
        details: error instanceof Error ? error.message : String(error)
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  }
});
</file>

<file path="supabase/functions/research-status/index.ts">
// GET /research-status - Poll research job status
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.3";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// Map internal status to user-friendly phase labels
const PHASE_LABELS: Record<string, string> = {
  'queued': 'Starting research...',
  'identity': 'Confirming identity',
  'discovery': 'Discovering content sources',
  'fetching': 'Fetching full content',
  'extracting': 'Extracting personalization hooks',
  'complete': 'Research complete',
  'failed': 'Research failed'
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    // Parse requestId from query params
    const url = new URL(req.url);
    const requestId = url.searchParams.get('requestId');

    if (!requestId) {
      return new Response(
        JSON.stringify({ error: 'Missing requestId parameter' }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    console.log(`[GET /research-status] Checking status for ${requestId}`);

    // Create Supabase client
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? ''
    );

    // Fetch research job
    const { data, error } = await supabaseClient
      .from('research_jobs')
      .select('*')
      .eq('id', requestId)
      .single();

    if (error || !data) {
      console.error('[GET /research-status] Not found:', error);
      return new Response(
        JSON.stringify({ error: 'Research job not found' }),
        {
          status: 404,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // Extract counts from arrays
    const urlCount = Array.isArray(data.urls) ? data.urls.length : 0;
    const hookCount = Array.isArray(data.hooks) ? data.hooks.length : 0;

    // Build response with all requested fields
    const response = {
      requestId: data.id,
      status: data.status,
      phaseLabel: PHASE_LABELS[data.status] || data.status,
      progress: data.progress || {},
      counts: {
        urls: urlCount,
        hooks: hookCount
      },
      urls: data.urls || [],
      hooks: data.hooks || [],
      partial: data.partial || false,
      fallback_mode: data.fallback_mode || 'failed',
      error: data.error || null,
      created_at: data.created_at,
      updated_at: data.updated_at
    };

    console.log(`[GET /research-status] ${requestId}: ${data.status} (${hookCount} hooks, ${urlCount} urls)`);

    return new Response(
      JSON.stringify(response),
      {
        status: 200,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('[GET /research-status] Error:', error);
    return new Response(
      JSON.stringify({
        error: 'Internal server error',
        details: error instanceof Error ? error.message : String(error)
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  }
});
</file>

<file path="supabase/functions/shared/exa-search.ts">
// Exa Search + Contents API implementation for phased research

export interface IdentityResult {
  identityDecision: 'PASS' | 'FAIL';
  confidence: number;
  results: Array<{ url: string; title: string; snippet?: string }>;
}

export interface ContentDiscoveryResult {
  urls: Array<{ id: string; url: string; title: string; score: number }>;
  foundCount: number;
}

export interface FetchedDocument {
  url: string;
  title: string;
  text: string;
  highlights?: string[];
}

export interface ContentFetchResult {
  docs: FetchedDocument[];
  fetchedCount: number;
}

export interface HookPack {
  id: string;
  title: string;
  hook: string;
  whyItWorks: string;
  confidence: number;
  sources: Array<{ label: string; url: string }>;
}

export interface HookExtractionResult {
  hooks: HookPack[];
  fallback_mode: 'sufficient' | 'minimal' | 'failed';
}

// Phase 1: Identity Verification
export async function verifyIdentity(params: {
  name: string;
  company: string;
  role?: string;
  exaApiKey: string;
}): Promise<IdentityResult> {
  const { name, company, role, exaApiKey } = params;

  const query = `${name} ${company} ${role ?? ''}`.trim();
  console.log(`[verifyIdentity] Query: "${query}"`);

  try {
    const response = await fetch('https://api.exa.ai/search', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${exaApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        query,
        numResults: 3,
        type: 'neural',
        useAutoprompt: true,
        contents: {
          text: { maxCharacters: 500 }
        }
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`[verifyIdentity] API error: ${response.status} ${errorText}`);
      return {
        identityDecision: 'FAIL',
        confidence: 0,
        results: []
      };
    }

    const data = await response.json();
    const results = (data.results ?? []).map((r: any) => ({
      url: r.url ?? '',
      title: r.title ?? '',
      snippet: r.text ?? ''
    }));

    console.log(`[verifyIdentity] Found ${results.length} results`);

    // Check if at least one result mentions the company or person
    const hasMatch = results.some((r: any) => {
      const combined = `${r.title} ${r.snippet}`.toLowerCase();
      return combined.includes(company.toLowerCase()) || combined.includes(name.toLowerCase());
    });

    return {
      identityDecision: hasMatch ? 'PASS' : 'FAIL',
      confidence: hasMatch ? 0.75 : 0.25,
      results
    };
  } catch (error) {
    console.error(`[verifyIdentity] Error:`, error);
    return {
      identityDecision: 'FAIL',
      confidence: 0,
      results: []
    };
  }
}

// Phase 1.5: Generate Search Hypotheses with Gemini
async function generateSearchHypotheses(params: {
  name: string;
  company: string;
  role?: string;
  senderIntent?: string;
  credibilityStory?: string;
  geminiApiKey: string;
}): Promise<string[]> {
  const { name, company, role, senderIntent, credibilityStory, geminiApiKey } = params;

  if (!senderIntent || !credibilityStory) {
    // Fall back to basic searches if we don't have the context
    return [
      `${name} ${company} ${role ?? ''} projects background`,
      `${name} ${company} recent work`,
      `${name} ${company} interview podcast article`
    ];
  }

  const prompt = `You are helping craft targeted research queries for a cold email to ${name} at ${company}${role ? ` (${role})` : ''}.

SENDER'S INTENT:
${senderIntent}

SENDER'S CREDIBILITY STORY:
${credibilityStory}

TASK: Generate 3 specific search hypotheses about what aspects of ${name}'s work would be most relevant to the sender's intent.

Think about:
1. What shared interests, challenges, or domains exist between sender and recipient?
2. What specific projects, initiatives, or topics has ${name} likely worked on that align with the sender's intent?
3. What unique angles could create a strong connection?

Return ONLY a JSON array of 3 search query strings (no explanations):
["search query 1", "search query 2", "search query 3"]

Each query should combine ${name}'s name, company, and a specific topic/hypothesis.

Example format:
["Jane Smith Stripe building payment infrastructure emerging markets", "Jane Smith Stripe scaling fintech teams", "Jane Smith engineering leadership financial inclusion"]`;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: prompt }]
          }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 512,
          }
        })
      }
    );

    if (!response.ok) {
      console.error(`[generateSearchHypotheses] Gemini error: ${response.status}`);
      return [
        `${name} ${company} ${role ?? ''} projects`,
        `${name} ${company} recent work`,
        `${name} ${company} leadership`
      ];
    }

    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text ?? '';

    // Extract JSON array from response
    const jsonMatch = text.match(/\[[\s\S]*?\]/);
    if (!jsonMatch) {
      console.error(`[generateSearchHypotheses] No JSON array found`);
      return [
        `${name} ${company} ${role ?? ''} projects`,
        `${name} ${company} recent work`,
        `${name} ${company} leadership`
      ];
    }

    const hypotheses = JSON.parse(jsonMatch[0]);

    if (!Array.isArray(hypotheses) || hypotheses.length === 0) {
      console.error(`[generateSearchHypotheses] Invalid hypotheses format`);
      return [
        `${name} ${company} ${role ?? ''} projects`,
        `${name} ${company} recent work`,
        `${name} ${company} leadership`
      ];
    }

    console.log(`[generateSearchHypotheses] Generated ${hypotheses.length} hypotheses:`, hypotheses);
    return hypotheses.slice(0, 3);

  } catch (error) {
    console.error(`[generateSearchHypotheses] Error:`, error);
    return [
      `${name} ${company} ${role ?? ''} projects`,
      `${name} ${company} recent work`,
      `${name} ${company} leadership`
    ];
  }
}

// Phase 2: Content Discovery
export async function discoverContent(params: {
  name: string;
  company: string;
  role?: string;
  senderIntent?: string;
  credibilityStory?: string;
  exaApiKey: string;
  geminiApiKey: string;
}): Promise<ContentDiscoveryResult> {
  const { name, company, role, senderIntent, credibilityStory, exaApiKey, geminiApiKey } = params;

  console.log(`[discoverContent] Starting discovery for ${name} at ${company}`);

  // Generate smart search hypotheses using Gemini
  const hypotheses = await generateSearchHypotheses({
    name,
    company,
    role,
    senderIntent,
    credibilityStory,
    geminiApiKey
  });

  const searches = hypotheses.map((query, i) => ({
    query,
    label: `hypothesis_${i + 1}`
  }));

  try {
    const searchPromises = searches.map(async (search) => {
      const response = await fetch('https://api.exa.ai/search', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${exaApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query: search.query,
          numResults: 5,
          type: 'neural',
          useAutoprompt: true
        })
      });

      if (!response.ok) {
        console.error(`[discoverContent] ${search.label} search failed: ${response.status}`);
        return [];
      }

      const data = await response.json();
      return (data.results ?? []).map((r: any) => ({
        id: r.id ?? r.url,
        url: r.url ?? '',
        title: r.title ?? '',
        score: r.score ?? 0,
        source: search.label
      }));
    });

    const allResults = await Promise.all(searchPromises);
    const flatResults = allResults.flat();

    console.log(`[discoverContent] Found ${flatResults.length} total results`);

    // Deduplicate by URL
    const urlMap = new Map<string, any>();
    flatResults.forEach(result => {
      if (result.url && !urlMap.has(result.url)) {
        urlMap.set(result.url, result);
      }
    });

    const uniqueResults = Array.from(urlMap.values());

    // Sort by score and take top 5-8
    const topResults = uniqueResults
      .sort((a, b) => (b.score ?? 0) - (a.score ?? 0))
      .slice(0, 8);

    return {
      urls: topResults,
      foundCount: uniqueResults.length
    };
  } catch (error) {
    console.error(`[discoverContent] Error:`, error);
    return {
      urls: [],
      foundCount: 0
    };
  }
}

// Phase 3: Content Fetching
export async function fetchContent(params: {
  urls: Array<{ id: string; url: string; title: string }>;
  exaApiKey: string;
  senderIntent?: string;
}): Promise<ContentFetchResult> {
  const { urls, exaApiKey, senderIntent } = params;

  if (!urls || urls.length === 0) {
    return { docs: [], fetchedCount: 0 };
  }

  console.log(`[fetchContent] Fetching ${urls.length} URLs`);

  const ids = urls.map(u => u.id).filter(Boolean);

  if (ids.length === 0) {
    return { docs: [], fetchedCount: 0 };
  }

  try {
    const response = await fetch('https://api.exa.ai/contents', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${exaApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ids,
        text: {
          maxCharacters: 5000,
          includeHtmlTags: false
        },
        ...(senderIntent ? {
          highlights: {
            query: senderIntent,
            numSentences: 3,
            highlightsPerUrl: 3
          }
        } : {})
      })
    });

    if (!response.ok) {
      console.error(`[fetchContent] API error: ${response.status}`);
      return { docs: [], fetchedCount: 0 };
    }

    const data = await response.json();
    const results = data.results ?? [];

    const docs: FetchedDocument[] = results.map((r: any) => ({
      url: r.url ?? '',
      title: r.title ?? '',
      text: r.text ?? '',
      highlights: r.highlights ?? []
    })).filter((d: FetchedDocument) => d.text && d.text.length > 100);

    console.log(`[fetchContent] Successfully fetched ${docs.length} documents`);

    return {
      docs,
      fetchedCount: docs.length
    };
  } catch (error) {
    console.error(`[fetchContent] Error:`, error);
    return { docs: [], fetchedCount: 0 };
  }
}

// Phase 4: Hook Extraction with Gemini
export async function extractHooks(params: {
  docs: FetchedDocument[];
  name: string;
  company: string;
  senderIntent?: string;
  geminiApiKey: string;
}): Promise<HookExtractionResult> {
  const { docs, name, company, senderIntent, geminiApiKey } = params;

  if (!docs || docs.length === 0) {
    return {
      hooks: [],
      fallback_mode: 'failed'
    };
  }

  console.log(`[extractHooks] Analyzing ${docs.length} documents for ${name}`);

  // Build the prompt
  const contentSummary = docs.map((doc, i) =>
    `Source ${i + 1}: ${doc.title}\nURL: ${doc.url}\n${doc.highlights && doc.highlights.length > 0 ? 'Highlights:\n' + doc.highlights.join('\n') : doc.text.slice(0, 1000)}`
  ).join('\n\n---\n\n');

  const prompt = `You are extracting personalization hooks from research about ${name} at ${company}.

SENDER'S INTENT: ${senderIntent ?? 'Not specified - general networking'}

CONTENT SOURCES:
${contentSummary}

TASK: Extract 1-3 specific hooks that:
1. Reference a named project, quote, decision, or artifact
2. Are directly relevant to the sender's intent
3. Have verifiable evidence from the sources

For each hook, create:
- id: unique identifier (hook_1, hook_2, etc.)
- title: Short label (e.g., "Led Microsoft's AI Ethics Framework")
- hook: The specific fact or quote (1-2 sentences)
- whyItWorks: Why this connects to sender's intent (1 sentence)
- confidence: 0.0-1.0 score of how strong/relevant this hook is
- sources: Array of {label, url} from the content above

Return JSON only:
{
  "hooks": [
    {
      "id": "hook_1",
      "title": "...",
      "hook": "...",
      "whyItWorks": "...",
      "confidence": 0.85,
      "sources": [{"label": "Source 1", "url": "..."}]
    }
  ]
}`;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: prompt }]
          }],
          generationConfig: {
            temperature: 0.3,
            maxOutputTokens: 2048,
          }
        })
      }
    );

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`[extractHooks] Gemini API error: ${response.status} ${errorText}`);
      return {
        hooks: [],
        fallback_mode: 'failed'
      };
    }

    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text ?? '';

    // Extract JSON from response
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      console.error(`[extractHooks] No JSON found in response`);
      return {
        hooks: [],
        fallback_mode: 'failed'
      };
    }

    const parsed = JSON.parse(jsonMatch[0]);
    const hooks: HookPack[] = (parsed.hooks ?? []).slice(0, 3);

    console.log(`[extractHooks] Extracted ${hooks.length} hooks`);

    // Determine fallback mode
    const strongHooks = hooks.filter(h => (h.confidence ?? 0) >= 0.65);
    const decentHooks = hooks.filter(h => (h.confidence ?? 0) >= 0.5);

    let fallback_mode: 'sufficient' | 'minimal' | 'failed';
    if (strongHooks.length >= 2) {
      fallback_mode = 'sufficient';
    } else if (decentHooks.length >= 1) {
      fallback_mode = 'minimal';
    } else {
      fallback_mode = 'failed';
    }

    return {
      hooks,
      fallback_mode
    };
  } catch (error) {
    console.error(`[extractHooks] Error:`, error);
    return {
      hooks: [],
      fallback_mode: 'failed'
    };
  }
}
</file>

<file path="supabase/functions/submit-prolific-survey/index.ts">
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const body = await req.json();
    const { 
      sessionId,
      comparisonRating,
      likelihoodChange,
      likelihoodReasons,
      changesBeforeSending,
      whatFeltOff,
      mostUsefulPart,
      whatsMissing,
    } = body;

    // Validation
    if (!sessionId || typeof sessionId !== 'string') {
      console.error('Validation failed: missing sessionId');
      return new Response(
        JSON.stringify({ error: 'Session ID is required' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    if (comparisonRating !== undefined && (typeof comparisonRating !== 'number' || comparisonRating < 1 || comparisonRating > 5)) {
      console.error('Validation failed: invalid comparisonRating');
      return new Response(
        JSON.stringify({ error: 'Comparison rating must be between 1 and 5' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const validLikelihoodChanges = ['significantly_more', 'somewhat_more', 'no_change', 'less_likely'];
    if (likelihoodChange && !validLikelihoodChanges.includes(likelihoodChange)) {
      console.error('Validation failed: invalid likelihoodChange');
      return new Response(
        JSON.stringify({ error: 'Invalid likelihood change value' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const supabaseUrl = Deno.env.get('SUPABASE_URL');
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');

    if (!supabaseUrl || !supabaseServiceKey) {
      console.error('Missing Supabase configuration');
      return new Response(
        JSON.stringify({ error: 'Server configuration error' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Verify session exists and check if already completed
    const { data: session, error: sessionError } = await supabase
      .from('prolific_sessions')
      .select('id, completed_at')
      .eq('id', sessionId)
      .maybeSingle();

    if (sessionError || !session) {
      console.error('Session not found:', sessionId);
      return new Response(
        JSON.stringify({ error: 'Invalid session' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Prevent duplicate survey submissions
    if (session.completed_at) {
      console.error('Survey already submitted for session:', sessionId);
      return new Response(
        JSON.stringify({ error: 'Survey has already been submitted for this session' }),
        { status: 409, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    console.log('Submitting survey for session:', sessionId);

    // Insert survey response with new schema
    const { data: survey, error: insertError } = await supabase
      .from('prolific_post_survey')
      .insert({
        session_id: sessionId,
        comparison_rating: comparisonRating,
        likelihood_change: likelihoodChange,
        likelihood_reasons: likelihoodReasons || null,
        changes_before_sending: changesBeforeSending || null,
        what_felt_off: whatFeltOff?.substring(0, 5000) || null,
        most_useful_part: mostUsefulPart || null,
        whats_missing: whatsMissing?.substring(0, 5000) || null,
      })
      .select('id')
      .single();

    if (insertError) {
      console.error('Failed to insert survey:', insertError);
      return new Response(
        JSON.stringify({ error: 'Failed to submit survey' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Mark session as completed
    const { error: updateError } = await supabase
      .from('prolific_sessions')
      .update({ completed_at: new Date().toISOString() })
      .eq('id', sessionId);

    if (updateError) {
      console.error('Failed to mark session complete:', updateError);
    }

    console.log('Survey submitted:', survey.id);

    return new Response(
      JSON.stringify({ surveyId: survey.id, success: true }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error('Error in submit-prolific-survey:', error);
    return new Response(
      JSON.stringify({ error: 'An unexpected error occurred' }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
</file>

<file path="supabase/migrations/20251226181716_remix_migration_from_pg_dump.sql">
CREATE EXTENSION IF NOT EXISTS "pg_graphql" WITH SCHEMA "graphql";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements" WITH SCHEMA "extensions";
CREATE EXTENSION IF NOT EXISTS "pgcrypto" WITH SCHEMA "extensions";
CREATE EXTENSION IF NOT EXISTS "plpgsql" WITH SCHEMA "pg_catalog";
CREATE EXTENSION IF NOT EXISTS "supabase_vault" WITH SCHEMA "vault";
CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA "extensions";
BEGIN;

--
-- PostgreSQL database dump
--


-- Dumped from database version 17.6
-- Dumped by pg_dump version 18.1

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: public; Type: SCHEMA; Schema: -; Owner: -
--



SET default_table_access_method = heap;

--
-- Name: email_generations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_generations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    user_id uuid,
    source text DEFAULT 'app'::text NOT NULL,
    scenario_name text,
    input_json jsonb NOT NULL,
    prompt_version text NOT NULL,
    model_name text NOT NULL,
    subject text,
    body text NOT NULL,
    word_count integer,
    has_em_dash boolean,
    cliche_count integer,
    validator_passed boolean,
    validator_errors jsonb,
    latency_ms integer,
    session_id uuid
);


--
-- Name: prolific_post_survey; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.prolific_post_survey (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    session_id uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    comparison_rating integer,
    likelihood_change text,
    likelihood_reasons jsonb,
    changes_before_sending jsonb,
    what_felt_off text,
    most_useful_part text,
    whats_missing text,
    CONSTRAINT prolific_post_survey_comparison_rating_check CHECK (((comparison_rating >= 1) AND (comparison_rating <= 5))),
    CONSTRAINT prolific_post_survey_likelihood_change_check CHECK ((likelihood_change = ANY (ARRAY['significantly_more'::text, 'somewhat_more'::text, 'no_change'::text, 'less_likely'::text])))
);


--
-- Name: prolific_sessions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.prolific_sessions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    prolific_id text NOT NULL,
    profession text NOT NULL,
    cold_email_frequency text NOT NULL,
    completed_at timestamp with time zone,
    study_id text,
    prolific_session_id text
);


--
-- Name: prolific_step_tracking; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.prolific_step_tracking (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    session_id uuid,
    prolific_id text NOT NULL,
    step_name text NOT NULL,
    step_number integer NOT NULL,
    event_type text NOT NULL,
    event_data jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT prolific_step_tracking_event_type_check CHECK ((event_type = ANY (ARRAY['enter'::text, 'exit'::text, 'error'::text, 'action'::text])))
);


--
-- Name: email_generations email_generations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_generations
    ADD CONSTRAINT email_generations_pkey PRIMARY KEY (id);


--
-- Name: prolific_post_survey prolific_post_survey_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prolific_post_survey
    ADD CONSTRAINT prolific_post_survey_pkey PRIMARY KEY (id);


--
-- Name: prolific_sessions prolific_sessions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prolific_sessions
    ADD CONSTRAINT prolific_sessions_pkey PRIMARY KEY (id);


--
-- Name: prolific_step_tracking prolific_step_tracking_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prolific_step_tracking
    ADD CONSTRAINT prolific_step_tracking_pkey PRIMARY KEY (id);


--
-- Name: idx_email_generations_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_generations_created_at ON public.email_generations USING btree (created_at DESC);


--
-- Name: idx_email_generations_session_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_generations_session_id ON public.email_generations USING btree (session_id);


--
-- Name: idx_prolific_sessions_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_prolific_sessions_created_at ON public.prolific_sessions USING btree (created_at);


--
-- Name: idx_prolific_sessions_prolific_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_prolific_sessions_prolific_id ON public.prolific_sessions USING btree (prolific_id);


--
-- Name: idx_step_tracking_prolific; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_step_tracking_prolific ON public.prolific_step_tracking USING btree (prolific_id);


--
-- Name: idx_step_tracking_session; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_step_tracking_session ON public.prolific_step_tracking USING btree (session_id);


--
-- Name: idx_step_tracking_step; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_step_tracking_step ON public.prolific_step_tracking USING btree (step_name, event_type);


--
-- Name: email_generations email_generations_session_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_generations
    ADD CONSTRAINT email_generations_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.prolific_sessions(id) ON DELETE SET NULL;


--
-- Name: prolific_post_survey prolific_post_survey_session_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prolific_post_survey
    ADD CONSTRAINT prolific_post_survey_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.prolific_sessions(id);


--
-- Name: prolific_step_tracking prolific_step_tracking_session_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prolific_step_tracking
    ADD CONSTRAINT prolific_step_tracking_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.prolific_sessions(id);


--
-- Name: prolific_post_survey Allow public insert for survey responses; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public insert for survey responses" ON public.prolific_post_survey FOR INSERT WITH CHECK (true);


--
-- Name: prolific_post_survey Allow public select for survey responses; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public select for survey responses" ON public.prolific_post_survey FOR SELECT USING (true);


--
-- Name: email_generations No direct client access to email_generations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "No direct client access to email_generations" ON public.email_generations USING (false) WITH CHECK (false);


--
-- Name: prolific_sessions No direct client access to prolific_sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "No direct client access to prolific_sessions" ON public.prolific_sessions USING (false) WITH CHECK (false);


--
-- Name: prolific_step_tracking No direct client access to prolific_step_tracking; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "No direct client access to prolific_step_tracking" ON public.prolific_step_tracking AS RESTRICTIVE USING (false) WITH CHECK (false);


--
-- Name: email_generations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_generations ENABLE ROW LEVEL SECURITY;

--
-- Name: prolific_post_survey; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.prolific_post_survey ENABLE ROW LEVEL SECURITY;

--
-- Name: prolific_sessions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.prolific_sessions ENABLE ROW LEVEL SECURITY;

--
-- Name: prolific_step_tracking; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.prolific_step_tracking ENABLE ROW LEVEL SECURITY;

--
-- PostgreSQL database dump complete
--




COMMIT;
</file>

<file path="supabase/migrations/20251226183021_93830f70-1bfe-4da2-9005-67fab8ab0f2b.sql">
-- Add V2 research columns to email_generations table
ALTER TABLE public.email_generations
ADD COLUMN IF NOT EXISTS exa_queries jsonb DEFAULT NULL,
ADD COLUMN IF NOT EXISTS exa_results jsonb DEFAULT NULL,
ADD COLUMN IF NOT EXISTS selected_sources jsonb DEFAULT NULL,
ADD COLUMN IF NOT EXISTS researched_facts jsonb DEFAULT NULL,
ADD COLUMN IF NOT EXISTS enforcement_results jsonb DEFAULT NULL,
ADD COLUMN IF NOT EXISTS like_you_count integer DEFAULT NULL,
ADD COLUMN IF NOT EXISTS research_model_name text DEFAULT NULL;

-- Add a comment for documentation
COMMENT ON COLUMN public.email_generations.exa_queries IS 'Array of Exa search queries used';
COMMENT ON COLUMN public.email_generations.exa_results IS 'Array of {url, title, snippet} from Exa';
COMMENT ON COLUMN public.email_generations.selected_sources IS 'Array of URLs used for extraction';
COMMENT ON COLUMN public.email_generations.researched_facts IS 'Array of {claim, source_url, evidence_quote, why_relevant, bridge_type, hook_score}';
COMMENT ON COLUMN public.email_generations.enforcement_results IS '{did_retry: boolean, failures_first_pass: [], failures_retry: []}';
COMMENT ON COLUMN public.email_generations.like_you_count IS 'Count of "like you" occurrences in body';
COMMENT ON COLUMN public.email_generations.research_model_name IS 'Model used for research step';
</file>

<file path="supabase/migrations/20251228_add_email_generations_columns.sql">
-- Add missing columns to email_generations table

ALTER TABLE public.email_generations
ADD COLUMN IF NOT EXISTS research_model_name text,
ADD COLUMN IF NOT EXISTS like_you_count integer,
ADD COLUMN IF NOT EXISTS enforcement_results jsonb,
ADD COLUMN IF NOT EXISTS exa_queries jsonb,
ADD COLUMN IF NOT EXISTS exa_results jsonb,
ADD COLUMN IF NOT EXISTS selected_sources jsonb,
ADD COLUMN IF NOT EXISTS researched_facts jsonb;
</file>

<file path="supabase/migrations/20251229_add_credibility_story.sql">
-- Add credibility_story column to research_jobs table
ALTER TABLE public.research_jobs
ADD COLUMN IF NOT EXISTS credibility_story text;
</file>

<file path="supabase/migrations/20251229_create_research_jobs.sql">
-- Create research_jobs table for background research processing
CREATE TABLE IF NOT EXISTS public.research_jobs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  status text NOT NULL DEFAULT 'queued',
  recipient_name text,
  recipient_company text,
  recipient_role text,
  sender_intent text,
  progress jsonb NOT NULL DEFAULT '{}'::jsonb,
  urls jsonb NOT NULL DEFAULT '[]'::jsonb,
  hooks jsonb NOT NULL DEFAULT '[]'::jsonb,
  partial boolean NOT NULL DEFAULT false,
  fallback_mode text NOT NULL DEFAULT 'failed',
  error text,

  CONSTRAINT research_jobs_status_check
    CHECK (status IN ('queued', 'identity', 'discovery', 'fetching', 'extracting', 'complete', 'failed'))
);

-- Create indexes for common queries
CREATE INDEX IF NOT EXISTS research_jobs_created_at_idx ON public.research_jobs(created_at DESC);
CREATE INDEX IF NOT EXISTS research_jobs_status_idx ON public.research_jobs(status);
CREATE INDEX IF NOT EXISTS research_jobs_updated_at_idx ON public.research_jobs(updated_at DESC);

-- Enable RLS (Row Level Security)
ALTER TABLE public.research_jobs ENABLE ROW LEVEL SECURITY;

-- Allow anonymous read access (for polling status)
CREATE POLICY "Allow anonymous read access to research_jobs"
  ON public.research_jobs
  FOR SELECT
  TO anon
  USING (true);

-- Allow anonymous insert (for creating jobs)
CREATE POLICY "Allow anonymous insert to research_jobs"
  ON public.research_jobs
  FOR INSERT
  TO anon
  WITH CHECK (true);

-- Allow service role full access
CREATE POLICY "Allow service role full access to research_jobs"
  ON public.research_jobs
  FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);

-- Add function to auto-update updated_at timestamp
CREATE OR REPLACE FUNCTION public.update_research_jobs_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to auto-update updated_at
CREATE TRIGGER update_research_jobs_updated_at
  BEFORE UPDATE ON public.research_jobs
  FOR EACH ROW
  EXECUTE FUNCTION public.update_research_jobs_updated_at();
</file>

<file path="supabase/config.toml">
project_id = "hvmyfwqnjontmycmkhux"
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

# Supabase
supabase/.temp/
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.ts",
    "css": "src/index.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  }
}
</file>

<file path="eslint.config.js">
import js from "@eslint/js";
import globals from "globals";
import reactHooks from "eslint-plugin-react-hooks";
import reactRefresh from "eslint-plugin-react-refresh";
import tseslint from "typescript-eslint";

export default tseslint.config(
  { ignores: ["dist"] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ["**/*.{ts,tsx}"],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      "react-hooks": reactHooks,
      "react-refresh": reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      "react-refresh/only-export-components": ["warn", { allowConstantExport: true }],
      "@typescript-eslint/no-unused-vars": "off",
    },
  },
);
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MBA Cold Email Assistant | Craft Compelling Networking Emails</title>
    <meta name="description" content="Generate professional cold emails for MBA networking, recruiting, VC outreach, and more. AI-powered email templates tailored to your specific scenario." />
    <meta name="author" content="Lovable" />

    <meta property="og:title" content="MBA Cold Email Assistant" />
    <meta property="og:description" content="Craft compelling cold emails for networking, recruiting, and VC outreach." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@Lovable" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="package.json">
{
  "name": "vite_react_shadcn_ts",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "build:dev": "vite build --mode development",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@hookform/resolvers": "^3.10.0",
    "@radix-ui/react-accordion": "^1.2.11",
    "@radix-ui/react-alert-dialog": "^1.1.14",
    "@radix-ui/react-aspect-ratio": "^1.1.7",
    "@radix-ui/react-avatar": "^1.1.10",
    "@radix-ui/react-checkbox": "^1.3.2",
    "@radix-ui/react-collapsible": "^1.1.11",
    "@radix-ui/react-context-menu": "^2.2.15",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-dropdown-menu": "^2.1.15",
    "@radix-ui/react-hover-card": "^1.1.14",
    "@radix-ui/react-label": "^2.1.7",
    "@radix-ui/react-menubar": "^1.1.15",
    "@radix-ui/react-navigation-menu": "^1.2.13",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-progress": "^1.1.7",
    "@radix-ui/react-radio-group": "^1.3.7",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.5",
    "@radix-ui/react-separator": "^1.1.7",
    "@radix-ui/react-slider": "^1.3.5",
    "@radix-ui/react-slot": "^1.2.3",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-tabs": "^1.1.12",
    "@radix-ui/react-toast": "^1.2.14",
    "@radix-ui/react-toggle": "^1.1.9",
    "@radix-ui/react-toggle-group": "^1.1.10",
    "@radix-ui/react-tooltip": "^1.2.7",
    "@supabase/supabase-js": "^2.86.2",
    "@tanstack/react-query": "^5.83.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^3.6.0",
    "embla-carousel-react": "^8.6.0",
    "input-otp": "^1.4.2",
    "lucide-react": "^0.462.0",
    "next-themes": "^0.3.0",
    "react": "^18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.3.1",
    "react-hook-form": "^7.61.1",
    "react-resizable-panels": "^2.1.9",
    "react-router-dom": "^6.30.1",
    "recharts": "^2.15.4",
    "sonner": "^1.7.4",
    "tailwind-merge": "^2.6.0",
    "tailwindcss-animate": "^1.0.7",
    "vaul": "^0.9.9",
    "zod": "^3.25.76"
  },
  "devDependencies": {
    "@eslint/js": "^9.32.0",
    "@tailwindcss/typography": "^0.5.16",
    "@types/node": "^22.16.5",
    "@types/react": "^18.3.23",
    "@types/react-dom": "^18.3.7",
    "@vitejs/plugin-react-swc": "^3.11.0",
    "autoprefixer": "^10.4.21",
    "eslint": "^9.32.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.20",
    "globals": "^15.15.0",
    "lovable-tagger": "^1.1.11",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "typescript": "^5.8.3",
    "typescript-eslint": "^8.38.0",
    "vite": "^5.4.19"
  }
}
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="README.md">
# Welcome to your Lovable project

## Project info

**URL**: https://lovable.dev/projects/REPLACE_WITH_PROJECT_ID

## How can I edit this code?

There are several ways of editing your application.

**Use Lovable**

Simply visit the [Lovable Project](https://lovable.dev/projects/REPLACE_WITH_PROJECT_ID) and start prompting.

Changes made via Lovable will be committed automatically to this repo.

**Use your preferred IDE**

If you want to work locally using your own IDE, you can clone this repo and push changes. Pushed changes will also be reflected in Lovable.

The only requirement is having Node.js & npm installed - [install with nvm](https://github.com/nvm-sh/nvm#installing-and-updating)

Follow these steps:

```sh
# Step 1: Clone the repository using the project's Git URL.
git clone <YOUR_GIT_URL>

# Step 2: Navigate to the project directory.
cd <YOUR_PROJECT_NAME>

# Step 3: Install the necessary dependencies.
npm i

# Step 4: Start the development server with auto-reloading and an instant preview.
npm run dev
```

**Edit a file directly in GitHub**

- Navigate to the desired file(s).
- Click the "Edit" button (pencil icon) at the top right of the file view.
- Make your changes and commit the changes.

**Use GitHub Codespaces**

- Navigate to the main page of your repository.
- Click on the "Code" button (green button) near the top right.
- Select the "Codespaces" tab.
- Click on "New codespace" to launch a new Codespace environment.
- Edit files directly within the Codespace and commit and push your changes once you're done.

## What technologies are used for this project?

This project is built with:

- Vite
- TypeScript
- React
- shadcn-ui
- Tailwind CSS

## How can I deploy this project?

Simply open [Lovable](https://lovable.dev/projects/REPLACE_WITH_PROJECT_ID) and click on Share -> Publish.

## Can I connect a custom domain to my Lovable project?

Yes, you can!

To connect a domain, navigate to Project > Settings > Domains and click Connect Domain.

Read more here: [Setting up a custom domain](https://docs.lovable.dev/features/custom-domain#custom-domain)
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

export default {
  darkMode: ["class"],
  content: ["./pages/**/*.{ts,tsx}", "./components/**/*.{ts,tsx}", "./app/**/*.{ts,tsx}", "./src/**/*.{ts,tsx}"],
  prefix: "",
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      fontFamily: {
        sans: ["Source Serif 4", "Georgia", "serif"],
        serif: ["Playfair Display", "Georgia", "Times New Roman", "serif"],
        body: ["Source Serif 4", "Georgia", "serif"],
      },
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
        sidebar: {
          DEFAULT: "hsl(var(--sidebar-background))",
          foreground: "hsl(var(--sidebar-foreground))",
          primary: "hsl(var(--sidebar-primary))",
          "primary-foreground": "hsl(var(--sidebar-primary-foreground))",
          accent: "hsl(var(--sidebar-accent))",
          "accent-foreground": "hsl(var(--sidebar-accent-foreground))",
          border: "hsl(var(--sidebar-border))",
          ring: "hsl(var(--sidebar-ring))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
        "fade-in": {
          from: { opacity: "0" },
          to: { opacity: "1" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
        "fade-in": "fade-in 0.3s ease-out",
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
} satisfies Config;
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": false,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noImplicitAny": false,
    "noFallthroughCasesInSwitch": false,

    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [{ "path": "./tsconfig.app.json" }, { "path": "./tsconfig.node.json" }],
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "noImplicitAny": false,
    "noUnusedParameters": false,
    "skipLibCheck": true,
    "allowJs": true,
    "noUnusedLocals": false,
    "strictNullChecks": false
  }
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react-swc";
import path from "path";
import { componentTagger } from "lovable-tagger";

// https://vitejs.dev/config/
export default defineConfig(({ mode }) => ({
  server: {
    host: "::",
    port: 8080,
  },
  plugins: [react(), mode === "development" && componentTagger()].filter(Boolean),
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
}));
</file>

</files>
